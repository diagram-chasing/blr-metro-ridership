<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Aman Bhargava">
<meta name="author" content="Vivek Matthew">
<meta name="dcterms.date" content="2025-10-01">

<title>How Bangalore Uses The Metro</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-14c637fc131229e0651ecd5d58839070.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="index_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="index_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions"><span class="header-section-number">1.1</span> Questions</a></li>
  <li><a href="#dataset-overview" id="toc-dataset-overview" class="nav-link" data-scroll-target="#dataset-overview"><span class="header-section-number">1.2</span> Dataset Overview</a></li>
  </ul></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">2</span> Data Preparation</a></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis"><span class="header-section-number">3</span> Exploratory Data Analysis</a>
  <ul class="collapse">
  <li><a href="#days-and-hours" id="toc-days-and-hours" class="nav-link" data-scroll-target="#days-and-hours"><span class="header-section-number">3.1</span> Days and Hours</a></li>
  </ul></li>
  <li><a href="#daily-ridership-trends-over-time" id="toc-daily-ridership-trends-over-time" class="nav-link" data-scroll-target="#daily-ridership-trends-over-time"><span class="header-section-number">4</span> Daily Ridership Trends Over Time</a></li>
  <li><a href="#how-popular-is-your-route" id="toc-how-popular-is-your-route" class="nav-link" data-scroll-target="#how-popular-is-your-route"><span class="header-section-number">5</span> How Popular is Your Route?</a></li>
  <li><a href="#peak-hour-stations" id="toc-peak-hour-stations" class="nav-link" data-scroll-target="#peak-hour-stations"><span class="header-section-number">6</span> Peak Hour Stations</a></li>
  <li><a href="#station-activity" id="toc-station-activity" class="nav-link" data-scroll-target="#station-activity"><span class="header-section-number">7</span> Station Activity</a></li>
  <li><a href="#interchange-station-footfall" id="toc-interchange-station-footfall" class="nav-link" data-scroll-target="#interchange-station-footfall"><span class="header-section-number">8</span> Interchange Station Footfall</a></li>
  <li><a href="#the-yellow-line-effect" id="toc-the-yellow-line-effect" class="nav-link" data-scroll-target="#the-yellow-line-effect"><span class="header-section-number">9</span> The Yellow Line Effect</a></li>
  <li><a href="#station-pair-ridership-spikes" id="toc-station-pair-ridership-spikes" class="nav-link" data-scroll-target="#station-pair-ridership-spikes"><span class="header-section-number">10</span> Station Pair Ridership Spikes</a></li>
  <li><a href="#weekdays-vs-weekends---network" id="toc-weekdays-vs-weekends---network" class="nav-link" data-scroll-target="#weekdays-vs-weekends---network"><span class="header-section-number">11</span> Weekdays vs Weekends - Network</a></li>
  <li><a href="#weekdays-vs-weekends---stations-at-peak-hour" id="toc-weekdays-vs-weekends---stations-at-peak-hour" class="nav-link" data-scroll-target="#weekdays-vs-weekends---stations-at-peak-hour"><span class="header-section-number">12</span> Weekdays vs Weekends - Stations at Peak Hour</a></li>
  <li><a href="#weekdays-vs-weekends---stations-overall" id="toc-weekdays-vs-weekends---stations-overall" class="nav-link" data-scroll-target="#weekdays-vs-weekends---stations-overall"><span class="header-section-number">13</span> Weekdays vs Weekends - Stations Overall</a></li>
  <li><a href="#average-travel-distance" id="toc-average-travel-distance" class="nav-link" data-scroll-target="#average-travel-distance"><span class="header-section-number">14</span> Average Travel Distance</a></li>
  <li><a href="#land-use" id="toc-land-use" class="nav-link" data-scroll-target="#land-use"><span class="header-section-number">15</span> Land use</a></li>
  <li><a href="#network-analysis" id="toc-network-analysis" class="nav-link" data-scroll-target="#network-analysis"><span class="header-section-number">16</span> Network Analysis</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content"><div class="quarto-title-block"><div class="quarto-title-tools-only"><h1></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>

<div class="quarto-title-block">

      <img src="quarto-assets/logo.png" alt="Logo" style="height: 80px; margin-bottom: 1rem; margin-left: -0.5rem; margin-top: -2.5rem;">
  
  <h1 class="title" style="border-top: 1px black solid; padding-top: 1rem;">How Bangalore Uses The Metro</h1>

  
  <div class="quarto-title-authors">
        <div class="author"></div>
        <div class="author"></div>
      </div>
    <p class="date">October 1, 2025</p>
</div>


<style>
@import url('https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap');

body {
  font-family: 'Atkinson Hyperlegible', sans-serif;
  background-color: var(--color-sepia);
  color: var(--color-sepia-brown);
  line-height: 1.6;
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.highlight-box {
  background-color: #f8f9fa;
  border-left: 4px solid #007bff;
  padding: 1rem;
  margin: 1rem 0;
  border-radius: 0 4px 4px 0;
}
</style>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gganimate)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggraph)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggnewscale)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wesanderson)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidylo)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidygraph)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(exactextractr)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Global options</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">kable_styling_bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>))</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.width =</span> <span class="dv">12</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.height =</span> <span class="dv">8</span>,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.align =</span> <span class="st">"center"</span>,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">out.width =</span> <span class="st">"100%"</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">warning =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">message =</span> <span class="cn">FALSE</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Colors and Themes</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>wes_colors <span class="ot">&lt;-</span> <span class="fu">wes_palette</span>(<span class="st">"Darjeeling1"</span>, <span class="dv">8</span>, <span class="at">type =</span> <span class="st">"continuous"</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>primary_color <span class="ot">&lt;-</span> <span class="st">"#3182bd"</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>secondary_color <span class="ot">&lt;-</span> <span class="st">"#de77ae"</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>tertiary_color <span class="ot">&lt;-</span> <span class="st">"#2c7fb8"</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>theme_metro <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_family =</span> <span class="st">"sans"</span>) <span class="sc">+</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">20</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">8</span>)),</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>, <span class="at">color =</span> <span class="st">"gray40"</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">15</span>)),</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">color =</span> <span class="st">"gray20"</span>),</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"none"</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to add temporal features (DRY)</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>add_temporal_features <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">wday =</span> <span class="fu">wday</span>(Date, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">week_start =</span> <span class="dv">1</span>),</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">day_type =</span> <span class="fu">if_else</span>(wday <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sat"</span>, <span class="st">"Sun"</span>), <span class="st">"Weekend"</span>, <span class="st">"Weekday"</span>),</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">peak_category =</span> <span class="fu">case_when</span>(</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        day_type <span class="sc">==</span> <span class="st">"Weekday"</span> <span class="sc">&amp;</span> Hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>) <span class="sc">~</span> <span class="st">"Morning Peak"</span>,</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        day_type <span class="sc">==</span> <span class="st">"Weekday"</span> <span class="sc">&amp;</span> Hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">17</span>, <span class="dv">18</span>, <span class="dv">19</span>) <span class="sc">~</span> <span class="st">"Evening Peak"</span>,</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Off-Peak"</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and preprocess data</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>hourly <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="st">"data/station-hourly.csv"</span>, <span class="at">delim =</span> <span class="st">";"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_temporal_features</span>()</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>station_pair_hourly <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="st">"data/stationpair-hourly.csv"</span>, <span class="at">delim =</span> <span class="st">";"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">To_Station =</span> <span class="st">`</span><span class="at">Destination Station</span><span class="st">`</span>, <span class="at">From_Station =</span> <span class="st">`</span><span class="at">Origin Station</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.Date</span>(Date)) <span class="sc">%&gt;%</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_temporal_features</span>()</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>metro_geojson <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"data/metro.geojson"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>This analysis is based on ridership data obtained through a Right to Information (RTI) request to BMRCL. The RTI request sought basic ridership information between stations. However, BMRCL’s response provided <strong>station-pairwise hourly ridership between every station pair over 19 days</strong>! A treat.</p>
<p>The dataset contains over <strong>1.2 million rows</strong> of ridership data, covering a particularly interesting period that includes the opening of the new Yellow Line.</p>
<section id="questions" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="questions"><span class="header-section-number">1.1</span> Questions</h2>
<ol type="1">
<li>How popular is your specific daily commute compared to other routes?</li>
<li>Which stations experience the heaviest traffic during morning and evening rush hours?</li>
<li>How does ridership vary by day of the week, time of day?</li>
<li>What are the most popular travel corridors within the metro network?</li>
<li>Do certain stations show dramatically different usage patterns between weekdays and weekends?</li>
<li>How has the Yellow Line impacted ridership on existing stations in the metro network?</li>
<li>What is the length of an average commute, and how does it vary across stations?</li>
<li>Have their been particular instances of unusual spikes in traffic due to events in the city?</li>
</ol>
</section>
<section id="dataset-overview" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="dataset-overview"><span class="header-section-number">1.2</span> Dataset Overview</h2>
<p>Our analysis uses multiple data sources:</p>
<ul>
<li><strong>Station-level hourly ridership</strong>: Passenger counts by station and hour</li>
<li><strong>Station-pair hourly data</strong>: Origin-destination flows with temporal granularity</li>
<li>Spatial data from OpenStreetMap for mapping locations and additional metadata</li>
</ul>
<p>Let’s begin by examining the structure of our datasets:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>) <span class="co"># For reproducible sampling</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sample_ridership_data <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Ridership <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_n</span>(<span class="dv">15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Ridership)) <span class="sc">%&gt;%</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.character</span>(Date))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hourly) <span class="sc">%&gt;%</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Sample of Hourly Station Ridership Data"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small">
<caption>Sample of Hourly Station Ridership Data</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Date</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Hour</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Station</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Ridership</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">wday</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">day_type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">peak_category</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2025-08-01</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">Weekday</td>
<td style="text-align: left;">Off-Peak</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-08-01</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">Weekday</td>
<td style="text-align: left;">Off-Peak</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-08-01</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">Weekday</td>
<td style="text-align: left;">Off-Peak</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-08-01</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">Weekday</td>
<td style="text-align: left;">Off-Peak</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-08-01</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: right;">6</td>
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">Weekday</td>
<td style="text-align: left;">Off-Peak</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-08-01</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: right;">65</td>
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">Weekday</td>
<td style="text-align: left;">Off-Peak</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(station_pair_hourly) <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Sample of Hourly Station-Pair Ridership Data"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small">
<caption>Sample of Hourly Station-Pair Ridership Data</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Date</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Hour</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">From_Station</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">To_Station</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Ridership</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">wday</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">day_type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">peak_category</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2025-08-01</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">Magadi Road</td>
<td style="text-align: left;">Krantivira Sangolli Rayanna Railway Station</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">Weekday</td>
<td style="text-align: left;">Off-Peak</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-08-01</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">Weekday</td>
<td style="text-align: left;">Off-Peak</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-08-01</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: left;">Deepanjali Nagar</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">Weekday</td>
<td style="text-align: left;">Off-Peak</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-08-01</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: left;">Dr. B. R. Ambedkar Station, Vidhana Soudha</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">Weekday</td>
<td style="text-align: left;">Off-Peak</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2025-08-01</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: left;">Indiranagar</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">Weekday</td>
<td style="text-align: left;">Off-Peak</td>
</tr>
<tr class="even">
<td style="text-align: left;">2025-08-01</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: left;">Krantivira Sangolli Rayanna Railway Station</td>
<td style="text-align: right;">21</td>
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">Weekday</td>
<td style="text-align: left;">Off-Peak</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
</section>
<section id="data-preparation" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Data Preparation</h1>
<p>We need to classify each station by its metro line. Namma Metro currently operates three main lines:</p>
<ul>
<li><strong>Purple Line</strong>: The east-west corridor</li>
<li><strong>Green Line</strong>: The north-south corridor</li>
<li><strong>Yellow Line</strong>: The newest line serving south-eastern regions in the periphery</li>
</ul>
<!-- end list -->
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract station data from GeoJSON as the single source of truth</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>metro_stations <span class="ot">&lt;-</span> metro_geojson <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">st_geometry_type</span>(.) <span class="sc">==</span> <span class="st">"POINT"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">Station =</span> name, code, <span class="at">line =</span> colour) <span class="sc">%&gt;%</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(code),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">paste0</span>(<span class="fu">str_sub</span>(<span class="fu">str_to_upper</span>(<span class="fu">str_replace_all</span>(Station, <span class="st">"[^A-Za-z]"</span>, <span class="st">""</span>)), <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">sprintf</span>(<span class="st">"%02d"</span>, <span class="fu">row_number</span>())),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                   code)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(line, Station)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mapping from long/inconsistent names in CSV to short names in GeoJSON</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>manual_station_mapping <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>csv_name, <span class="sc">~</span>geojson_name,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Biocon Hebbagodi"</span>, <span class="st">"Hebbagodi"</span>,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Central Silk Board"</span>, <span class="st">"Silk Board"</span>,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Delta Electronics Bommasandra"</span>, <span class="st">"Bommasandra"</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Dr. B. R. Ambedkar Station, Vidhana Soudha"</span>, <span class="st">"Vidhana Soudha"</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Infosys Foundation Konappana Agrahara"</span>, <span class="st">"Konappana Agrahara"</span>,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Jaya Prakash Nagar"</span>, <span class="st">"JP Nagar"</span>,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Krantivira Sangolli Rayanna Railway Station"</span>, <span class="st">"KSR Railway Station"</span>,</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Krishna Rajendra Market"</span>, <span class="st">"KR Market"</span>,</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Krishnarajapura"</span>, <span class="st">"KR Pura"</span>,</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mahakavi Kuvempu Road"</span>, <span class="st">"MKK Road"</span>,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mahatma Gandhi Road"</span>, <span class="st">"MG Road"</span>,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mantri Square Sampige Road"</span>, <span class="st">"Mantri Square"</span>,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Nadaprabhu Kempegowda Station, Majestic"</span>, <span class="st">"Majestic"</span>,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pantharapalya - Nayandahalli"</span>, <span class="st">"Nayandahalli"</span>,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Rajarajeshwari Nagar"</span>, <span class="st">"RR Nagar"</span>,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Rashtreeya Vidyalaya Road"</span>, <span class="st">"RV Road"</span>,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sir M. Visvesvaraya Stn., Central College"</span>, <span class="st">"Central College"</span>,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sri Balagangadharanatha Swamiji Station, Hosahalli"</span>, <span class="st">"Hosahalli"</span>,</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Vijayanagar"</span>, <span class="st">"Vijayanagara"</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>all_csv_names <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(hourly<span class="sc">$</span>Station, station_pair_hourly<span class="sc">$</span>From_Station, station_pair_hourly<span class="sc">$</span>To_Station))</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>identity_mapping <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">csv_name =</span> <span class="fu">setdiff</span>(all_csv_names, manual_station_mapping<span class="sc">$</span>csv_name)) <span class="sc">%&gt;%</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">geojson_name =</span> csv_name)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>station_name_mapping <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(manual_station_mapping, identity_mapping)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper functions for name conversion</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>convert_to_short_names <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.data.frame</span>(data)) {</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    station_cols <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(data), <span class="fu">c</span>(<span class="st">"Station"</span>, <span class="st">"From_Station"</span>, <span class="st">"To_Station"</span>))</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (col <span class="cf">in</span> station_cols) {</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>      data[[col]] <span class="ot">&lt;-</span> station_name_mapping<span class="sc">$</span>geojson_name[<span class="fu">match</span>(data[[col]], station_name_mapping<span class="sc">$</span>csv_name)]</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">is.list</span>(data)) {</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">map</span>(data, convert_to_short_names)</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>get_short_name <span class="ot">&lt;-</span> <span class="cf">function</span>(station_name) {</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>  short_name <span class="ot">&lt;-</span> station_name_mapping<span class="sc">$</span>geojson_name[<span class="fu">match</span>(station_name, station_name_mapping<span class="sc">$</span>csv_name)]</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(short_name), station_name, short_name))</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Create final map for joining and add Line info to hourly data</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>station_map <span class="ot">&lt;-</span> station_name_mapping <span class="sc">%&gt;%</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(metro_stations, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"geojson_name"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">Station =</span> csv_name, <span class="at">Line =</span> line, code) <span class="sc">%&gt;%</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Line =</span> <span class="fu">str_to_title</span>(Line)) <span class="sc">%&gt;%</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line))</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>hourly <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_map, <span class="at">by =</span> <span class="st">"Station"</span>)</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Export data for web components</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>station_codes <span class="ot">&lt;-</span> metro_stations <span class="sc">%&gt;%</span> <span class="fu">select</span>(Station, code, line)</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(station_codes, <span class="st">"../src/lib/data/charts/station-codes.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>station_lines_list <span class="ot">&lt;-</span> metro_stations <span class="sc">%&gt;%</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(line) <span class="sc">%&gt;%</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">stations =</span> <span class="fu">list</span>(Station), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">deframe</span>()</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(<span class="fu">list</span>(<span class="at">lines =</span> station_lines_list), <span class="st">"../src/lib/data/charts/01-line-classification.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>ridership_sample_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_data =</span> <span class="fu">convert_to_short_names</span>(sample_ridership_data) <span class="sc">%&gt;%</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(From_Station, To_Station, Ridership, Hour, wday, Date)</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(ridership_sample_export, <span class="st">"../src/lib/data/charts/ridership-sample.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Display station counts per line</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>station_map <span class="sc">%&gt;%</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(Line, <span class="at">name =</span> <span class="st">"Stations"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Line =</span> <span class="fu">if_else</span>(Line <span class="sc">==</span> <span class="st">"Black"</span>, <span class="st">"Interchange"</span>, Line)) <span class="sc">%&gt;%</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Number of stations per metro line"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small">
<caption>Number of stations per metro line</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Line</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Stations</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Interchange</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">Green</td>
<td style="text-align: right;">30</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">36</td>
</tr>
<tr class="even">
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">15</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
<section id="exploratory-data-analysis" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Exploratory Data Analysis</h1>
<section id="days-and-hours" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="days-and-hours"><span class="header-section-number">3.1</span> Days and Hours</h2>
<p>Understanding when people use the metro most heavily.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Busiest days by average ridership</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>busiest_days <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_total =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">wday</span>(Date, <span class="at">label =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(day) <span class="sc">%&gt;%</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_daily_ridership =</span> <span class="fu">mean</span>(daily_total), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(average_daily_ridership))</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Busiest hours by average ridership</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>busiest_hours <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Hour) <span class="sc">%&gt;%</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_hourly_ridership =</span> <span class="fu">mean</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(average_hourly_ridership))</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Most popular routes by total trips</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>popular_routes <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(From_Station, To_Station) <span class="sc">%&gt;%</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_trips =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_trips)) <span class="sc">%&gt;%</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">15</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>temporal_patterns <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">busiest_days =</span> busiest_days,</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">busiest_hours =</span> <span class="fu">head</span>(busiest_hours, <span class="dv">10</span>),</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">popular_routes =</span> <span class="fu">convert_to_short_names</span>(popular_routes)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(temporal_patterns, <span class="st">"../src/lib/data/charts/02-temporal-patterns.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Display tables</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>busiest_days <span class="sc">%&gt;%</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">average_daily_ridership =</span> <span class="fu">comma</span>(<span class="fu">round</span>(average_daily_ridership))) <span class="sc">%&gt;%</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Day"</span>, <span class="st">"Average Daily Ridership"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Day</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Average Daily Ridership</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Thu</td>
<td style="text-align: left;">778,964</td>
</tr>
<tr class="even">
<td style="text-align: left;">Wed</td>
<td style="text-align: left;">766,369</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Mon</td>
<td style="text-align: left;">763,243</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tue</td>
<td style="text-align: left;">733,002</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Fri</td>
<td style="text-align: left;">628,215</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sat</td>
<td style="text-align: left;">620,690</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Sun</td>
<td style="text-align: left;">507,833</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>busiest_hours <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time =</span> <span class="fu">paste0</span>(Hour, <span class="st">":00"</span>),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">average_hourly_ridership =</span> <span class="fu">comma</span>(<span class="fu">round</span>(average_hourly_ridership))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Time, average_hourly_ridership) <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Hour"</span>, <span class="st">"Average Hourly Ridership"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Hour</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Average Hourly Ridership</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">18:00</td>
<td style="text-align: left;">851</td>
</tr>
<tr class="even">
<td style="text-align: left;">9:00</td>
<td style="text-align: left;">783</td>
</tr>
<tr class="odd">
<td style="text-align: left;">17:00</td>
<td style="text-align: left;">751</td>
</tr>
<tr class="even">
<td style="text-align: left;">19:00</td>
<td style="text-align: left;">720</td>
</tr>
<tr class="odd">
<td style="text-align: left;">8:00</td>
<td style="text-align: left;">644</td>
</tr>
<tr class="even">
<td style="text-align: left;">16:00</td>
<td style="text-align: left;">618</td>
</tr>
<tr class="odd">
<td style="text-align: left;">10:00</td>
<td style="text-align: left;">596</td>
</tr>
<tr class="even">
<td style="text-align: left;">15:00</td>
<td style="text-align: left;">504</td>
</tr>
<tr class="odd">
<td style="text-align: left;">20:00</td>
<td style="text-align: left;">489</td>
</tr>
<tr class="even">
<td style="text-align: left;">13:00</td>
<td style="text-align: left;">482</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">convert_to_short_names</span>(popular_routes) <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Route =</span> <span class="fu">paste</span>(From_Station, <span class="st">"→"</span>, To_Station),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_trips =</span> <span class="fu">comma</span>(total_trips)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Route, total_trips) <span class="sc">%&gt;%</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Route"</span>, <span class="st">"Cumulative Passengers"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Route</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Cumulative Passengers</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Benniganahalli → Majestic</td>
<td style="text-align: left;">44,477</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kadugodi Tree Park → Sri Sathya Sai Hospital</td>
<td style="text-align: left;">34,924</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Sri Sathya Sai Hospital → Kadugodi Tree Park</td>
<td style="text-align: left;">34,736</td>
</tr>
<tr class="even">
<td style="text-align: left;">Benniganahalli → Indiranagar</td>
<td style="text-align: left;">28,838</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Yeshwantpur → Majestic</td>
<td style="text-align: left;">27,539</td>
</tr>
<tr class="even">
<td style="text-align: left;">Banashankari → Majestic</td>
<td style="text-align: left;">27,130</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Indiranagar → Benniganahalli</td>
<td style="text-align: left;">27,008</td>
</tr>
<tr class="even">
<td style="text-align: left;">Chickpete → Majestic</td>
<td style="text-align: left;">26,947</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MG Road → Indiranagar</td>
<td style="text-align: left;">24,365</td>
</tr>
<tr class="even">
<td style="text-align: left;">Majestic → Benniganahalli</td>
<td style="text-align: left;">23,921</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MG Road → Benniganahalli</td>
<td style="text-align: left;">23,641</td>
</tr>
<tr class="even">
<td style="text-align: left;">Benniganahalli → MG Road</td>
<td style="text-align: left;">23,408</td>
</tr>
<tr class="odd">
<td style="text-align: left;">KR Pura → Majestic</td>
<td style="text-align: left;">23,402</td>
</tr>
<tr class="even">
<td style="text-align: left;">Konanakunte Cross → Majestic</td>
<td style="text-align: left;">23,108</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Majestic → Yeshwantpur</td>
<td style="text-align: left;">22,513</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Weekdays are busier than weekends by a significant amount. The hourly breakdown shows distinct morning (8-10 AM) and evening (5-7 PM) peaks. Routes involving Benniganahalli and Majestic appear frequently among the most popular routes.</p>
<hr>
</section>
</section>
<section id="daily-ridership-trends-over-time" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Daily Ridership Trends Over Time</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>daily_trends <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_week =</span> <span class="fu">wday</span>(Date, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_weekend =</span> day_of_week <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sat"</span>, <span class="st">"Sun"</span>),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>daily_trends_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">daily_data =</span> daily_trends <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.Date), as.character)),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary_stats =</span> <span class="fu">list</span>(</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_ridership =</span> <span class="fu">max</span>(daily_trends<span class="sc">$</span>total_ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_ridership =</span> <span class="fu">min</span>(daily_trends<span class="sc">$</span>total_ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_weekday =</span> <span class="fu">mean</span>(daily_trends<span class="sc">$</span>total_ridership[<span class="sc">!</span>daily_trends<span class="sc">$</span>is_weekend], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_weekend =</span> <span class="fu">mean</span>(daily_trends<span class="sc">$</span>total_ridership[daily_trends<span class="sc">$</span>is_weekend], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(daily_trends_export, <span class="st">"../src/lib/data/charts/03-daily-trends.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot daily trends</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(daily_trends, <span class="fu">aes</span>(<span class="at">x =</span> Date, <span class="at">y =</span> total_ridership)) <span class="sc">+</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"#34495e"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">filter</span>(daily_trends, is_weekend), <span class="fu">aes</span>(<span class="at">color =</span> <span class="st">"Weekend"</span>), <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekend"</span> <span class="ot">=</span> secondary_color)) <span class="sc">+</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">comma_format</span>(<span class="at">scale =</span> <span class="fl">1e-3</span>, <span class="at">suffix =</span> <span class="st">"K"</span>)) <span class="sc">+</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Daily Metro Ridership Over Time"</span>,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Pink points highlight weekends"</span>,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Total Daily Ridership"</span>, <span class="at">color =</span> <span class="st">""</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_metro</span>() <span class="sc">+</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/daily-trends-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="how-popular-is-your-route" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> How Popular is Your Route?</h1>
<p>We’ll calculate combinations of all possible to and from stations, and rank them by how many people took these trips in all. This will also let us find out where our personal commutes lie in the distribution. Am I an unusual duck?</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example commute</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>from_station <span class="ot">&lt;-</span> <span class="st">"Cubbon Park"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>to_station <span class="ot">&lt;-</span> <span class="st">"Nagasandra"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>yellow_line_opening <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2025-08-11"</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for the period after the Yellow Line opened</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>n_dates <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> yellow_line_opening) <span class="sc">%&gt;%</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n_distinct</span>(Date)) <span class="sc">%&gt;%</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>commute_popularity <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> yellow_line_opening, From_Station <span class="sc">!=</span> To_Station) <span class="sc">%&gt;%</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_trips =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.by =</span> <span class="fu">c</span>(From_Station, To_Station)) <span class="sc">%&gt;%</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_trips)) <span class="sc">%&gt;%</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">rank =</span> <span class="fu">row_number</span>(),</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">percentile =</span> (<span class="dv">1</span> <span class="sc">-</span> (rank <span class="sc">/</span> <span class="fu">n</span>())) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">daily_average =</span> <span class="fu">round</span>(total_trips <span class="sc">/</span> n_dates, <span class="dv">0</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>my_commute_rank <span class="ot">&lt;-</span> commute_popularity <span class="sc">%&gt;%</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(From_Station <span class="sc">==</span> from_station <span class="sc">&amp;</span> To_Station <span class="sc">==</span> to_station)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>most_common_destination <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(From_Station <span class="sc">==</span> from_station, To_Station <span class="sc">!=</span> from_station) <span class="sc">%&gt;%</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_trips =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.by =</span> To_Station) <span class="sc">%&gt;%</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> total_trips, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>most_common_origin <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(To_Station <span class="sc">==</span> to_station, From_Station <span class="sc">!=</span> to_station) <span class="sc">%&gt;%</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_trips =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.by =</span> From_Station) <span class="sc">%&gt;%</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> total_trips, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Export compressed route data using station codes</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>commute_compressed <span class="ot">&lt;-</span> commute_popularity <span class="sc">%&gt;%</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"From_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"To_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_from"</span>, <span class="st">"_to"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">f =</span> code_from, <span class="at">t =</span> code_to, <span class="at">r =</span> daily_average, <span class="at">n =</span> rank, <span class="at">p =</span> percentile) <span class="sc">%&gt;%</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(f) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(t))</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>commute_flow_only <span class="ot">&lt;-</span> commute_compressed <span class="sc">%&gt;%</span> <span class="fu">select</span>(f, t, r)</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(commute_flow_only, <span class="st">"../src/lib/data/charts/04-commute-flow.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(commute_compressed, <span class="st">"../src/lib/data/charts/04-commute-analysis.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(my_commute_rank) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"Most common destination from"</span>, <span class="fu">get_short_name</span>(from_station), <span class="st">":"</span>,</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>            <span class="fu">get_short_name</span>(most_common_destination<span class="sc">$</span>To_Station),</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">"("</span>, <span class="fu">comma</span>(most_common_destination<span class="sc">$</span>total_trips), <span class="st">" passengers)"</span>)))</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">Most common origin for"</span>, <span class="fu">get_short_name</span>(to_station), <span class="st">":"</span>,</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>            <span class="fu">get_short_name</span>(most_common_origin<span class="sc">$</span>From_Station),</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">"("</span>, <span class="fu">comma</span>(most_common_origin<span class="sc">$</span>total_trips), <span class="st">" passengers)"</span>)))</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No direct trips found for the sample route in the dataset."</span>)</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Most common destination from Cubbon Park : Indiranagar (15,078 passengers)

Most common origin for Nagasandra : Sandal Soap Factory (10,571 passengers)</code></pre>
</div>
</div>
<hr>
</section>
<section id="peak-hour-stations" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Peak Hour Stations</h1>
<p>Finding out which stations experience the heaviest arrival load during peak hours.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>busiest_peak_stations <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(peak_category <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Morning Peak"</span>, <span class="st">"Evening Peak"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(peak_category, Station, Line) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">avg_ridership =</span> <span class="fu">mean</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(peak_category) <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> avg_ridership, <span class="at">n =</span> <span class="dv">15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(peak_category, <span class="fu">desc</span>(avg_ridership))</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>peak_hour_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">peak_stations =</span> <span class="fu">convert_to_short_names</span>(busiest_peak_stations),</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">peak_summary =</span> busiest_peak_stations <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(peak_category)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(peak_hour_export, <span class="st">"../src/lib/data/charts/05-peak-hours.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Display table</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="fu">convert_to_short_names</span>(busiest_peak_stations) <span class="sc">%&gt;%</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_ridership =</span> <span class="fu">round</span>(avg_ridership, <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Busiest Stations During Peak Hours"</span>,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Top 15 stations for each peak period (Morning: 8-10 AM, Evening: 5-7 PM)"</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> avg_ridership, <span class="at">decimals =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="at">color =</span> primary_color, <span class="at">alpha =</span> <span class="fl">0.3</span>), <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>)),</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_align</span>(<span class="at">align =</span> <span class="st">"center"</span>, <span class="at">columns =</span> avg_ridership) <span class="sc">%&gt;%</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_options</span>(</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.font.names =</span> <span class="st">"Atkinson Hyperlegible"</span>,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.title.font.size =</span> <span class="dv">16</span>,</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.subtitle.font.size =</span> <span class="dv">12</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.font.size =</span> <span class="dv">11</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div id="vzhddvrmed" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#vzhddvrmed table {
  font-family: 'Atkinson Hyperlegible';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#vzhddvrmed thead, #vzhddvrmed tbody, #vzhddvrmed tfoot, #vzhddvrmed tr, #vzhddvrmed td, #vzhddvrmed th {
  border-style: none;
}

#vzhddvrmed p {
  margin: 0;
  padding: 0;
}

#vzhddvrmed .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 11px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#vzhddvrmed .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#vzhddvrmed .gt_title {
  color: #333333;
  font-size: 16px;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#vzhddvrmed .gt_subtitle {
  color: #333333;
  font-size: 12px;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#vzhddvrmed .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#vzhddvrmed .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vzhddvrmed .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#vzhddvrmed .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#vzhddvrmed .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#vzhddvrmed .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#vzhddvrmed .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#vzhddvrmed .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#vzhddvrmed .gt_spanner_row {
  border-bottom-style: hidden;
}

#vzhddvrmed .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#vzhddvrmed .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#vzhddvrmed .gt_from_md > :first-child {
  margin-top: 0;
}

#vzhddvrmed .gt_from_md > :last-child {
  margin-bottom: 0;
}

#vzhddvrmed .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#vzhddvrmed .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#vzhddvrmed .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#vzhddvrmed .gt_row_group_first td {
  border-top-width: 2px;
}

#vzhddvrmed .gt_row_group_first th {
  border-top-width: 2px;
}

#vzhddvrmed .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#vzhddvrmed .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#vzhddvrmed .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#vzhddvrmed .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vzhddvrmed .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#vzhddvrmed .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#vzhddvrmed .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#vzhddvrmed .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#vzhddvrmed .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vzhddvrmed .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#vzhddvrmed .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#vzhddvrmed .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#vzhddvrmed .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#vzhddvrmed .gt_left {
  text-align: left;
}

#vzhddvrmed .gt_center {
  text-align: center;
}

#vzhddvrmed .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#vzhddvrmed .gt_font_normal {
  font-weight: normal;
}

#vzhddvrmed .gt_font_bold {
  font-weight: bold;
}

#vzhddvrmed .gt_font_italic {
  font-style: italic;
}

#vzhddvrmed .gt_super {
  font-size: 65%;
}

#vzhddvrmed .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#vzhddvrmed .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#vzhddvrmed .gt_indent_1 {
  text-indent: 5px;
}

#vzhddvrmed .gt_indent_2 {
  text-indent: 10px;
}

#vzhddvrmed .gt_indent_3 {
  text-indent: 15px;
}

#vzhddvrmed .gt_indent_4 {
  text-indent: 20px;
}

#vzhddvrmed .gt_indent_5 {
  text-indent: 25px;
}

#vzhddvrmed .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#vzhddvrmed div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-bootstrap="false">
<thead>
<tr class="gt_heading header">
<td colspan="4" class="gt_heading gt_title gt_font_normal">Busiest Stations During Peak Hours</td>
</tr>
<tr class="gt_heading even">
<td colspan="4" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border">Top 15 stations for each peak period (Morning: 8-10 AM, Evening: 5-7 PM)</td>
</tr>
<tr class="gt_col_headings header">
<th id="peak_category" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="background-color: rgba(49,130,189,0.3); font-weight: bold" scope="col">peak_category</th>
<th id="Station" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="background-color: rgba(49,130,189,0.3); font-weight: bold" scope="col">Station</th>
<th id="Line" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="background-color: rgba(49,130,189,0.3); font-weight: bold" scope="col">Line</th>
<th id="avg_ridership" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" style="background-color: rgba(49,130,189,0.3); font-weight: bold" scope="col">avg_ridership</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">MG Road</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">3,050.4</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Indiranagar</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">2,876.4</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Trinity</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">2,664.6</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Majestic</td>
<td class="gt_row gt_left" headers="Line">Black</td>
<td class="gt_row gt_center" headers="avg_ridership">2,473.4</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Cubbon Park</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">2,439.4</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Vidhana Soudha</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">2,194.9</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Pattandur Agrahara</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,992.3</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Central College</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,769.5</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Benniganahalli</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,749.9</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Sri Sathya Sai Hospital</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,694.5</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Mantri Square</td>
<td class="gt_row gt_left" headers="Line">Green</td>
<td class="gt_row gt_center" headers="avg_ridership">1,677.1</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Chickpete</td>
<td class="gt_row gt_left" headers="Line">Green</td>
<td class="gt_row gt_center" headers="avg_ridership">1,501.8</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Jayanagar</td>
<td class="gt_row gt_left" headers="Line">Green</td>
<td class="gt_row gt_center" headers="avg_ridership">1,447.7</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">KR Pura</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,441.0</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Evening Peak</td>
<td class="gt_row gt_left" headers="Station">Seetharampalya</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,332.8</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Benniganahalli</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">3,205.9</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Majestic</td>
<td class="gt_row gt_left" headers="Line">Black</td>
<td class="gt_row gt_center" headers="avg_ridership">2,175.9</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">KR Pura</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">2,090.6</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Baiyappanahalli</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">2,062.0</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Vijayanagara</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,880.5</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Kadugodi Tree Park</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,850.9</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Hosahalli</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,670.8</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Dasarahalli</td>
<td class="gt_row gt_left" headers="Line">Green</td>
<td class="gt_row gt_center" headers="avg_ridership">1,545.7</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Indiranagar</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,529.2</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Attiguppe</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,440.9</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Yelachenahalli</td>
<td class="gt_row gt_left" headers="Line">Green</td>
<td class="gt_row gt_center" headers="avg_ridership">1,386.9</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Whitefield (Kadugodi)</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,364.8</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Nagasandra</td>
<td class="gt_row gt_left" headers="Line">Green</td>
<td class="gt_row gt_center" headers="avg_ridership">1,356.4</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">KSR Railway Station</td>
<td class="gt_row gt_left" headers="Line">Purple</td>
<td class="gt_row gt_center" headers="avg_ridership">1,335.2</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="peak_category">Morning Peak</td>
<td class="gt_row gt_left" headers="Station">Konanakunte Cross</td>
<td class="gt_row gt_left" headers="Line">Green</td>
<td class="gt_row gt_center" headers="avg_ridership">1,289.5</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<hr>
</section>
<section id="station-activity" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Station Activity</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the average ridership when station is origin station</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>origin_avg <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(From_Station, day_type, Hour, Date) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">Station =</span> From_Station, day_type, total_ridership, Hour, Date)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the average ridership when station is destination station</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>destination_avg <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(To_Station, day_type, Hour, Date) <span class="sc">%&gt;%</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">Station =</span> To_Station, day_type, total_ridership, Hour, Date)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Get total ridership at each station at each hour by summing the origin and destination ridership</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>total_ridership <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(origin_avg, destination_avg) <span class="sc">%&gt;%</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, day_type, Hour, Date) <span class="sc">%&gt;%</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(total_ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, day_type, total_ridership, Hour, Date)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Get median at each hour across all dates</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>median_ridership <span class="ot">&lt;-</span> total_ridership <span class="sc">%&gt;%</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, day_type, Hour) <span class="sc">%&gt;%</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_ridership =</span> <span class="fu">median</span>(total_ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, day_type, median_ridership, Hour)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Get total ridership throughout each day by summing over all median ridership</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>daily_ridership <span class="ot">&lt;-</span> median_ridership <span class="sc">%&gt;%</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, day_type) <span class="sc">%&gt;%</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(median_ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, day_type, total_ridership)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the ratio of median ridership at each hour to the total ridership throughout each day</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>hourly_heatmap_data <span class="ot">&lt;-</span> median_ridership <span class="sc">%&gt;%</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(daily_ridership, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Station"</span>, <span class="st">"day_type"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hourly_ratio =</span> median_ridership <span class="sc">/</span> total_ridership) <span class="sc">%&gt;%</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, day_type, hourly_ratio, Hour, median_ridership)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill missing hours with 0</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>hourly_heatmap_data <span class="ot">&lt;-</span> hourly_heatmap_data <span class="sc">%&gt;%</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(<span class="at">Hour =</span> <span class="fu">full_seq</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">23</span>), <span class="dv">1</span>), Station, day_type) <span class="sc">%&gt;%</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace_na</span>(<span class="fu">list</span>(<span class="at">hourly_ratio =</span> <span class="dv">0</span>, <span class="at">median_ridership =</span> <span class="dv">0</span>))</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>hourly_heatmap_data <span class="ot">&lt;-</span> <span class="fu">convert_to_short_names</span>(hourly_heatmap_data)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the peak hours</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>peak_hours <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">17</span><span class="sc">:</span><span class="dv">19</span>)</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>heatmap_data <span class="ot">&lt;-</span> hourly_heatmap_data <span class="sc">%&gt;%</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, Hour, day_type, hourly_ratio)</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>heatmap_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>  heatmap_data</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(heatmap_export, <span class="st">"../src/lib/data/charts/07-station-heatmaps.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Station order for graph</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>station_order <span class="ot">&lt;-</span> hourly_heatmap_data <span class="sc">%&gt;%</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">17</span><span class="sc">:</span><span class="dv">19</span>)) <span class="sc">%&gt;%</span> <span class="co"># Peak hours</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station) <span class="sc">%&gt;%</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">peak_ridership =</span> <span class="fu">mean</span>(median_ridership), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(peak_ridership)) <span class="sc">%&gt;%</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(Station)</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>station_order_display <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_chr</span>(station_order, get_short_name)</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot heatmap</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hourly_heatmap_data, <span class="fu">aes</span>(<span class="at">x =</span> Hour, <span class="at">y =</span> <span class="fu">factor</span>(Station, <span class="at">levels =</span> <span class="fu">rev</span>(station_order_display)), <span class="at">fill =</span> hourly_ratio)) <span class="sc">+</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"Avg</span><span class="sc">\n</span><span class="st">Ridership"</span>, <span class="at">trans =</span> <span class="st">"sqrt"</span>, <span class="at">labels =</span> comma, <span class="at">option =</span> <span class="st">"plasma"</span>) <span class="sc">+</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>day_type, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>, <span class="dv">15</span>, <span class="dv">18</span>, <span class="dv">21</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"6AM"</span>, <span class="st">"9AM"</span>, <span class="st">"12PM"</span>, <span class="st">"3PM"</span>, <span class="st">"6PM"</span>, <span class="st">"9PM"</span>)) <span class="sc">+</span></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Metro Station Activity Throughout the Day"</span>,</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Stations ordered by peak hour ridership. Color scale is square-root transformed."</span>,</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Hour of Day"</span>, <span class="at">y =</span> <span class="st">"Station"</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_metro</span>() <span class="sc">+</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>),</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">20</span>, <span class="dv">25</span>, <span class="dv">20</span>, <span class="dv">25</span>)</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/station-heatmaps-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="interchange-station-footfall" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Interchange Station Footfall</h1>
<p>Analyzing how footfall at interchange stations has changed with the opening of the Yellow Line.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define key dates</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>yellow_line_opening <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2025-08-11"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Populate line attribute in station_pair_hourly</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>station_pair_hourly <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"From_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"To_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_from"</span>, <span class="st">"_to"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">From_line =</span> <span class="fu">if_else</span>(Line_from <span class="sc">==</span> <span class="st">"Black"</span>, <span class="st">"Purple"</span>, Line_from)) <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">To_line =</span> <span class="fu">if_else</span>(Line_to <span class="sc">==</span> <span class="st">"Black"</span>, <span class="st">"Green"</span>, Line_to)) <span class="sc">%&gt;%</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Line_from, <span class="sc">-</span>Line_to)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average daily number of passengers transferring at Rashtreeya Vidyalaya Road before Yellow Line</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>rashtreeya_vidyalaya_road_footfall <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>((From_line <span class="sc">==</span> <span class="st">"Yellow"</span> <span class="sc">&amp;</span> To_line <span class="sc">!=</span> <span class="st">"Yellow"</span>) <span class="sc">|</span> (From_line <span class="sc">!=</span> <span class="st">"Yellow"</span> <span class="sc">&amp;</span> To_line <span class="sc">==</span> <span class="st">"Yellow"</span>) <span class="sc">|</span> (From_Station <span class="sc">==</span> <span class="st">"Rashtreeya Vidyalaya Road"</span>) <span class="sc">|</span> (To_Station <span class="sc">==</span> <span class="st">"Rashtreeya Vidyalaya Road"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_footfall =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&lt;</span> yellow_line_opening) <span class="sc">%&gt;%</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_footfall =</span> <span class="fu">round</span>(<span class="fu">mean</span>(daily_footfall), <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Station =</span> <span class="st">"Rashtreeya Vidyalaya Road"</span>, <span class="at">Before =</span> average_footfall) <span class="sc">%&gt;%</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>average_footfall)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average daily number of passengers transferring at Majestic before Yellow Line</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>majestic_footfall <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>((From_line <span class="sc">==</span> <span class="st">"Purple"</span> <span class="sc">&amp;</span> To_line <span class="sc">!=</span> <span class="st">"Purple"</span>) <span class="sc">|</span> (From_line <span class="sc">!=</span> <span class="st">"Purple"</span> <span class="sc">&amp;</span> To_line <span class="sc">==</span> <span class="st">"Purple"</span>) <span class="sc">|</span> (From_Station <span class="sc">==</span> <span class="st">"Majestic"</span>) <span class="sc">|</span> (To_Station <span class="sc">==</span> <span class="st">"Majestic"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_footfall =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&lt;</span> yellow_line_opening) <span class="sc">%&gt;%</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_footfall =</span> <span class="fu">round</span>(<span class="fu">mean</span>(daily_footfall), <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Station =</span> <span class="st">"Majestic"</span>, <span class="at">Before =</span> average_footfall) <span class="sc">%&gt;%</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>average_footfall)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average daily number of passengers transferring at Rashtreeya Vidyalaya Road after Yellow Line</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>rashtreeya_vidyalaya_road_footfall_after <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>((From_line <span class="sc">==</span> <span class="st">"Yellow"</span> <span class="sc">&amp;</span> To_line <span class="sc">!=</span> <span class="st">"Yellow"</span>) <span class="sc">|</span> (From_line <span class="sc">!=</span> <span class="st">"Yellow"</span> <span class="sc">&amp;</span> To_line <span class="sc">==</span> <span class="st">"Yellow"</span>) <span class="sc">|</span> (From_Station <span class="sc">==</span> <span class="st">"Rashtreeya Vidyalaya Road"</span>) <span class="sc">|</span> (To_Station <span class="sc">==</span> <span class="st">"Rashtreeya Vidyalaya Road"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_footfall =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> yellow_line_opening) <span class="sc">%&gt;%</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_footfall =</span> <span class="fu">round</span>(<span class="fu">mean</span>(daily_footfall), <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Station =</span> <span class="st">"Rashtreeya Vidyalaya Road"</span>, <span class="at">After =</span> average_footfall) <span class="sc">%&gt;%</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>average_footfall)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average daily number of passengers transferring at Majestic after Yellow Line</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>majestic_footfall_after <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>((From_line <span class="sc">==</span> <span class="st">"Purple"</span> <span class="sc">&amp;</span> To_line <span class="sc">!=</span> <span class="st">"Purple"</span>) <span class="sc">|</span> (From_line <span class="sc">!=</span> <span class="st">"Purple"</span> <span class="sc">&amp;</span> To_line <span class="sc">==</span> <span class="st">"Purple"</span>) <span class="sc">|</span> (From_Station <span class="sc">==</span> <span class="st">"Majestic"</span>) <span class="sc">|</span> (To_Station <span class="sc">==</span> <span class="st">"Majestic"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_footfall =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> yellow_line_opening) <span class="sc">%&gt;%</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_footfall =</span> <span class="fu">round</span>(<span class="fu">mean</span>(daily_footfall), <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Station =</span> <span class="st">"Majestic"</span>, <span class="at">After =</span> average_footfall) <span class="sc">%&gt;%</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>average_footfall)</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>interchange_footfall <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(rashtreeya_vidyalaya_road_footfall, majestic_footfall, rashtreeya_vidyalaya_road_footfall_after, majestic_footfall_after)</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>interchange_footfall_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">interchange_footfall =</span> interchange_footfall</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(interchange_footfall_export, <span class="st">"../src/lib/data/charts/13-interchange-station-footfall.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="the-yellow-line-effect" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> The Yellow Line Effect</h1>
<p>Analyzing how the opening of the Yellow Line on August 11th, 2025 affected daily boarding totals at existing Green and Purple Line stations. The impact of the Yellow Line was more noticeable at Green Line stations than at Purple Line stations.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define key dates</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>yellow_line_opening <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2025-08-11"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>holidays <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">"2025-08-15"</span>, <span class="st">"2025-08-16"</span>)) <span class="co"># Independence Day, Krishna Janmashtami</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Use a linear model to find stations with statistically significant changes</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>significant_stations <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, Station, Line, wday, day_type) <span class="sc">%&gt;%</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">after_yellow_line =</span> <span class="fu">if_else</span>(Date <span class="sc">&gt;=</span> yellow_line_opening, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_event_day =</span> <span class="fu">if_else</span>(Date <span class="sc">%in%</span> holidays, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(day_type <span class="sc">==</span> <span class="st">"Weekday"</span> <span class="sc">&amp;</span> is_event_day <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Line <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Green"</span>, <span class="st">"Purple"</span>, <span class="st">"Black"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station) <span class="sc">%&gt;%</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n_distinct</span>(after_yellow_line) <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="co"># Ensure data for both periods</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(Station, Line) <span class="sc">%&gt;%</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">list</span>(<span class="fu">lm</span>(daily_ridership <span class="sc">~</span> after_yellow_line <span class="sc">+</span> wday, <span class="at">data =</span> data))) <span class="sc">%&gt;%</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">tidy</span>(model)) <span class="sc">%&gt;%</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"after_yellow_line"</span> <span class="sc">&amp;</span> p.value <span class="sc">&lt;</span> <span class="fl">0.09</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate median percentage change for context</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>impact_by_percent_change <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, Station, Line, day_type) <span class="sc">%&gt;%</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">period =</span> <span class="fu">if_else</span>(Date <span class="sc">&gt;=</span> yellow_line_opening, <span class="st">"after"</span>, <span class="st">"before"</span>),</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_event_day =</span> <span class="fu">if_else</span>(Date <span class="sc">%in%</span> holidays, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(day_type <span class="sc">==</span> <span class="st">"Weekday"</span> <span class="sc">&amp;</span> is_event_day <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Line <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Green"</span>, <span class="st">"Purple"</span>, <span class="st">"Black"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, Line, period) <span class="sc">%&gt;%</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_weekday_ridership =</span> <span class="fu">median</span>(daily_ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> period, <span class="at">values_from =</span> median_weekday_ridership) <span class="sc">%&gt;%</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(before) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(after)) <span class="sc">%&gt;%</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent_change =</span> ((after <span class="sc">-</span> before) <span class="sc">/</span> before) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results into a final summary</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>final_impact_summary <span class="ot">&lt;-</span> significant_stations <span class="sc">%&gt;%</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(impact_by_percent_change, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Station"</span>, <span class="st">"Line"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    Station, Line,</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Median Change (%)</span><span class="st">`</span> <span class="ot">=</span> percent_change,</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Abs. Change (est.)</span><span class="st">`</span> <span class="ot">=</span> estimate,</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value</span><span class="st">`</span> <span class="ot">=</span> p.value,</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Before Median</span><span class="st">`</span> <span class="ot">=</span> before,</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">After Median</span><span class="st">`</span> <span class="ot">=</span> after</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="st">`</span><span class="at">Median Change (%)</span><span class="st">`</span>))</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_impact_summary)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 7
   Station              Line  `Median Change (%)` `Abs. Change (est.)` `p-value`
   &lt;chr&gt;                &lt;chr&gt;               &lt;dbl&gt;                &lt;dbl&gt;     &lt;dbl&gt;
 1 Lalbagh              Green               38.7                 2486.  0.000916
 2 Manjunathanagara     Green               27.0                  196.  0.0891  
 3 Nadaprabhu Kempegow… Black               26.3                 4985.  0.00457 
 4 Jalahalli            Green               22.6                 1186.  0.00772 
 5 Nagasandra           Green               22.2                 1478.  0.0157  
 6 Rashtreeya Vidyalay… Black               17.8                 1573.  0.0542  
 7 Goraguntepalya       Green               16.3                  893.  0.0502  
 8 Sandal Soap Factory  Green                6.90                 878.  0.0610  
 9 Banashankari         Green              -12.9                -1300.  0.0432  
10 Chickpete            Green              -13.9                -3132.  0.0414  
# ℹ 2 more variables: `Before Median` &lt;dbl&gt;, `After Median` &lt;dbl&gt;</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>yellow_line_impact_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">station_impacts =</span> final_impact_summary <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Station, Line, <span class="at">percent_change =</span> <span class="st">`</span><span class="at">Median Change (%)</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">convert_to_short_names</span>()</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(yellow_line_impact_export, <span class="st">"../src/lib/data/charts/10-yellow-line-impact.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="station-pair-ridership-spikes" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Station Pair Ridership Spikes</h1>
<p>During the days for which data is available, there have been unusual spikes in ridership between pairs of stations, compared to their typical ridership.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate typical ridership (hourly mean) for each station pair</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>station_pair_hourly_means <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(From_Station <span class="sc">!=</span> To_Station) <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(From_Station, To_Station, Hour) <span class="sc">%&gt;%</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">typical_ridership =</span> <span class="fu">mean</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_observations =</span> <span class="fu">n</span>(),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(total_observations <span class="sc">&gt;=</span> <span class="dv">5</span>) <span class="co"># Ensure stable mean</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify spikes by comparing actual ridership to the hourly mean</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>station_pair_spikes <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(From_Station <span class="sc">!=</span> To_Station) <span class="sc">%&gt;%</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_pair_hourly_means, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"From_Station"</span>, <span class="st">"To_Station"</span>, <span class="st">"Hour"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(typical_ridership)) <span class="sc">%&gt;%</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">deviation_multiple =</span> <span class="fu">if_else</span>(typical_ridership <span class="sc">&gt;</span> <span class="dv">0</span>, Ridership <span class="sc">/</span> typical_ridership, <span class="dv">0</span>),</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">spike_category =</span> <span class="fu">case_when</span>(</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>      deviation_multiple <span class="sc">&gt;=</span> <span class="dv">5</span> <span class="sc">~</span> <span class="st">"Extreme Spike (5x+)"</span>,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>      deviation_multiple <span class="sc">&gt;=</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"High Spike (3-5x)"</span>,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>      deviation_multiple <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Moderate Spike (2-3x)"</span>,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Normal"</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(deviation_multiple))</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>top_spikes <span class="ot">&lt;-</span> station_pair_spikes <span class="sc">%&gt;%</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(spike_category <span class="sc">!=</span> <span class="st">"Normal"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">50</span>)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Export data for visualization</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>spikes_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">top_spikes =</span> <span class="fu">convert_to_short_names</span>(top_spikes) <span class="sc">%&gt;%</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date, Hour, From_Station, To_Station, Ridership, typical_ridership, deviation_multiple, spike_category, peak_category) <span class="sc">%&gt;%</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.character</span>(Date)),</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">spike_summary =</span> station_pair_spikes <span class="sc">%&gt;%</span> <span class="fu">count</span>(spike_category, <span class="at">name =</span> <span class="st">"count"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">percentage =</span> <span class="fu">round</span>(count <span class="sc">/</span> <span class="fu">sum</span>(count) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(count))</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(spikes_export, <span class="st">"../src/lib/data/charts/09-station-pair-spikes.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Display top spikes table</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="fu">convert_to_short_names</span>(top_spikes) <span class="sc">%&gt;%</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">20</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">Route =</span> <span class="fu">paste</span>(From_Station, <span class="st">" &amp; "</span>, To_Station),</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Date &amp; Time</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste</span>(Date, <span class="fu">paste0</span>(Hour, <span class="st">":00"</span>)),</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Actual Ridership</span><span class="st">`</span> <span class="ot">=</span> Ridership,</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Typical Ridership</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(typical_ridership, <span class="dv">1</span>)</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Route, <span class="st">`</span><span class="at">Date &amp; Time</span><span class="st">`</span>, <span class="st">`</span><span class="at">Actual Ridership</span><span class="st">`</span>, <span class="st">`</span><span class="at">Typical Ridership</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Top Ridership Spikes Between Station Pairs"</span>,</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Instances where ridership was significantly higher than the hourly average"</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Actual Ridership</span><span class="st">`</span>, <span class="st">`</span><span class="at">Typical Ridership</span><span class="st">`</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="at">color =</span> primary_color, <span class="at">alpha =</span> <span class="fl">0.3</span>), <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>)),</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_options</span>(</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.font.names =</span> <span class="st">"Atkinson Hyperlegible"</span>,</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.title.font.size =</span> <span class="dv">16</span>,</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.subtitle.font.size =</span> <span class="dv">12</span>,</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.font.size =</span> <span class="dv">10</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div id="bxrcxwquzr" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#bxrcxwquzr table {
  font-family: 'Atkinson Hyperlegible';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#bxrcxwquzr thead, #bxrcxwquzr tbody, #bxrcxwquzr tfoot, #bxrcxwquzr tr, #bxrcxwquzr td, #bxrcxwquzr th {
  border-style: none;
}

#bxrcxwquzr p {
  margin: 0;
  padding: 0;
}

#bxrcxwquzr .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 10px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#bxrcxwquzr .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#bxrcxwquzr .gt_title {
  color: #333333;
  font-size: 16px;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#bxrcxwquzr .gt_subtitle {
  color: #333333;
  font-size: 12px;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#bxrcxwquzr .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bxrcxwquzr .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bxrcxwquzr .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bxrcxwquzr .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#bxrcxwquzr .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#bxrcxwquzr .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#bxrcxwquzr .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#bxrcxwquzr .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#bxrcxwquzr .gt_spanner_row {
  border-bottom-style: hidden;
}

#bxrcxwquzr .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#bxrcxwquzr .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#bxrcxwquzr .gt_from_md > :first-child {
  margin-top: 0;
}

#bxrcxwquzr .gt_from_md > :last-child {
  margin-bottom: 0;
}

#bxrcxwquzr .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#bxrcxwquzr .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#bxrcxwquzr .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#bxrcxwquzr .gt_row_group_first td {
  border-top-width: 2px;
}

#bxrcxwquzr .gt_row_group_first th {
  border-top-width: 2px;
}

#bxrcxwquzr .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bxrcxwquzr .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#bxrcxwquzr .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#bxrcxwquzr .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bxrcxwquzr .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bxrcxwquzr .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#bxrcxwquzr .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#bxrcxwquzr .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#bxrcxwquzr .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bxrcxwquzr .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bxrcxwquzr .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#bxrcxwquzr .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bxrcxwquzr .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#bxrcxwquzr .gt_left {
  text-align: left;
}

#bxrcxwquzr .gt_center {
  text-align: center;
}

#bxrcxwquzr .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#bxrcxwquzr .gt_font_normal {
  font-weight: normal;
}

#bxrcxwquzr .gt_font_bold {
  font-weight: bold;
}

#bxrcxwquzr .gt_font_italic {
  font-style: italic;
}

#bxrcxwquzr .gt_super {
  font-size: 65%;
}

#bxrcxwquzr .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#bxrcxwquzr .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#bxrcxwquzr .gt_indent_1 {
  text-indent: 5px;
}

#bxrcxwquzr .gt_indent_2 {
  text-indent: 10px;
}

#bxrcxwquzr .gt_indent_3 {
  text-indent: 15px;
}

#bxrcxwquzr .gt_indent_4 {
  text-indent: 20px;
}

#bxrcxwquzr .gt_indent_5 {
  text-indent: 25px;
}

#bxrcxwquzr .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#bxrcxwquzr div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-bootstrap="false">
<thead>
<tr class="gt_heading header">
<td colspan="4" class="gt_heading gt_title gt_font_normal">Top Ridership Spikes Between Station Pairs</td>
</tr>
<tr class="gt_heading even">
<td colspan="4" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border">Instances where ridership was significantly higher than the hourly average</td>
</tr>
<tr class="gt_col_headings header">
<th id="Route" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="background-color: rgba(49,130,189,0.3); font-weight: bold" scope="col">Route</th>
<th id="Date-&amp;-Time" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: rgba(49,130,189,0.3); font-weight: bold" scope="col">Date &amp; Time</th>
<th id="Actual-Ridership" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: rgba(49,130,189,0.3); font-weight: bold" scope="col">Actual Ridership</th>
<th id="Typical-Ridership" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: rgba(49,130,189,0.3); font-weight: bold" scope="col">Typical Ridership</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="Route">Central College &amp; Vidhana Soudha</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-15 19:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">130</td>
<td class="gt_row gt_right" headers="Typical Ridership">12</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Route">Majestic &amp; Vidhana Soudha</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-15 19:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">301</td>
<td class="gt_row gt_right" headers="Typical Ridership">28</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Route">Lalbagh &amp; Vidhana Soudha</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-15 19:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">210</td>
<td class="gt_row gt_right" headers="Typical Ridership">20</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Route">Chickpete &amp; Vidhana Soudha</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-15 18:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">128</td>
<td class="gt_row gt_right" headers="Typical Ridership">12</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Route">Central College &amp; Garudacharpalya</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-03 10:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">48</td>
<td class="gt_row gt_right" headers="Typical Ridership">5</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Route">Baiyappanahalli &amp; Vidhana Soudha</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-15 19:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">47</td>
<td class="gt_row gt_right" headers="Typical Ridership">5</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Route">Vidhana Soudha &amp; Central College</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-15 21:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">127</td>
<td class="gt_row gt_right" headers="Typical Ridership">13</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Route">Sandal Soap Factory &amp; Central College</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-02 14:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">72</td>
<td class="gt_row gt_right" headers="Typical Ridership">8</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Route">Central College &amp; Vidhana Soudha</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-15 20:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">110</td>
<td class="gt_row gt_right" headers="Typical Ridership">12</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Route">Halasuru &amp; Vidhana Soudha</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-02 11:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">178</td>
<td class="gt_row gt_right" headers="Typical Ridership">19</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Route">Chickpete &amp; Vidhana Soudha</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-15 16:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">159</td>
<td class="gt_row gt_right" headers="Typical Ridership">17</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Route">Mahalakshmi &amp; Halasuru</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-16 22:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">49</td>
<td class="gt_row gt_right" headers="Typical Ridership">5</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Route">Vidhana Soudha &amp; MG Road</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-15 21:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">118</td>
<td class="gt_row gt_right" headers="Typical Ridership">13</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Route">KSR Railway Station &amp; Cubbon Park</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-01 23:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">32</td>
<td class="gt_row gt_right" headers="Typical Ridership">4</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Route">Baiyappanahalli &amp; Nayandahalli</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-15 16:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">60</td>
<td class="gt_row gt_right" headers="Typical Ridership">7</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Route">KSR Railway Station &amp; Majestic</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-10 11:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">268</td>
<td class="gt_row gt_right" headers="Typical Ridership">31</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Route">Sandal Soap Factory &amp; Vidhana Soudha</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-15 18:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">97</td>
<td class="gt_row gt_right" headers="Typical Ridership">11</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Route">Chickpete &amp; Vidhana Soudha</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-15 19:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">84</td>
<td class="gt_row gt_right" headers="Typical Ridership">10</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Route">Mahalakshmi &amp; Majestic</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-16 23:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">58</td>
<td class="gt_row gt_right" headers="Typical Ridership">7</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Route">Vidhana Soudha &amp; Kengeri</td>
<td class="gt_row gt_right" headers="Date &amp; Time">2025-08-08 14:00</td>
<td class="gt_row gt_right" headers="Actual Ridership">88</td>
<td class="gt_row gt_right" headers="Typical Ridership">10</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Export daily totals for specific stations for a targeted spike visualization</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>selected_stations <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Mahalakshmi"</span>, <span class="st">"Lalbagh"</span>, <span class="st">"Vidhana Soudha"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>station_daily_selected <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Station <span class="sc">%in%</span> selected_stations) <span class="sc">%&gt;%</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, Line, Date) <span class="sc">%&gt;%</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Total =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Station, Date) <span class="sc">%&gt;%</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.character</span>(Date)) <span class="sc">%&gt;%</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">convert_to_short_names</span>() <span class="co"># Use short names for consistency</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>export_daily_payload <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">window =</span> <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-08-15"</span>, <span class="at">end =</span> <span class="st">"2025-08-18"</span>),</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">stations =</span> <span class="fu">convert_to_short_names</span>(<span class="fu">tibble</span>(<span class="at">Station =</span> selected_stations))<span class="sc">$</span>Station,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> station_daily_selected</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(export_daily_payload, <span class="st">"../src/lib/data/charts/09-station-spike-daily.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="weekdays-vs-weekends---network" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Weekdays vs Weekends - Network</h1>
<p>Does Bangalore’s metro serve different functions throughout the week? Weekdays for work commute and a visible difference in the weekends?</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>hourly_avg_wide <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(day_type, Hour) <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Average_Ridership =</span> <span class="fu">mean</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> day_type, <span class="at">values_from =</span> Average_Ridership, <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>ribbon_data <span class="ot">&lt;-</span> hourly_avg_wide <span class="sc">%&gt;%</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekday_ribbon_ymax =</span> <span class="fu">if_else</span>(Weekday <span class="sc">&gt;</span> Weekend, Weekday, Weekend),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekend_ribbon_ymax =</span> <span class="fu">if_else</span>(Weekend <span class="sc">&gt;</span> Weekday, Weekend, Weekday)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>weekday_weekend_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">hourly_averages =</span> <span class="fu">pivot_longer</span>(hourly_avg_wide, <span class="sc">-</span>Hour, <span class="at">names_to =</span> <span class="st">"day_type"</span>, <span class="at">values_to =</span> <span class="st">"Average_Ridership"</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(weekday_weekend_export, <span class="st">"../src/lib/data/charts/06-weekday-weekend-patterns.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot comparison</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ribbon_data, <span class="fu">aes</span>(<span class="at">x =</span> Hour)) <span class="sc">+</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Weekend, <span class="at">ymax =</span> weekday_ribbon_ymax), <span class="at">fill =</span> primary_color, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Weekday, <span class="at">ymax =</span> weekend_ribbon_ymax), <span class="at">fill =</span> secondary_color, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Weekday), <span class="at">color =</span> primary_color, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Weekend), <span class="at">color =</span> secondary_color, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">8</span>, <span class="at">y =</span> <span class="fu">max</span>(ribbon_data<span class="sc">$</span>Weekday) <span class="sc">*</span> <span class="fl">0.9</span>, <span class="at">label =</span> <span class="st">"Weekday"</span>, <span class="at">color =</span> primary_color, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">14</span>, <span class="at">y =</span> <span class="fu">max</span>(ribbon_data<span class="sc">$</span>Weekend) <span class="sc">*</span> <span class="fl">0.8</span>, <span class="at">label =</span> <span class="st">"Weekend"</span>, <span class="at">color =</span> secondary_color, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">23</span>, <span class="dv">3</span>), <span class="at">labels =</span> <span class="fu">paste0</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">23</span>, <span class="dv">3</span>), <span class="st">":00"</span>)) <span class="sc">+</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">comma_format</span>()) <span class="sc">+</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Ridership Patterns: Weekday vs Weekend"</span>,</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Average ridership per station across all hours of the day"</span>,</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Hour of Day"</span>, <span class="at">y =</span> <span class="st">"Average Ridership per Station"</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_metro</span>() <span class="sc">+</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/weekday-weekend-patterns-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="weekdays-vs-weekends---stations-at-peak-hour" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Weekdays vs Weekends - Stations at Peak Hour</h1>
<p>Some stations serve very different functions on weekdays versus weekends.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate weekday vs weekend peak traffic differences</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>peak_diff_data <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line)) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, Hour, day_type, Line) <span class="sc">%&gt;%</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">avg_ridership =</span> <span class="fu">mean</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">17</span><span class="sc">:</span><span class="dv">19</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, day_type, Line) <span class="sc">%&gt;%</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">peak_ridership =</span> <span class="fu">mean</span>(avg_ridership), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> day_type, <span class="at">values_from =</span> peak_ridership, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekday_weekend_diff =</span> Weekday <span class="sc">-</span> Weekend,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_category =</span> <span class="fu">case_when</span>(</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>      weekday_weekend_diff <span class="sc">&gt;</span> <span class="dv">500</span> <span class="sc">~</span> <span class="st">"Strongly Weekday-Oriented"</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>      weekday_weekend_diff <span class="sc">&gt;</span> <span class="dv">200</span> <span class="sc">~</span> <span class="st">"Moderately Weekday-Oriented"</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>      weekday_weekend_diff <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">50</span> <span class="sc">~</span> <span class="st">"Weekend-Oriented"</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Balanced"</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(weekday_weekend_diff))</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>differential_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">station_differences =</span> <span class="fu">convert_to_short_names</span>(peak_diff_data),</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">category_summary =</span> peak_diff_data <span class="sc">%&gt;%</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(diff_category, <span class="at">name =</span> <span class="st">"station_count"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">percentage =</span> <span class="fu">round</span>(station_count <span class="sc">/</span> <span class="fu">sum</span>(station_count) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>))</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(differential_export, <span class="st">"../src/lib/data/charts/08-weekday-weekend-differential.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for diverging bar chart</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>top_diff_data <span class="ot">&lt;-</span> <span class="fu">convert_to_short_names</span>(peak_diff_data) <span class="sc">%&gt;%</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">25</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Station =</span> <span class="fu">fct_reorder</span>(Station, weekday_weekend_diff)) <span class="sc">%&gt;%</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, Weekday, Weekend) <span class="sc">%&gt;%</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(Weekday, Weekend), <span class="at">names_to =</span> <span class="st">"day_type"</span>, <span class="at">values_to =</span> <span class="st">"ridership"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">ridership_direction =</span> <span class="fu">if_else</span>(day_type <span class="sc">==</span> <span class="st">"Weekend"</span>, <span class="sc">-</span>ridership, ridership),</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_type =</span> <span class="fu">factor</span>(day_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Weekend"</span>, <span class="st">"Weekday"</span>))</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot diverging bar chart</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(top_diff_data, <span class="fu">aes</span>(<span class="at">x =</span> ridership_direction, <span class="at">y =</span> Station, <span class="at">fill =</span> day_type)) <span class="sc">+</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekday"</span> <span class="ot">=</span> primary_color, <span class="st">"Weekend"</span> <span class="ot">=</span> secondary_color), <span class="at">name =</span> <span class="st">"Day Type"</span>) <span class="sc">+</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> <span class="sc">~</span> <span class="fu">comma</span>(<span class="fu">abs</span>(.x)), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1000</span>, <span class="dv">2000</span>, <span class="dv">500</span>), <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Weekday vs Weekend Peak Hour Ridership"</span>,</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Top 25 stations with the largest difference between weekday and weekend usage"</span>,</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Average Peak Hour Ridership"</span>, <span class="at">y =</span> <span class="st">"Station"</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_metro</span>() <span class="sc">+</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>),</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">1500</span>, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="st">"Higher Weekday Usage →"</span>, <span class="at">color =</span> primary_color, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="sc">-</span><span class="dv">600</span>, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="st">"← Higher Weekend Usage"</span>, <span class="at">color =</span> secondary_color, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="fl">3.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/weekday-weekend-differential-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="weekdays-vs-weekends---stations-overall" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> Weekdays vs Weekends - Stations Overall</h1>
<p>Which stations and routes show the most consistent ridership patterns between weekdays and weekends? This analysis identifies stations and station pairs that vary the least and most between weekday and weekend usage.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get number of weekdays and weekends in the dataset</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>num_weekdays <span class="ot">&lt;-</span> <span class="fu">n_distinct</span>(hourly<span class="sc">$</span>Date[hourly<span class="sc">$</span>day_type <span class="sc">==</span> <span class="st">"Weekday"</span>])</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>num_weekends <span class="ot">&lt;-</span> <span class="fu">n_distinct</span>(hourly<span class="sc">$</span>Date[hourly<span class="sc">$</span>day_type <span class="sc">==</span> <span class="st">"Weekend"</span>])</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Station-level weekday vs weekend variation analysis</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>station_variation <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, Line, day_type) <span class="sc">%&gt;%</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">days =</span> <span class="fu">if_else</span>(day_type <span class="sc">==</span> <span class="st">"Weekday"</span>, num_weekdays, num_weekends),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_per_day =</span> total_ridership <span class="sc">/</span> days</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, Line, day_type, avg_per_day) <span class="sc">%&gt;%</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> day_type, <span class="at">values_from =</span> avg_per_day, <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Station pair-level (bidirectional) weekday vs weekend variation</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>station_pair_variation <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(From_Station <span class="sc">!=</span> To_Station) <span class="sc">%&gt;%</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">station_pair =</span> <span class="fu">ifelse</span>(From_Station <span class="sc">&lt;</span> To_Station,</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">paste</span>(From_Station, <span class="st">"↔"</span>, To_Station),</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">paste</span>(To_Station, <span class="st">"↔"</span>, From_Station)),</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure consistent ordering for bidirectional pairs</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">station_1 =</span> <span class="fu">ifelse</span>(From_Station <span class="sc">&lt;</span> To_Station, From_Station, To_Station),</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">station_2 =</span> <span class="fu">ifelse</span>(From_Station <span class="sc">&lt;</span> To_Station, To_Station, From_Station)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(station_1, station_2, station_pair, day_type) <span class="sc">%&gt;%</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">days =</span> <span class="fu">if_else</span>(day_type <span class="sc">==</span> <span class="st">"Weekday"</span>, num_weekdays, num_weekends),</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_per_day =</span> total_ridership <span class="sc">/</span> days</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(station_1, station_2, station_pair, day_type, avg_per_day) <span class="sc">%&gt;%</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> day_type, <span class="at">values_from =</span> avg_per_day, <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Export station-level analysis</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>variation_export <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">stations =</span> <span class="fu">convert_to_short_names</span>(station_variation))</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(variation_export, <span class="st">"../src/lib/data/charts/09-station-variation-analysis.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Display tables for top variations</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>station_variation <span class="sc">%&gt;%</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Difference</span><span class="st">`</span> <span class="ot">=</span> Weekday <span class="sc">-</span> Weekend) <span class="sc">%&gt;%</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, Weekday, Weekend, <span class="st">`</span><span class="at">Difference</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(<span class="st">`</span><span class="at">Difference</span><span class="st">`</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Top 15 Stations by Weekday-Weekend Ridership Difference"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small">
<caption>Top 15 Stations by Weekday-Weekend Ridership Difference</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Station</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Weekday</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Weekend</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Pattandur Agrahara</td>
<td style="text-align: right;">13412.000</td>
<td style="text-align: right;">3258.667</td>
<td style="text-align: right;">10153.333</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sri Sathya Sai Hospital</td>
<td style="text-align: right;">10633.333</td>
<td style="text-align: right;">1768.167</td>
<td style="text-align: right;">8865.167</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Trinity</td>
<td style="text-align: right;">13903.000</td>
<td style="text-align: right;">5313.833</td>
<td style="text-align: right;">8589.167</td>
</tr>
<tr class="even">
<td style="text-align: left;">Indiranagar</td>
<td style="text-align: right;">23785.583</td>
<td style="text-align: right;">16117.000</td>
<td style="text-align: right;">7668.583</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Sir M. Visvesvaraya Stn., Central College</td>
<td style="text-align: right;">13442.583</td>
<td style="text-align: right;">6665.167</td>
<td style="text-align: right;">6777.417</td>
</tr>
<tr class="even">
<td style="text-align: left;">Dr. B. R. Ambedkar Station, Vidhana Soudha</td>
<td style="text-align: right;">13528.250</td>
<td style="text-align: right;">6880.667</td>
<td style="text-align: right;">6647.583</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Krishnarajapura</td>
<td style="text-align: right;">20445.667</td>
<td style="text-align: right;">14162.167</td>
<td style="text-align: right;">6283.500</td>
</tr>
<tr class="even">
<td style="text-align: left;">Benniganahalli</td>
<td style="text-align: right;">27766.500</td>
<td style="text-align: right;">21907.167</td>
<td style="text-align: right;">5859.333</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Chickpete</td>
<td style="text-align: right;">14020.500</td>
<td style="text-align: right;">19728.500</td>
<td style="text-align: right;">-5708.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cubbon Park</td>
<td style="text-align: right;">14892.417</td>
<td style="text-align: right;">9512.000</td>
<td style="text-align: right;">5380.417</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Nallurahalli</td>
<td style="text-align: right;">9332.000</td>
<td style="text-align: right;">4311.833</td>
<td style="text-align: right;">5020.167</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kundalahalli</td>
<td style="text-align: right;">9303.500</td>
<td style="text-align: right;">4320.667</td>
<td style="text-align: right;">4982.833</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Seetharampalya</td>
<td style="text-align: right;">9995.917</td>
<td style="text-align: right;">5103.167</td>
<td style="text-align: right;">4892.750</td>
</tr>
<tr class="even">
<td style="text-align: left;">Baiyappanahalli</td>
<td style="text-align: right;">14517.167</td>
<td style="text-align: right;">9756.500</td>
<td style="text-align: right;">4760.667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Kadugodi Tree Park</td>
<td style="text-align: right;">13084.250</td>
<td style="text-align: right;">8771.167</td>
<td style="text-align: right;">4313.083</td>
</tr>
</tbody>
</table>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>station_pair_variation <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Weekday <span class="sc">+</span> Weekend <span class="sc">&gt;</span> <span class="dv">50</span>) <span class="sc">%&gt;%</span> <span class="co"># Exclude low-ridership pairs</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Difference</span><span class="st">`</span> <span class="ot">=</span> Weekday <span class="sc">-</span> Weekend) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">`</span><span class="at">Station Pair</span><span class="st">`</span> <span class="ot">=</span> station_pair, Weekday, Weekend, <span class="st">`</span><span class="at">Difference</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(<span class="st">`</span><span class="at">Difference</span><span class="st">`</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Top 15 Station Pairs by Weekday-Weekend Ridership Difference"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small">
<caption>Top 15 Station Pairs by Weekday-Weekend Ridership Difference</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Station Pair</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Weekday</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Weekend</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Kadugodi Tree Park ↔︎ Sri Sathya Sai Hospital</td>
<td style="text-align: right;">5584.833</td>
<td style="text-align: right;">440.3333</td>
<td style="text-align: right;">5144.500</td>
</tr>
<tr class="even">
<td style="text-align: left;">Chickpete ↔︎ Nadaprabhu Kempegowda Station, Majestic</td>
<td style="text-align: right;">1916.167</td>
<td style="text-align: right;">4229.6667</td>
<td style="text-align: right;">-2313.500</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Kadugodi Tree Park ↔︎ Pattandur Agrahara</td>
<td style="text-align: right;">2516.917</td>
<td style="text-align: right;">574.3333</td>
<td style="text-align: right;">1942.583</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sri Sathya Sai Hospital ↔︎ Whitefield (Kadugodi)</td>
<td style="text-align: right;">2519.750</td>
<td style="text-align: right;">922.3333</td>
<td style="text-align: right;">1597.417</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Benniganahalli ↔︎ Indiranagar</td>
<td style="text-align: right;">3580.667</td>
<td style="text-align: right;">2146.3333</td>
<td style="text-align: right;">1434.333</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mahalakshmi ↔︎ Nadaprabhu Kempegowda Station, Majestic</td>
<td style="text-align: right;">1302.583</td>
<td style="text-align: right;">2719.3333</td>
<td style="text-align: right;">-1416.750</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Pattandur Agrahara ↔︎ Whitefield (Kadugodi)</td>
<td style="text-align: right;">2001.583</td>
<td style="text-align: right;">589.6667</td>
<td style="text-align: right;">1411.917</td>
</tr>
<tr class="even">
<td style="text-align: left;">Benniganahalli ↔︎ Pattandur Agrahara</td>
<td style="text-align: right;">1589.000</td>
<td style="text-align: right;">261.0000</td>
<td style="text-align: right;">1328.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Krishnarajapura ↔︎ Pattandur Agrahara</td>
<td style="text-align: right;">1486.167</td>
<td style="text-align: right;">272.5000</td>
<td style="text-align: right;">1213.667</td>
</tr>
<tr class="even">
<td style="text-align: left;">Benniganahalli ↔︎ Kundalahalli</td>
<td style="text-align: right;">1700.250</td>
<td style="text-align: right;">501.0000</td>
<td style="text-align: right;">1199.250</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Dr. B. R. Ambedkar Station, Vidhana Soudha ↔︎ Sir M. Visvesvaraya Stn., Central College</td>
<td style="text-align: right;">1434.250</td>
<td style="text-align: right;">271.5000</td>
<td style="text-align: right;">1162.750</td>
</tr>
<tr class="even">
<td style="text-align: left;">Halasuru ↔︎ Mahatma Gandhi Road</td>
<td style="text-align: right;">2713.417</td>
<td style="text-align: right;">1638.8333</td>
<td style="text-align: right;">1074.583</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Benniganahalli ↔︎ Nallurahalli</td>
<td style="text-align: right;">1556.417</td>
<td style="text-align: right;">488.8333</td>
<td style="text-align: right;">1067.583</td>
</tr>
<tr class="even">
<td style="text-align: left;">Baiyappanahalli ↔︎ Trinity</td>
<td style="text-align: right;">1534.750</td>
<td style="text-align: right;">485.0000</td>
<td style="text-align: right;">1049.750</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Benniganahalli ↔︎ Sri Sathya Sai Hospital</td>
<td style="text-align: right;">1191.750</td>
<td style="text-align: right;">160.6667</td>
<td style="text-align: right;">1031.083</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
<section id="average-travel-distance" class="level1" data-number="14">
<h1 data-number="14"><span class="header-section-number">14</span> Average Travel Distance</h1>
<p>Analyzing the average number of stations travelled by commuters at each station. Commuters from city periphery stations travel longer distances on average (and spend more on metro), compared to city center stations.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define station orders for distance calculation</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>purple_line_stations <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Whitefield (Kadugodi)"</span>, <span class="st">"Hopefarm Channasandra"</span>, <span class="st">"Kadugodi Tree Park"</span>, <span class="st">"Pattandur Agrahara"</span>, <span class="st">"Sri Sathya Sai Hospital"</span>, <span class="st">"Nallurahalli"</span>, <span class="st">"Kundalahalli"</span>, <span class="st">"Seetharampalya"</span>, <span class="st">"Hoodi"</span>, <span class="st">"Garudacharpalya"</span>, <span class="st">"Singayyanapalya"</span>, <span class="st">"Krishnarajapura"</span>, <span class="st">"Benniganahalli"</span>, <span class="st">"Baiyappanahalli"</span>, <span class="st">"Swami Vivekananda Road"</span>, <span class="st">"Indiranagar"</span>, <span class="st">"Halasuru"</span>, <span class="st">"Trinity"</span>, <span class="st">"Mahatma Gandhi Road"</span>, <span class="st">"Cubbon Park"</span>, <span class="st">"Dr. B. R. Ambedkar Station, Vidhana Soudha"</span>, <span class="st">"Sir M. Visvesvaraya Stn., Central College"</span>, <span class="st">"Nadaprabhu Kempegowda Station, Majestic"</span>, <span class="st">"Krantivira Sangolli Rayanna Railway Station"</span>, <span class="st">"Magadi Road"</span>, <span class="st">"Sri Balagangadharanatha Swamiji Station, Hosahalli"</span>, <span class="st">"Vijayanagar"</span>, <span class="st">"Attiguppe"</span>, <span class="st">"Deepanjali Nagar"</span>, <span class="st">"Mysore Road"</span>, <span class="st">"Pantharapalya - Nayandahalli"</span>, <span class="st">"Rajarajeshwari Nagar"</span>, <span class="st">"Jnanabharathi"</span>, <span class="st">"Pattanagere"</span>, <span class="st">"Kengeri Bus Terminal"</span>, <span class="st">"Kengeri"</span>, <span class="st">"Challaghatta"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>green_line_stations <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Silk Institute"</span>, <span class="st">"Thalaghattapura"</span>, <span class="st">"Vajarahalli"</span>, <span class="st">"Doddakallasandra"</span>, <span class="st">"Konanakunte Cross"</span>, <span class="st">"Yelachenahalli"</span>, <span class="st">"Jaya Prakash Nagar"</span>, <span class="st">"Banashankari"</span>, <span class="st">"Rashtreeya Vidyalaya Road"</span>, <span class="st">"Jayanagar"</span>, <span class="st">"South End Circle"</span>, <span class="st">"Lalbagh"</span>, <span class="st">"National College"</span>, <span class="st">"Krishna Rajendra Market"</span>, <span class="st">"Chickpete"</span>, <span class="st">"Nadaprabhu Kempegowda Station, Majestic"</span>, <span class="st">"Mantri Square Sampige Road"</span>, <span class="st">"Srirampura"</span>, <span class="st">"Mahakavi Kuvempu Road"</span>, <span class="st">"Rajajinagar"</span>, <span class="st">"Mahalakshmi"</span>, <span class="st">"Sandal Soap Factory"</span>, <span class="st">"Yeshwantpur"</span>, <span class="st">"Goraguntepalya"</span>, <span class="st">"Peenya"</span>, <span class="st">"Peenya Industry"</span>, <span class="st">"Jalahalli"</span>, <span class="st">"Dasarahalli"</span>, <span class="st">"Nagasandra"</span>, <span class="st">"Manjunathanagara"</span>, <span class="st">"Chikkabidarakallu"</span>, <span class="st">"Madavara"</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>yellow_line_stations <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Rashtreeya Vidyalaya Road"</span>, <span class="st">"Ragigudda"</span>, <span class="st">"Jayadeva Hospital"</span>, <span class="st">"BTM Layout"</span>, <span class="st">"Central Silk Board"</span>, <span class="st">"Bommanahalli"</span>, <span class="st">"Hongasandra"</span>, <span class="st">"Kudlu Gate"</span>, <span class="st">"Singasandra"</span>, <span class="st">"Hosa Road"</span>, <span class="st">"Beratena Agrahara"</span>, <span class="st">"Electronic City"</span>, <span class="st">"Infosys Foundation Konappana Agrahara"</span>, <span class="st">"Huskur Road"</span>, <span class="st">"Biocon Hebbagodi"</span>, <span class="st">"Delta Electronics Bommasandra"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>station_positions <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Purple =</span> <span class="fu">setNames</span>(<span class="fu">seq_along</span>(purple_line_stations), purple_line_stations),</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Green =</span> <span class="fu">setNames</span>(<span class="fu">seq_along</span>(green_line_stations), green_line_stations),</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Yellow =</span> <span class="fu">setNames</span>(<span class="fu">seq_along</span>(yellow_line_stations), yellow_line_stations)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate stations travelled (shortest path on the network)</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>calculate_stations_travelled <span class="ot">&lt;-</span> <span class="cf">function</span>(origin, destination, origin_line, dest_line) {</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle same station case</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (origin <span class="sc">==</span> destination) {</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define interchange stations</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  majestic <span class="ot">&lt;-</span> <span class="st">"Nadaprabhu Kempegowda Station, Majestic"</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  rvr <span class="ot">&lt;-</span> <span class="st">"Rashtreeya Vidyalaya Road"</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Map Black line stations to their physical lines for distance calculation</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  map_physical_line <span class="ot">&lt;-</span> <span class="cf">function</span>(station, line) {</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (line <span class="sc">==</span> <span class="st">"Black"</span>) {</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (station <span class="sc">==</span> majestic) <span class="fu">return</span>(<span class="st">"Purple"</span>)</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (station <span class="sc">==</span> rvr) <span class="fu">return</span>(<span class="st">"Green"</span>)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(line)</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Map lines to physical lines</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  origin_physical_line <span class="ot">&lt;-</span> <span class="fu">map_physical_line</span>(origin, origin_line)</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  dest_physical_line <span class="ot">&lt;-</span> <span class="fu">map_physical_line</span>(destination, dest_line)</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Same line travel (using physical lines)</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> dest_physical_line) {</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Purple"</span>) {</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">abs</span>(station_positions<span class="sc">$</span>Purple[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Purple[origin]))</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Green"</span>) {</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[origin]))</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Yellow"</span>) {</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">abs</span>(station_positions<span class="sc">$</span>Yellow[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Yellow[origin]))</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cross-line travel - need to find optimal interchange</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>  min_distance <span class="ot">&lt;-</span> <span class="cn">Inf</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try Majestic interchange (Purple-Green)</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((origin_physical_line <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Purple"</span>, <span class="st">"Green"</span>)) <span class="sc">&amp;&amp;</span> (dest_physical_line <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Purple"</span>, <span class="st">"Green"</span>))) {</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Purple"</span>) {</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>      dist_to_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Purple[majestic] <span class="sc">-</span> station_positions<span class="sc">$</span>Purple[origin])</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>      dist_from_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[majestic])</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>      dist_to_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[majestic] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[origin])</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>      dist_from_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Purple[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Purple[majestic])</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>    min_distance <span class="ot">&lt;-</span> <span class="fu">min</span>(min_distance, dist_to_majestic <span class="sc">+</span> dist_from_majestic)</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try RVR interchange (Green-Yellow)</span></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((origin_physical_line <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Green"</span>, <span class="st">"Yellow"</span>)) <span class="sc">&amp;&amp;</span> (dest_physical_line <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Green"</span>, <span class="st">"Yellow"</span>))) {</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Green"</span>) {</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>      dist_to_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[rvr] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[origin])</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>      dist_from_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Yellow[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Yellow[rvr])</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>      dist_to_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Yellow[rvr] <span class="sc">-</span> station_positions<span class="sc">$</span>Yellow[origin])</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>      dist_from_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[rvr])</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>    min_distance <span class="ot">&lt;-</span> <span class="fu">min</span>(min_distance, dist_to_rvr <span class="sc">+</span> dist_from_rvr)</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Purple to Yellow via Majestic + RVR</span></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((origin_physical_line <span class="sc">==</span> <span class="st">"Purple"</span> <span class="sc">&amp;&amp;</span> dest_physical_line <span class="sc">==</span> <span class="st">"Yellow"</span>) <span class="sc">||</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Yellow"</span> <span class="sc">&amp;&amp;</span> dest_physical_line <span class="sc">==</span> <span class="st">"Purple"</span>)) {</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Purple"</span>) {</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>      dist_to_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Purple[majestic] <span class="sc">-</span> station_positions<span class="sc">$</span>Purple[origin])</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>      dist_majestic_to_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[rvr] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[majestic])</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>      dist_from_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Yellow[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Yellow[rvr])</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>      dist_to_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Yellow[rvr] <span class="sc">-</span> station_positions<span class="sc">$</span>Yellow[origin])</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>      dist_rvr_to_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[majestic] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[rvr])</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>      dist_from_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Purple[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Purple[majestic])</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>      dist_to_majestic <span class="ot">&lt;-</span> dist_to_rvr <span class="sc">+</span> dist_rvr_to_majestic</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>      dist_majestic_to_rvr <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>      dist_from_rvr <span class="ot">&lt;-</span> dist_from_majestic</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>    min_distance <span class="ot">&lt;-</span> <span class="fu">min</span>(min_distance, dist_to_majestic <span class="sc">+</span> dist_majestic_to_rvr <span class="sc">+</span> dist_from_rvr)</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(min_distance)</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate weighted average travel distance for each station</span></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>station_travel_analysis <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">distinct</span>(hourly, Station, Line), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"From_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Origin_Line =</span> Line) <span class="sc">%&gt;%</span></span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">distinct</span>(hourly, Station, Line), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"To_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Dest_Line =</span> Line) <span class="sc">%&gt;%</span></span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Origin_Line), <span class="sc">!</span><span class="fu">is.na</span>(Dest_Line)) <span class="sc">%&gt;%</span></span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stations_travelled =</span> <span class="fu">calculate_stations_travelled</span>(From_Station, To_Station, Origin_Line, Dest_Line)) <span class="sc">%&gt;%</span></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_stations_travelled =</span> <span class="fu">weighted.mean</span>(stations_travelled, Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(From_Station, Origin_Line)</span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(avg_stations_travelled <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_stations_travelled))</span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Export data for web interface</span></span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a>travel_distance_export <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">station_averages =</span> <span class="fu">convert_to_short_names</span>(station_travel_analysis))</span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(travel_distance_export, <span class="st">"../src/lib/data/charts/11-average-travel-distance.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a>travel_time_selected <span class="ot">&lt;-</span> travel_distance_export<span class="sc">$</span>station_averages <span class="sc">%&gt;%</span></span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(From_Station <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Madavara"</span>, <span class="st">"Halasuru"</span>))</span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(<span class="fu">list</span>(<span class="at">station_averages =</span> travel_time_selected), <span class="st">"../src/lib/data/charts/11-travel-time-selected.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a>travel_distance_export<span class="sc">$</span>station_averages <span class="sc">%&gt;%</span></span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">Station =</span> From_Station, <span class="at">Line =</span> Origin_Line, <span class="st">`</span><span class="at">Trip Length (stations)</span><span class="st">`</span> <span class="ot">=</span> avg_stations_travelled) <span class="sc">%&gt;%</span></span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Average Trip Length by Origin Station"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover table-condensed caption-top table-sm small">
<caption>Average Trip Length by Origin Station</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Station</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Line</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Trip Length (stations)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Madavara</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">18.318033</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bommasandra</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">18.168083</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Kengeri</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">18.133553</td>
</tr>
<tr class="even">
<td style="text-align: left;">Challaghatta</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">17.219071</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Kengeri Bus Terminal</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">16.206533</td>
</tr>
<tr class="even">
<td style="text-align: left;">Hopefarm Channasandra</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">16.027048</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Hebbagodi</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">16.001832</td>
</tr>
<tr class="even">
<td style="text-align: left;">Nagasandra</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">15.965496</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Chikkabidarakallu</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">15.814025</td>
</tr>
<tr class="even">
<td style="text-align: left;">Silk Institute</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">15.376101</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Konappana Agrahara</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">15.336117</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pattandur Agrahara</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">15.188164</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Jnanabharathi</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">15.017945</td>
</tr>
<tr class="even">
<td style="text-align: left;">Whitefield (Kadugodi)</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">14.829962</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Pattanagere</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">14.452997</td>
</tr>
<tr class="even">
<td style="text-align: left;">Manjunathanagara</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">14.369237</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Dasarahalli</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">14.225490</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mysore Road</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">14.156109</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Huskur Road</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">13.947501</td>
</tr>
<tr class="even">
<td style="text-align: left;">RR Nagar</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">13.933226</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Jalahalli</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">13.868533</td>
</tr>
<tr class="even">
<td style="text-align: left;">Thalaghattapura</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">13.516886</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Electronic City</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">13.410300</td>
</tr>
<tr class="even">
<td style="text-align: left;">Doddakallasandra</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">13.212075</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Seetharampalya</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">13.209974</td>
</tr>
<tr class="even">
<td style="text-align: left;">Nallurahalli</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">13.180427</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Kundalahalli</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">13.150757</td>
</tr>
<tr class="even">
<td style="text-align: left;">Peenya Industry</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">12.980126</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Kadugodi Tree Park</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">12.961417</td>
</tr>
<tr class="even">
<td style="text-align: left;">Peenya</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">12.675326</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Vajarahalli</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">12.613190</td>
</tr>
<tr class="even">
<td style="text-align: left;">Hosa Road</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">12.586739</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Yelachenahalli</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">12.241598</td>
</tr>
<tr class="even">
<td style="text-align: left;">Konanakunte Cross</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">12.139961</td>
</tr>
<tr class="odd">
<td style="text-align: left;">JP Nagar</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">11.926389</td>
</tr>
<tr class="even">
<td style="text-align: left;">Yeshwantpur</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">11.390557</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Deepanjali Nagar</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">11.324541</td>
</tr>
<tr class="even">
<td style="text-align: left;">Singasandra</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">11.319291</td>
</tr>
<tr class="odd">
<td style="text-align: left;">KR Pura</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">11.174772</td>
</tr>
<tr class="even">
<td style="text-align: left;">Hoodi</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">11.107346</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Goraguntepalya</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">10.873059</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sri Sathya Sai Hospital</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">10.849163</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RV Road</td>
<td style="text-align: left;">Black</td>
<td style="text-align: right;">10.847466</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kudlu Gate</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">10.815676</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Benniganahalli</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">10.733026</td>
</tr>
<tr class="even">
<td style="text-align: left;">Banashankari</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">10.641094</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Sandal Soap Factory</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">10.577654</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bommanahalli</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">10.557306</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Nayandahalli</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">10.370858</td>
</tr>
<tr class="even">
<td style="text-align: left;">Mahalakshmi</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">10.326264</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Silk Board</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">10.274344</td>
</tr>
<tr class="even">
<td style="text-align: left;">BTM Layout</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">10.109569</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Jayanagar</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">10.065463</td>
</tr>
<tr class="even">
<td style="text-align: left;">Attiguppe</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">10.027482</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Jayadeva Hospital</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">10.007712</td>
</tr>
<tr class="even">
<td style="text-align: left;">Swami Vivekananda Road</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">9.968105</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Hongasandra</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">9.803566</td>
</tr>
<tr class="even">
<td style="text-align: left;">Baiyappanahalli</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">9.655835</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Lalbagh</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">9.538695</td>
</tr>
<tr class="even">
<td style="text-align: left;">Vijayanagara</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">9.493056</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Garudacharpalya</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">9.466842</td>
</tr>
<tr class="even">
<td style="text-align: left;">Beratena Agrahara</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">9.451065</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Rajajinagar</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">9.429973</td>
</tr>
<tr class="even">
<td style="text-align: left;">Hosahalli</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">9.112417</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Indiranagar</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">9.100586</td>
</tr>
<tr class="even">
<td style="text-align: left;">South End Circle</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">9.085347</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ragigudda</td>
<td style="text-align: left;">Yellow</td>
<td style="text-align: right;">9.025700</td>
</tr>
<tr class="even">
<td style="text-align: left;">Trinity</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">8.923230</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Singayyanapalya</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">8.718092</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cubbon Park</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">8.521418</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MG Road</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">8.488166</td>
</tr>
<tr class="even">
<td style="text-align: left;">National College</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">8.476627</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MKK Road</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">8.393956</td>
</tr>
<tr class="even">
<td style="text-align: left;">Majestic</td>
<td style="text-align: left;">Black</td>
<td style="text-align: right;">8.373717</td>
</tr>
<tr class="odd">
<td style="text-align: left;">KSR Railway Station</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">8.332015</td>
</tr>
<tr class="even">
<td style="text-align: left;">Srirampura</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">8.101633</td>
</tr>
<tr class="odd">
<td style="text-align: left;">KR Market</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">7.869279</td>
</tr>
<tr class="even">
<td style="text-align: left;">Magadi Road</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">7.760953</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Mantri Square</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">7.760831</td>
</tr>
<tr class="even">
<td style="text-align: left;">Chickpete</td>
<td style="text-align: left;">Green</td>
<td style="text-align: right;">7.613030</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Vidhana Soudha</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">7.507872</td>
</tr>
<tr class="even">
<td style="text-align: left;">Central College</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">7.423647</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Halasuru</td>
<td style="text-align: left;">Purple</td>
<td style="text-align: right;">6.642569</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
<section id="land-use" class="level1" data-number="15">
<h1 data-number="15"><span class="header-section-number">15</span> Land use</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>input_raster_path <span class="ot">&lt;-</span> <span class="st">"built-up-volume/built-up-volume.tif"</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>output_geojson_path <span class="ot">&lt;-</span> <span class="st">"../src/lib/data/charts/12-built_up_volume_hex.json"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load raster, set 0 to NA, and create a hex grid</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>commercial_built_volume <span class="ot">&lt;-</span> <span class="fu">rast</span>(input_raster_path)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>commercial_built_volume[commercial_built_volume <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>hex_grid <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(commercial_built_volume, <span class="at">cellsize =</span> <span class="fl">0.009</span>, <span class="at">square =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>()</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract mean raster values for each hex cell</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>hex_grid<span class="sc">$</span>mean_volume <span class="ot">&lt;-</span> <span class="fu">exact_extract</span>(commercial_built_volume, hex_grid, <span class="at">fun =</span> <span class="st">"mean"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |                                                                      |   1%
  |                                                                            
  |=                                                                     |   1%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |==                                                                    |   2%
  |                                                                            
  |==                                                                    |   3%
  |                                                                            
  |==                                                                    |   4%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |===                                                                   |   5%
  |                                                                            
  |====                                                                  |   5%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |=====                                                                 |   8%
  |                                                                            
  |======                                                                |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |=======                                                               |  11%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |========                                                              |  12%
  |                                                                            
  |=========                                                             |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |=========                                                             |  14%
  |                                                                            
  |==========                                                            |  14%
  |                                                                            
  |==========                                                            |  15%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |============                                                          |  16%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |============                                                          |  18%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |==============                                                        |  19%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |==============                                                        |  21%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |===============                                                       |  22%
  |                                                                            
  |================                                                      |  22%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |================                                                      |  24%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |=================                                                     |  25%
  |                                                                            
  |==================                                                    |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |===================                                                   |  28%
  |                                                                            
  |====================                                                  |  28%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  29%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |=====================                                                 |  31%
  |                                                                            
  |======================                                                |  31%
  |                                                                            
  |======================                                                |  32%
  |                                                                            
  |=======================                                               |  32%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |=======================                                               |  34%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |========================                                              |  35%
  |                                                                            
  |=========================                                             |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |==========================                                            |  38%
  |                                                                            
  |===========================                                           |  38%
  |                                                                            
  |===========================                                           |  39%
  |                                                                            
  |============================                                          |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |============================                                          |  41%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |==============================                                        |  44%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |===============================                                       |  45%
  |                                                                            
  |================================                                      |  45%
  |                                                                            
  |================================                                      |  46%
  |                                                                            
  |=================================                                     |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |=================================                                     |  48%
  |                                                                            
  |==================================                                    |  48%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |===================================                                   |  49%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |===================================                                   |  51%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |====================================                                  |  52%
  |                                                                            
  |=====================================                                 |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |=====================================                                 |  54%
  |                                                                            
  |======================================                                |  54%
  |                                                                            
  |======================================                                |  55%
  |                                                                            
  |=======================================                               |  55%
  |                                                                            
  |=======================================                               |  56%
  |                                                                            
  |========================================                              |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |========================================                              |  58%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |=========================================                             |  59%
  |                                                                            
  |==========================================                            |  59%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |==========================================                            |  61%
  |                                                                            
  |===========================================                           |  61%
  |                                                                            
  |===========================================                           |  62%
  |                                                                            
  |============================================                          |  62%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |============================================                          |  64%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |=============================================                         |  65%
  |                                                                            
  |==============================================                        |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |===============================================                       |  68%
  |                                                                            
  |================================================                      |  68%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |=================================================                     |  71%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |==================================================                    |  72%
  |                                                                            
  |===================================================                   |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |===================================================                   |  74%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |====================================================                  |  75%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  76%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |======================================================                |  78%
  |                                                                            
  |=======================================================               |  78%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |========================================================              |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |========================================================              |  81%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |==========================================================            |  82%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |==========================================================            |  84%
  |                                                                            
  |===========================================================           |  84%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |============================================================          |  85%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  86%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |==============================================================        |  88%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |===============================================================       |  91%
  |                                                                            
  |================================================================      |  91%
  |                                                                            
  |================================================================      |  92%
  |                                                                            
  |=================================================================     |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |=================================================================     |  94%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |==================================================================    |  95%
  |                                                                            
  |===================================================================   |  95%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |====================================================================  |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |====================================================================  |  98%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |===================================================================== |  99%
  |                                                                            
  |======================================================================|  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>hex_summary_filtered <span class="ot">&lt;-</span> hex_grid[<span class="sc">!</span><span class="fu">is.na</span>(hex_grid<span class="sc">$</span>mean_volume), ]</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Write to GeoJSON</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(hex_summary_filtered, output_geojson_path, <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>, <span class="at">driver =</span> <span class="st">"GeoJSON"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Deleting source `../src/lib/data/charts/12-built_up_volume_hex.json' using driver `GeoJSON'
Writing layer `12-built_up_volume_hex' to data source 
  `../src/lib/data/charts/12-built_up_volume_hex.json' using driver `GeoJSON'
Writing 1732 features with 1 fields and geometry type Polygon.</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a quick visualization</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">pretty</span>(hex_summary_filtered<span class="sc">$</span>mean_volume, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">hcl.colors</span>(<span class="fu">length</span>(breaks) <span class="sc">-</span> <span class="dv">1</span>, <span class="st">"viridis"</span>, <span class="at">rev =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hex_summary_filtered[<span class="st">"mean_volume"</span>], <span class="at">main =</span> <span class="st">"Built-up Volume Aggregated into Hexagons"</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">breaks =</span> breaks, <span class="at">pal =</span> pal, <span class="at">key.pos =</span> <span class="dv">4</span>, <span class="at">lwd =</span> <span class="fl">0.1</span>, <span class="at">border =</span> <span class="cn">NA</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/landuse-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="network-analysis" class="level1" data-number="16">
<h1 data-number="16"><span class="header-section-number">16</span> Network Analysis</h1>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Network Analysis (Corrected Final Version) ---</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Calculate Station Importance (using short names)</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>station_importance <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">convert_to_short_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(Station, <span class="at">wt =</span> Ridership, <span class="at">name =</span> <span class="st">"total_ridership"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">id =</span> Station)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Calculate Hybrid Top Links using consistent short names</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># The `metro_stations` table from your data prep chunk already has short names and line info</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>line_info <span class="ot">&lt;-</span> metro_stations <span class="sc">%&gt;%</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, line)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a base table of all links, converting to short names immediately</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>all_links_with_lines <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(From_Station, To_Station, <span class="at">wt =</span> Ridership, <span class="at">name =</span> <span class="st">"Ridership"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">convert_to_short_names</span>() <span class="sc">%&gt;%</span> <span class="co"># This ensures all names are short and consistent</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_log_odds</span>(<span class="at">set =</span> From_Station, <span class="at">feature =</span> To_Station, <span class="at">n =</span> Ridership) <span class="sc">%&gt;%</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(line_info, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"From_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">from_line =</span> line) <span class="sc">%&gt;%</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(line_info, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"To_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">to_line =</span> line) <span class="sc">%&gt;%</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(from_line), <span class="sc">!</span><span class="fu">is.na</span>(to_line)) <span class="sc">%&gt;%</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_interline =</span> (from_line <span class="sc">!=</span> to_line))</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the hybrid set of top links</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>top_links <span class="ot">&lt;-</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Top 8 intra-line (same-line) links</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    all_links_with_lines <span class="sc">%&gt;%</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span>is_interline, Ridership <span class="sc">&gt;</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(From_Station) <span class="sc">%&gt;%</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_max</span>(<span class="at">order_by =</span> log_odds_weighted, <span class="at">n =</span> <span class="dv">8</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>),</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Top 3 inter-line (cross-line) links</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    all_links_with_lines <span class="sc">%&gt;%</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(is_interline, Ridership <span class="sc">&gt;</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(From_Station) <span class="sc">%&gt;%</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_max</span>(<span class="at">order_by =</span> log_odds_weighted, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>)</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(From_Station, To_Station, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Prepare Nodes and Links for D3 Export</span></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>links_for_graph <span class="ot">&lt;-</span> top_links <span class="sc">%&gt;%</span></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(From_Station, To_Station, <span class="at">value =</span> log_odds_weighted)</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>nodes_final <span class="ot">&lt;-</span> {</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>  base_nodes <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="fu">unique</span>(<span class="fu">c</span>(links_for_graph<span class="sc">$</span>From_Station, links_for_graph<span class="sc">$</span>To_Station))) <span class="sc">%&gt;%</span></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(line_info, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, <span class="at">group =</span> line) <span class="sc">%&gt;%</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">str_to_title</span>(<span class="fu">coalesce</span>(group, <span class="st">"Unknown"</span>)))</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_graph</span>(<span class="at">nodes =</span> base_nodes, <span class="at">edges =</span> links_for_graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">betweenness =</span> <span class="fu">centrality_betweenness</span>(<span class="at">weights =</span> value <span class="sc">-</span> <span class="fu">min</span>(value) <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(station_importance, <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">total_ridership =</span> <span class="fu">coalesce</span>(total_ridership, <span class="dv">0</span>L))</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>links_final_indexed <span class="ot">&lt;-</span> {</span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>  station_indices <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(nodes_final)) <span class="sc">-</span> <span class="dv">1</span>, nodes_final<span class="sc">$</span>id)</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>  links_for_graph <span class="sc">%&gt;%</span></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">source =</span> station_indices[From_Station],</span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">target =</span> station_indices[To_Station]</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(source), <span class="sc">!</span><span class="fu">is.na</span>(target)) <span class="sc">%&gt;%</span></span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(source, target, value) <span class="sc">%&gt;%</span></span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">pmap</span>(<span class="sc">~</span><span class="fu">c</span>(...)) <span class="sc">%&gt;%</span></span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unname</span>()</span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Export to JSON</span></span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>d3_network_output <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">nodes =</span> nodes_final,</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">links =</span> links_final_indexed</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(</span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>  d3_network_output,</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>  <span class="st">"../src/lib/data/charts/metro-network-final.json"</span>,</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">pretty =</span> <span class="cn">FALSE</span>,</span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">auto_unbox =</span> <span class="cn">TRUE</span></span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(</span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Successfully exported refined D3 network data.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Exported"</span>, <span class="fu">nrow</span>(nodes_final), <span class="st">"stations and"</span>, <span class="fu">length</span>(links_final_indexed), <span class="st">"connections.</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Successfully exported refined D3 network data.
 Exported 83 stations and 900 connections.</code></pre>
</div>
</div>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "How Bangalore Uses The Metro"</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: "Aman Bhargava"</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: "Vivek Matthew"</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "last-modified"</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="an">logo:</span><span class="co"> "quarto-assets/logo.png"</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">    theme:</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co">      - quarto-assets/styles.scss</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">    template-partials:</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">      - quarto-assets/title-block.html</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-float: true</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Show the code"</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: kable</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;style&gt;</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="in">@import url('https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&amp;display=swap');</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="in">body {</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="in">  font-family: 'Atkinson Hyperlegible', sans-serif;</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a><span class="in">  background-color: var(--color-sepia);</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="in">  color: var(--color-sepia-brown);</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="in">  line-height: 1.6;</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="in">  max-width: 1200px;</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="in">  margin: 0 auto;</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="in">  padding: 2rem;</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="in">.highlight-box {</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="in">  background-color: #f8f9fa;</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="in">  border-left: 4px solid #007bff;</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a><span class="in">  padding: 1rem;</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a><span class="in">  margin: 1rem 0;</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a><span class="in">  border-radius: 0 4px 4px 0;</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/style&gt;</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gganimate)</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggraph)</span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggnewscale)</span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wesanderson)</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidylo)</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidygraph)</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(exactextractr)</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Global options</span></span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">kable_styling_bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>, <span class="st">"condensed"</span>))</span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.width =</span> <span class="dv">12</span>,</span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.height =</span> <span class="dv">8</span>,</span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.align =</span> <span class="st">"center"</span>,</span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">out.width =</span> <span class="st">"100%"</span>,</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>  <span class="at">warning =</span> <span class="cn">FALSE</span>,</span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">message =</span> <span class="cn">FALSE</span></span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Colors and Themes</span></span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>wes_colors <span class="ot">&lt;-</span> <span class="fu">wes_palette</span>(<span class="st">"Darjeeling1"</span>, <span class="dv">8</span>, <span class="at">type =</span> <span class="st">"continuous"</span>)</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>primary_color <span class="ot">&lt;-</span> <span class="st">"#3182bd"</span></span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>secondary_color <span class="ot">&lt;-</span> <span class="st">"#de77ae"</span></span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a>tertiary_color <span class="ot">&lt;-</span> <span class="st">"#2c7fb8"</span></span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a>theme_metro <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_family =</span> <span class="st">"sans"</span>) <span class="sc">+</span></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">20</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">8</span>)),</span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>, <span class="at">color =</span> <span class="st">"gray40"</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">15</span>)),</span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">color =</span> <span class="st">"gray20"</span>),</span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"none"</span></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to add temporal features (DRY)</span></span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a>add_temporal_features <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>      <span class="at">wday =</span> <span class="fu">wday</span>(Date, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">week_start =</span> <span class="dv">1</span>),</span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>      <span class="at">day_type =</span> <span class="fu">if_else</span>(wday <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sat"</span>, <span class="st">"Sun"</span>), <span class="st">"Weekend"</span>, <span class="st">"Weekday"</span>),</span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a>      <span class="at">peak_category =</span> <span class="fu">case_when</span>(</span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>        day_type <span class="sc">==</span> <span class="st">"Weekday"</span> <span class="sc">&amp;</span> Hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>) <span class="sc">~</span> <span class="st">"Morning Peak"</span>,</span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>        day_type <span class="sc">==</span> <span class="st">"Weekday"</span> <span class="sc">&amp;</span> Hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">17</span>, <span class="dv">18</span>, <span class="dv">19</span>) <span class="sc">~</span> <span class="st">"Evening Peak"</span>,</span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Off-Peak"</span></span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and preprocess data</span></span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a>hourly <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="st">"data/station-hourly.csv"</span>, <span class="at">delim =</span> <span class="st">";"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_temporal_features</span>()</span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a>station_pair_hourly <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="st">"data/stationpair-hourly.csv"</span>, <span class="at">delim =</span> <span class="st">";"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">To_Station =</span> <span class="st">`</span><span class="at">Destination Station</span><span class="st">`</span>, <span class="at">From_Station =</span> <span class="st">`</span><span class="at">Origin Station</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.Date</span>(Date)) <span class="sc">%&gt;%</span></span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_temporal_features</span>()</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>metro_geojson <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"data/metro.geojson"</span>)</span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction</span></span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a>This analysis is based on ridership data obtained through a Right to Information (RTI) request to BMRCL. The RTI request sought basic ridership information between stations. However, BMRCL's response provided **station-pairwise hourly ridership between every station pair over 19 days**<span class="sc">\!</span> A treat.</span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a>The dataset contains over **1.2 million rows** of ridership data, covering a particularly interesting period that includes the opening of the new Yellow Line.</span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questions</span></span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>How popular is your specific daily commute compared to other routes?</span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Which stations experience the heaviest traffic during morning and evening rush hours?</span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>How does ridership vary by day of the week, time of day?</span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>What are the most popular travel corridors within the metro network?</span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>Do certain stations show dramatically different usage patterns between weekdays and weekends?</span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a><span class="ss">6.  </span>How has the Yellow Line impacted ridership on existing stations in the metro network?</span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a><span class="ss">7.  </span>What is the length of an average commute, and how does it vary across stations?</span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a><span class="ss">8.  </span>Have their been particular instances of unusual spikes in traffic due to events in the city?</span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a><span class="fu">## Dataset Overview</span></span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a>Our analysis uses multiple data sources:</span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Station-level hourly ridership**: Passenger counts by station and hour</span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Station-pair hourly data**: Origin-destination flows with temporal granularity</span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Spatial data from OpenStreetMap for mapping locations and additional metadata</span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a>Let's begin by examining the structure of our datasets:</span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a><span class="in">```{r preview-data}</span></span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>) <span class="co"># For reproducible sampling</span></span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a>sample_ridership_data <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Ridership <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_n</span>(<span class="dv">15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Ridership)) <span class="sc">%&gt;%</span></span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.character</span>(Date))</span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hourly) <span class="sc">%&gt;%</span></span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Sample of Hourly Station Ridership Data"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(station_pair_hourly) <span class="sc">%&gt;%</span></span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Sample of Hourly Station-Pair Ridership Data"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data Preparation</span></span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a>We need to classify each station by its metro line. Namma Metro currently operates three main lines:</span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Purple Line**: The east-west corridor</span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Green Line**: The north-south corridor</span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Yellow Line**: The newest line serving south-eastern regions in the periphery</span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- end list --&gt;</span></span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a><span class="in">```{r line-classification}</span></span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract station data from GeoJSON as the single source of truth</span></span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a>metro_stations <span class="ot">&lt;-</span> metro_geojson <span class="sc">%&gt;%</span></span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">st_geometry_type</span>(.) <span class="sc">==</span> <span class="st">"POINT"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">Station =</span> name, code, <span class="at">line =</span> colour) <span class="sc">%&gt;%</span></span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(code),</span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">paste0</span>(<span class="fu">str_sub</span>(<span class="fu">str_to_upper</span>(<span class="fu">str_replace_all</span>(Station, <span class="st">"[^A-Za-z]"</span>, <span class="st">""</span>)), <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">sprintf</span>(<span class="st">"%02d"</span>, <span class="fu">row_number</span>())),</span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a>                   code)</span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(line, Station)</span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mapping from long/inconsistent names in CSV to short names in GeoJSON</span></span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a>manual_station_mapping <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>csv_name, <span class="sc">~</span>geojson_name,</span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Biocon Hebbagodi"</span>, <span class="st">"Hebbagodi"</span>,</span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Central Silk Board"</span>, <span class="st">"Silk Board"</span>,</span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Delta Electronics Bommasandra"</span>, <span class="st">"Bommasandra"</span>,</span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Dr. B. R. Ambedkar Station, Vidhana Soudha"</span>, <span class="st">"Vidhana Soudha"</span>,</span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Infosys Foundation Konappana Agrahara"</span>, <span class="st">"Konappana Agrahara"</span>,</span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Jaya Prakash Nagar"</span>, <span class="st">"JP Nagar"</span>,</span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Krantivira Sangolli Rayanna Railway Station"</span>, <span class="st">"KSR Railway Station"</span>,</span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Krishna Rajendra Market"</span>, <span class="st">"KR Market"</span>,</span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Krishnarajapura"</span>, <span class="st">"KR Pura"</span>,</span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mahakavi Kuvempu Road"</span>, <span class="st">"MKK Road"</span>,</span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mahatma Gandhi Road"</span>, <span class="st">"MG Road"</span>,</span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mantri Square Sampige Road"</span>, <span class="st">"Mantri Square"</span>,</span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Nadaprabhu Kempegowda Station, Majestic"</span>, <span class="st">"Majestic"</span>,</span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pantharapalya - Nayandahalli"</span>, <span class="st">"Nayandahalli"</span>,</span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Rajarajeshwari Nagar"</span>, <span class="st">"RR Nagar"</span>,</span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Rashtreeya Vidyalaya Road"</span>, <span class="st">"RV Road"</span>,</span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sir M. Visvesvaraya Stn., Central College"</span>, <span class="st">"Central College"</span>,</span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sri Balagangadharanatha Swamiji Station, Hosahalli"</span>, <span class="st">"Hosahalli"</span>,</span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Vijayanagar"</span>, <span class="st">"Vijayanagara"</span></span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a>all_csv_names <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(hourly<span class="sc">$</span>Station, station_pair_hourly<span class="sc">$</span>From_Station, station_pair_hourly<span class="sc">$</span>To_Station))</span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a>identity_mapping <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">csv_name =</span> <span class="fu">setdiff</span>(all_csv_names, manual_station_mapping<span class="sc">$</span>csv_name)) <span class="sc">%&gt;%</span></span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">geojson_name =</span> csv_name)</span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a>station_name_mapping <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(manual_station_mapping, identity_mapping)</span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper functions for name conversion</span></span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a>convert_to_short_names <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.data.frame</span>(data)) {</span>
<span id="cb31-237"><a href="#cb31-237" aria-hidden="true" tabindex="-1"></a>    station_cols <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(data), <span class="fu">c</span>(<span class="st">"Station"</span>, <span class="st">"From_Station"</span>, <span class="st">"To_Station"</span>))</span>
<span id="cb31-238"><a href="#cb31-238" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (col <span class="cf">in</span> station_cols) {</span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a>      data[[col]] <span class="ot">&lt;-</span> station_name_mapping<span class="sc">$</span>geojson_name[<span class="fu">match</span>(data[[col]], station_name_mapping<span class="sc">$</span>csv_name)]</span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-241"><a href="#cb31-241" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">is.list</span>(data)) {</span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">map</span>(data, convert_to_short_names)</span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a>get_short_name <span class="ot">&lt;-</span> <span class="cf">function</span>(station_name) {</span>
<span id="cb31-247"><a href="#cb31-247" aria-hidden="true" tabindex="-1"></a>  short_name <span class="ot">&lt;-</span> station_name_mapping<span class="sc">$</span>geojson_name[<span class="fu">match</span>(station_name, station_name_mapping<span class="sc">$</span>csv_name)]</span>
<span id="cb31-248"><a href="#cb31-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">ifelse</span>(<span class="fu">is.na</span>(short_name), station_name, short_name))</span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a><span class="co"># Create final map for joining and add Line info to hourly data</span></span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a>station_map <span class="ot">&lt;-</span> station_name_mapping <span class="sc">%&gt;%</span></span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(metro_stations, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"geojson_name"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-254"><a href="#cb31-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">Station =</span> csv_name, <span class="at">Line =</span> line, code) <span class="sc">%&gt;%</span></span>
<span id="cb31-255"><a href="#cb31-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Line =</span> <span class="fu">str_to_title</span>(Line)) <span class="sc">%&gt;%</span></span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line))</span>
<span id="cb31-257"><a href="#cb31-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-258"><a href="#cb31-258" aria-hidden="true" tabindex="-1"></a>hourly <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-259"><a href="#cb31-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_map, <span class="at">by =</span> <span class="st">"Station"</span>)</span>
<span id="cb31-260"><a href="#cb31-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-261"><a href="#cb31-261" aria-hidden="true" tabindex="-1"></a><span class="co"># Export data for web components</span></span>
<span id="cb31-262"><a href="#cb31-262" aria-hidden="true" tabindex="-1"></a>station_codes <span class="ot">&lt;-</span> metro_stations <span class="sc">%&gt;%</span> <span class="fu">select</span>(Station, code, line)</span>
<span id="cb31-263"><a href="#cb31-263" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(station_codes, <span class="st">"../src/lib/data/charts/station-codes.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-264"><a href="#cb31-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-265"><a href="#cb31-265" aria-hidden="true" tabindex="-1"></a>station_lines_list <span class="ot">&lt;-</span> metro_stations <span class="sc">%&gt;%</span></span>
<span id="cb31-266"><a href="#cb31-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(line) <span class="sc">%&gt;%</span></span>
<span id="cb31-267"><a href="#cb31-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">stations =</span> <span class="fu">list</span>(Station), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-268"><a href="#cb31-268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">deframe</span>()</span>
<span id="cb31-269"><a href="#cb31-269" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(<span class="fu">list</span>(<span class="at">lines =</span> station_lines_list), <span class="st">"../src/lib/data/charts/01-line-classification.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-270"><a href="#cb31-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-271"><a href="#cb31-271" aria-hidden="true" tabindex="-1"></a>ridership_sample_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-272"><a href="#cb31-272" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_data =</span> <span class="fu">convert_to_short_names</span>(sample_ridership_data) <span class="sc">%&gt;%</span></span>
<span id="cb31-273"><a href="#cb31-273" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(From_Station, To_Station, Ridership, Hour, wday, Date)</span>
<span id="cb31-274"><a href="#cb31-274" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-275"><a href="#cb31-275" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(ridership_sample_export, <span class="st">"../src/lib/data/charts/ridership-sample.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-276"><a href="#cb31-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-277"><a href="#cb31-277" aria-hidden="true" tabindex="-1"></a><span class="co"># Display station counts per line</span></span>
<span id="cb31-278"><a href="#cb31-278" aria-hidden="true" tabindex="-1"></a>station_map <span class="sc">%&gt;%</span></span>
<span id="cb31-279"><a href="#cb31-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(Line, <span class="at">name =</span> <span class="st">"Stations"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-280"><a href="#cb31-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Line =</span> <span class="fu">if_else</span>(Line <span class="sc">==</span> <span class="st">"Black"</span>, <span class="st">"Interchange"</span>, Line)) <span class="sc">%&gt;%</span></span>
<span id="cb31-281"><a href="#cb31-281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Number of stations per metro line"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-282"><a href="#cb31-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb31-283"><a href="#cb31-283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-284"><a href="#cb31-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-285"><a href="#cb31-285" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-286"><a href="#cb31-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-287"><a href="#cb31-287" aria-hidden="true" tabindex="-1"></a><span class="fu"># Exploratory Data Analysis</span></span>
<span id="cb31-288"><a href="#cb31-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-289"><a href="#cb31-289" aria-hidden="true" tabindex="-1"></a><span class="fu">## Days and Hours</span></span>
<span id="cb31-290"><a href="#cb31-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-291"><a href="#cb31-291" aria-hidden="true" tabindex="-1"></a>Understanding when people use the metro most heavily.</span>
<span id="cb31-292"><a href="#cb31-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-293"><a href="#cb31-293" aria-hidden="true" tabindex="-1"></a><span class="in">```{r basic-patterns}</span></span>
<span id="cb31-294"><a href="#cb31-294" aria-hidden="true" tabindex="-1"></a><span class="co"># Busiest days by average ridership</span></span>
<span id="cb31-295"><a href="#cb31-295" aria-hidden="true" tabindex="-1"></a>busiest_days <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-296"><a href="#cb31-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb31-297"><a href="#cb31-297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_total =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-298"><a href="#cb31-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">wday</span>(Date, <span class="at">label =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-299"><a href="#cb31-299" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(day) <span class="sc">%&gt;%</span></span>
<span id="cb31-300"><a href="#cb31-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_daily_ridership =</span> <span class="fu">mean</span>(daily_total), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-301"><a href="#cb31-301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(average_daily_ridership))</span>
<span id="cb31-302"><a href="#cb31-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-303"><a href="#cb31-303" aria-hidden="true" tabindex="-1"></a><span class="co"># Busiest hours by average ridership</span></span>
<span id="cb31-304"><a href="#cb31-304" aria-hidden="true" tabindex="-1"></a>busiest_hours <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-305"><a href="#cb31-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Hour) <span class="sc">%&gt;%</span></span>
<span id="cb31-306"><a href="#cb31-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_hourly_ridership =</span> <span class="fu">mean</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-307"><a href="#cb31-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(average_hourly_ridership))</span>
<span id="cb31-308"><a href="#cb31-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-309"><a href="#cb31-309" aria-hidden="true" tabindex="-1"></a><span class="co"># Most popular routes by total trips</span></span>
<span id="cb31-310"><a href="#cb31-310" aria-hidden="true" tabindex="-1"></a>popular_routes <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-311"><a href="#cb31-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(From_Station, To_Station) <span class="sc">%&gt;%</span></span>
<span id="cb31-312"><a href="#cb31-312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_trips =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-313"><a href="#cb31-313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_trips)) <span class="sc">%&gt;%</span></span>
<span id="cb31-314"><a href="#cb31-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">15</span>)</span>
<span id="cb31-315"><a href="#cb31-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-316"><a href="#cb31-316" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb31-317"><a href="#cb31-317" aria-hidden="true" tabindex="-1"></a>temporal_patterns <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-318"><a href="#cb31-318" aria-hidden="true" tabindex="-1"></a>  <span class="at">busiest_days =</span> busiest_days,</span>
<span id="cb31-319"><a href="#cb31-319" aria-hidden="true" tabindex="-1"></a>  <span class="at">busiest_hours =</span> <span class="fu">head</span>(busiest_hours, <span class="dv">10</span>),</span>
<span id="cb31-320"><a href="#cb31-320" aria-hidden="true" tabindex="-1"></a>  <span class="at">popular_routes =</span> <span class="fu">convert_to_short_names</span>(popular_routes)</span>
<span id="cb31-321"><a href="#cb31-321" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-322"><a href="#cb31-322" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(temporal_patterns, <span class="st">"../src/lib/data/charts/02-temporal-patterns.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-323"><a href="#cb31-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-324"><a href="#cb31-324" aria-hidden="true" tabindex="-1"></a><span class="co"># Display tables</span></span>
<span id="cb31-325"><a href="#cb31-325" aria-hidden="true" tabindex="-1"></a>busiest_days <span class="sc">%&gt;%</span></span>
<span id="cb31-326"><a href="#cb31-326" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">average_daily_ridership =</span> <span class="fu">comma</span>(<span class="fu">round</span>(average_daily_ridership))) <span class="sc">%&gt;%</span></span>
<span id="cb31-327"><a href="#cb31-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Day"</span>, <span class="st">"Average Daily Ridership"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-328"><a href="#cb31-328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb31-329"><a href="#cb31-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-330"><a href="#cb31-330" aria-hidden="true" tabindex="-1"></a>busiest_hours <span class="sc">%&gt;%</span></span>
<span id="cb31-331"><a href="#cb31-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-332"><a href="#cb31-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-333"><a href="#cb31-333" aria-hidden="true" tabindex="-1"></a>    <span class="at">Time =</span> <span class="fu">paste0</span>(Hour, <span class="st">":00"</span>),</span>
<span id="cb31-334"><a href="#cb31-334" aria-hidden="true" tabindex="-1"></a>    <span class="at">average_hourly_ridership =</span> <span class="fu">comma</span>(<span class="fu">round</span>(average_hourly_ridership))</span>
<span id="cb31-335"><a href="#cb31-335" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-336"><a href="#cb31-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Time, average_hourly_ridership) <span class="sc">%&gt;%</span></span>
<span id="cb31-337"><a href="#cb31-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Hour"</span>, <span class="st">"Average Hourly Ridership"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-338"><a href="#cb31-338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb31-339"><a href="#cb31-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-340"><a href="#cb31-340" aria-hidden="true" tabindex="-1"></a><span class="fu">convert_to_short_names</span>(popular_routes) <span class="sc">%&gt;%</span></span>
<span id="cb31-341"><a href="#cb31-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-342"><a href="#cb31-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">Route =</span> <span class="fu">paste</span>(From_Station, <span class="st">"→"</span>, To_Station),</span>
<span id="cb31-343"><a href="#cb31-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_trips =</span> <span class="fu">comma</span>(total_trips)</span>
<span id="cb31-344"><a href="#cb31-344" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-345"><a href="#cb31-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Route, total_trips) <span class="sc">%&gt;%</span></span>
<span id="cb31-346"><a href="#cb31-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Route"</span>, <span class="st">"Cumulative Passengers"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-347"><a href="#cb31-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span>
<span id="cb31-348"><a href="#cb31-348" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-349"><a href="#cb31-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-350"><a href="#cb31-350" aria-hidden="true" tabindex="-1"></a>Weekdays are busier than weekends by a significant amount. The hourly breakdown shows distinct morning (8-10 AM) and evening (5-7 PM) peaks. Routes involving Benniganahalli and Majestic appear frequently among the most popular routes.</span>
<span id="cb31-351"><a href="#cb31-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-352"><a href="#cb31-352" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-353"><a href="#cb31-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-354"><a href="#cb31-354" aria-hidden="true" tabindex="-1"></a><span class="fu"># Daily Ridership Trends Over Time</span></span>
<span id="cb31-355"><a href="#cb31-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-356"><a href="#cb31-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r daily-trends}</span></span>
<span id="cb31-357"><a href="#cb31-357" aria-hidden="true" tabindex="-1"></a>daily_trends <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-358"><a href="#cb31-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb31-359"><a href="#cb31-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-360"><a href="#cb31-360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-361"><a href="#cb31-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_week =</span> <span class="fu">wday</span>(Date, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb31-362"><a href="#cb31-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_weekend =</span> day_of_week <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sat"</span>, <span class="st">"Sun"</span>),</span>
<span id="cb31-363"><a href="#cb31-363" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-364"><a href="#cb31-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-365"><a href="#cb31-365" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb31-366"><a href="#cb31-366" aria-hidden="true" tabindex="-1"></a>daily_trends_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-367"><a href="#cb31-367" aria-hidden="true" tabindex="-1"></a>  <span class="at">daily_data =</span> daily_trends <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.Date), as.character)),</span>
<span id="cb31-368"><a href="#cb31-368" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary_stats =</span> <span class="fu">list</span>(</span>
<span id="cb31-369"><a href="#cb31-369" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_ridership =</span> <span class="fu">max</span>(daily_trends<span class="sc">$</span>total_ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb31-370"><a href="#cb31-370" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_ridership =</span> <span class="fu">min</span>(daily_trends<span class="sc">$</span>total_ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb31-371"><a href="#cb31-371" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_weekday =</span> <span class="fu">mean</span>(daily_trends<span class="sc">$</span>total_ridership[<span class="sc">!</span>daily_trends<span class="sc">$</span>is_weekend], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb31-372"><a href="#cb31-372" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_weekend =</span> <span class="fu">mean</span>(daily_trends<span class="sc">$</span>total_ridership[daily_trends<span class="sc">$</span>is_weekend], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-373"><a href="#cb31-373" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-374"><a href="#cb31-374" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-375"><a href="#cb31-375" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(daily_trends_export, <span class="st">"../src/lib/data/charts/03-daily-trends.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-376"><a href="#cb31-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-377"><a href="#cb31-377" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot daily trends</span></span>
<span id="cb31-378"><a href="#cb31-378" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(daily_trends, <span class="fu">aes</span>(<span class="at">x =</span> Date, <span class="at">y =</span> total_ridership)) <span class="sc">+</span></span>
<span id="cb31-379"><a href="#cb31-379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"#34495e"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb31-380"><a href="#cb31-380" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">filter</span>(daily_trends, is_weekend), <span class="fu">aes</span>(<span class="at">color =</span> <span class="st">"Weekend"</span>), <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb31-381"><a href="#cb31-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekend"</span> <span class="ot">=</span> secondary_color)) <span class="sc">+</span></span>
<span id="cb31-382"><a href="#cb31-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">comma_format</span>(<span class="at">scale =</span> <span class="fl">1e-3</span>, <span class="at">suffix =</span> <span class="st">"K"</span>)) <span class="sc">+</span></span>
<span id="cb31-383"><a href="#cb31-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-384"><a href="#cb31-384" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Daily Metro Ridership Over Time"</span>,</span>
<span id="cb31-385"><a href="#cb31-385" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Pink points highlight weekends"</span>,</span>
<span id="cb31-386"><a href="#cb31-386" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Total Daily Ridership"</span>, <span class="at">color =</span> <span class="st">""</span></span>
<span id="cb31-387"><a href="#cb31-387" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-388"><a href="#cb31-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_metro</span>() <span class="sc">+</span></span>
<span id="cb31-389"><a href="#cb31-389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb31-390"><a href="#cb31-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-391"><a href="#cb31-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-392"><a href="#cb31-392" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-393"><a href="#cb31-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-394"><a href="#cb31-394" aria-hidden="true" tabindex="-1"></a><span class="fu"># How Popular is Your Route?</span></span>
<span id="cb31-395"><a href="#cb31-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-396"><a href="#cb31-396" aria-hidden="true" tabindex="-1"></a>We'll calculate combinations of all possible to and from stations, and rank them by how many people took these trips in all. This will also let us find out where our personal commutes lie in the distribution. Am I an unusual duck?</span>
<span id="cb31-397"><a href="#cb31-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-398"><a href="#cb31-398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r commute-popularity}</span></span>
<span id="cb31-399"><a href="#cb31-399" aria-hidden="true" tabindex="-1"></a><span class="co"># Example commute</span></span>
<span id="cb31-400"><a href="#cb31-400" aria-hidden="true" tabindex="-1"></a>from_station <span class="ot">&lt;-</span> <span class="st">"Cubbon Park"</span></span>
<span id="cb31-401"><a href="#cb31-401" aria-hidden="true" tabindex="-1"></a>to_station <span class="ot">&lt;-</span> <span class="st">"Nagasandra"</span></span>
<span id="cb31-402"><a href="#cb31-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-403"><a href="#cb31-403" aria-hidden="true" tabindex="-1"></a>yellow_line_opening <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2025-08-11"</span>)</span>
<span id="cb31-404"><a href="#cb31-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-405"><a href="#cb31-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for the period after the Yellow Line opened</span></span>
<span id="cb31-406"><a href="#cb31-406" aria-hidden="true" tabindex="-1"></a>n_dates <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-407"><a href="#cb31-407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> yellow_line_opening) <span class="sc">%&gt;%</span></span>
<span id="cb31-408"><a href="#cb31-408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n_distinct</span>(Date)) <span class="sc">%&gt;%</span></span>
<span id="cb31-409"><a href="#cb31-409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb31-410"><a href="#cb31-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-411"><a href="#cb31-411" aria-hidden="true" tabindex="-1"></a>commute_popularity <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-412"><a href="#cb31-412" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> yellow_line_opening, From_Station <span class="sc">!=</span> To_Station) <span class="sc">%&gt;%</span></span>
<span id="cb31-413"><a href="#cb31-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_trips =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.by =</span> <span class="fu">c</span>(From_Station, To_Station)) <span class="sc">%&gt;%</span></span>
<span id="cb31-414"><a href="#cb31-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_trips)) <span class="sc">%&gt;%</span></span>
<span id="cb31-415"><a href="#cb31-415" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-416"><a href="#cb31-416" aria-hidden="true" tabindex="-1"></a>    <span class="at">rank =</span> <span class="fu">row_number</span>(),</span>
<span id="cb31-417"><a href="#cb31-417" aria-hidden="true" tabindex="-1"></a>    <span class="at">percentile =</span> (<span class="dv">1</span> <span class="sc">-</span> (rank <span class="sc">/</span> <span class="fu">n</span>())) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb31-418"><a href="#cb31-418" aria-hidden="true" tabindex="-1"></a>    <span class="at">daily_average =</span> <span class="fu">round</span>(total_trips <span class="sc">/</span> n_dates, <span class="dv">0</span>)</span>
<span id="cb31-419"><a href="#cb31-419" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-420"><a href="#cb31-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-421"><a href="#cb31-421" aria-hidden="true" tabindex="-1"></a>my_commute_rank <span class="ot">&lt;-</span> commute_popularity <span class="sc">%&gt;%</span></span>
<span id="cb31-422"><a href="#cb31-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(From_Station <span class="sc">==</span> from_station <span class="sc">&amp;</span> To_Station <span class="sc">==</span> to_station)</span>
<span id="cb31-423"><a href="#cb31-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-424"><a href="#cb31-424" aria-hidden="true" tabindex="-1"></a>most_common_destination <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-425"><a href="#cb31-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(From_Station <span class="sc">==</span> from_station, To_Station <span class="sc">!=</span> from_station) <span class="sc">%&gt;%</span></span>
<span id="cb31-426"><a href="#cb31-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_trips =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.by =</span> To_Station) <span class="sc">%&gt;%</span></span>
<span id="cb31-427"><a href="#cb31-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> total_trips, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb31-428"><a href="#cb31-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-429"><a href="#cb31-429" aria-hidden="true" tabindex="-1"></a>most_common_origin <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-430"><a href="#cb31-430" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(To_Station <span class="sc">==</span> to_station, From_Station <span class="sc">!=</span> to_station) <span class="sc">%&gt;%</span></span>
<span id="cb31-431"><a href="#cb31-431" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_trips =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.by =</span> From_Station) <span class="sc">%&gt;%</span></span>
<span id="cb31-432"><a href="#cb31-432" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> total_trips, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb31-433"><a href="#cb31-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-434"><a href="#cb31-434" aria-hidden="true" tabindex="-1"></a><span class="co"># Export compressed route data using station codes</span></span>
<span id="cb31-435"><a href="#cb31-435" aria-hidden="true" tabindex="-1"></a>commute_compressed <span class="ot">&lt;-</span> commute_popularity <span class="sc">%&gt;%</span></span>
<span id="cb31-436"><a href="#cb31-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"From_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-437"><a href="#cb31-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"To_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_from"</span>, <span class="st">"_to"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-438"><a href="#cb31-438" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">f =</span> code_from, <span class="at">t =</span> code_to, <span class="at">r =</span> daily_average, <span class="at">n =</span> rank, <span class="at">p =</span> percentile) <span class="sc">%&gt;%</span></span>
<span id="cb31-439"><a href="#cb31-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(f) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(t))</span>
<span id="cb31-440"><a href="#cb31-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-441"><a href="#cb31-441" aria-hidden="true" tabindex="-1"></a>commute_flow_only <span class="ot">&lt;-</span> commute_compressed <span class="sc">%&gt;%</span> <span class="fu">select</span>(f, t, r)</span>
<span id="cb31-442"><a href="#cb31-442" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(commute_flow_only, <span class="st">"../src/lib/data/charts/04-commute-flow.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-443"><a href="#cb31-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-444"><a href="#cb31-444" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(commute_compressed, <span class="st">"../src/lib/data/charts/04-commute-analysis.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-445"><a href="#cb31-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-446"><a href="#cb31-446" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(my_commute_rank) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb31-447"><a href="#cb31-447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"Most common destination from"</span>, <span class="fu">get_short_name</span>(from_station), <span class="st">":"</span>,</span>
<span id="cb31-448"><a href="#cb31-448" aria-hidden="true" tabindex="-1"></a>            <span class="fu">get_short_name</span>(most_common_destination<span class="sc">$</span>To_Station),</span>
<span id="cb31-449"><a href="#cb31-449" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">"("</span>, <span class="fu">comma</span>(most_common_destination<span class="sc">$</span>total_trips), <span class="st">" passengers)"</span>)))</span>
<span id="cb31-450"><a href="#cb31-450" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">Most common origin for"</span>, <span class="fu">get_short_name</span>(to_station), <span class="st">":"</span>,</span>
<span id="cb31-451"><a href="#cb31-451" aria-hidden="true" tabindex="-1"></a>            <span class="fu">get_short_name</span>(most_common_origin<span class="sc">$</span>From_Station),</span>
<span id="cb31-452"><a href="#cb31-452" aria-hidden="true" tabindex="-1"></a>            <span class="fu">paste0</span>(<span class="st">"("</span>, <span class="fu">comma</span>(most_common_origin<span class="sc">$</span>total_trips), <span class="st">" passengers)"</span>)))</span>
<span id="cb31-453"><a href="#cb31-453" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb31-454"><a href="#cb31-454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No direct trips found for the sample route in the dataset."</span>)</span>
<span id="cb31-455"><a href="#cb31-455" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-456"><a href="#cb31-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-457"><a href="#cb31-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-458"><a href="#cb31-458" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-459"><a href="#cb31-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-460"><a href="#cb31-460" aria-hidden="true" tabindex="-1"></a><span class="fu"># Peak Hour Stations</span></span>
<span id="cb31-461"><a href="#cb31-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-462"><a href="#cb31-462" aria-hidden="true" tabindex="-1"></a>Finding out which stations experience the heaviest arrival load during peak hours.</span>
<span id="cb31-463"><a href="#cb31-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-464"><a href="#cb31-464" aria-hidden="true" tabindex="-1"></a><span class="in">```{r peak-hour-analysis}</span></span>
<span id="cb31-465"><a href="#cb31-465" aria-hidden="true" tabindex="-1"></a>busiest_peak_stations <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-466"><a href="#cb31-466" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(peak_category <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Morning Peak"</span>, <span class="st">"Evening Peak"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-467"><a href="#cb31-467" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(peak_category, Station, Line) <span class="sc">%&gt;%</span></span>
<span id="cb31-468"><a href="#cb31-468" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">avg_ridership =</span> <span class="fu">mean</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-469"><a href="#cb31-469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(peak_category) <span class="sc">%&gt;%</span></span>
<span id="cb31-470"><a href="#cb31-470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> avg_ridership, <span class="at">n =</span> <span class="dv">15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-471"><a href="#cb31-471" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-472"><a href="#cb31-472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(peak_category, <span class="fu">desc</span>(avg_ridership))</span>
<span id="cb31-473"><a href="#cb31-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-474"><a href="#cb31-474" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb31-475"><a href="#cb31-475" aria-hidden="true" tabindex="-1"></a>peak_hour_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-476"><a href="#cb31-476" aria-hidden="true" tabindex="-1"></a>  <span class="at">peak_stations =</span> <span class="fu">convert_to_short_names</span>(busiest_peak_stations),</span>
<span id="cb31-477"><a href="#cb31-477" aria-hidden="true" tabindex="-1"></a>  <span class="at">peak_summary =</span> busiest_peak_stations <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(peak_category)</span>
<span id="cb31-478"><a href="#cb31-478" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-479"><a href="#cb31-479" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(peak_hour_export, <span class="st">"../src/lib/data/charts/05-peak-hours.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-480"><a href="#cb31-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-481"><a href="#cb31-481" aria-hidden="true" tabindex="-1"></a><span class="co"># Display table</span></span>
<span id="cb31-482"><a href="#cb31-482" aria-hidden="true" tabindex="-1"></a><span class="fu">convert_to_short_names</span>(busiest_peak_stations) <span class="sc">%&gt;%</span></span>
<span id="cb31-483"><a href="#cb31-483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_ridership =</span> <span class="fu">round</span>(avg_ridership, <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-484"><a href="#cb31-484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-485"><a href="#cb31-485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(</span>
<span id="cb31-486"><a href="#cb31-486" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Busiest Stations During Peak Hours"</span>,</span>
<span id="cb31-487"><a href="#cb31-487" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Top 15 stations for each peak period (Morning: 8-10 AM, Evening: 5-7 PM)"</span></span>
<span id="cb31-488"><a href="#cb31-488" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-489"><a href="#cb31-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> avg_ridership, <span class="at">decimals =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-490"><a href="#cb31-490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb31-491"><a href="#cb31-491" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="at">color =</span> primary_color, <span class="at">alpha =</span> <span class="fl">0.3</span>), <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>)),</span>
<span id="cb31-492"><a href="#cb31-492" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()</span>
<span id="cb31-493"><a href="#cb31-493" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-494"><a href="#cb31-494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_align</span>(<span class="at">align =</span> <span class="st">"center"</span>, <span class="at">columns =</span> avg_ridership) <span class="sc">%&gt;%</span></span>
<span id="cb31-495"><a href="#cb31-495" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_options</span>(</span>
<span id="cb31-496"><a href="#cb31-496" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.font.names =</span> <span class="st">"Atkinson Hyperlegible"</span>,</span>
<span id="cb31-497"><a href="#cb31-497" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.title.font.size =</span> <span class="dv">16</span>,</span>
<span id="cb31-498"><a href="#cb31-498" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.subtitle.font.size =</span> <span class="dv">12</span>,</span>
<span id="cb31-499"><a href="#cb31-499" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.font.size =</span> <span class="dv">11</span></span>
<span id="cb31-500"><a href="#cb31-500" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-501"><a href="#cb31-501" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-502"><a href="#cb31-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-503"><a href="#cb31-503" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-504"><a href="#cb31-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-505"><a href="#cb31-505" aria-hidden="true" tabindex="-1"></a><span class="fu"># Station Activity</span></span>
<span id="cb31-506"><a href="#cb31-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-507"><a href="#cb31-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{r station-heatmaps}</span></span>
<span id="cb31-508"><a href="#cb31-508" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the average ridership when station is origin station</span></span>
<span id="cb31-509"><a href="#cb31-509" aria-hidden="true" tabindex="-1"></a>origin_avg <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-510"><a href="#cb31-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(From_Station, day_type, Hour, Date) <span class="sc">%&gt;%</span></span>
<span id="cb31-511"><a href="#cb31-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-512"><a href="#cb31-512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">Station =</span> From_Station, day_type, total_ridership, Hour, Date)</span>
<span id="cb31-513"><a href="#cb31-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-514"><a href="#cb31-514" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the average ridership when station is destination station</span></span>
<span id="cb31-515"><a href="#cb31-515" aria-hidden="true" tabindex="-1"></a>destination_avg <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-516"><a href="#cb31-516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(To_Station, day_type, Hour, Date) <span class="sc">%&gt;%</span></span>
<span id="cb31-517"><a href="#cb31-517" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-518"><a href="#cb31-518" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">Station =</span> To_Station, day_type, total_ridership, Hour, Date)</span>
<span id="cb31-519"><a href="#cb31-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-520"><a href="#cb31-520" aria-hidden="true" tabindex="-1"></a><span class="co"># Get total ridership at each station at each hour by summing the origin and destination ridership</span></span>
<span id="cb31-521"><a href="#cb31-521" aria-hidden="true" tabindex="-1"></a>total_ridership <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(origin_avg, destination_avg) <span class="sc">%&gt;%</span></span>
<span id="cb31-522"><a href="#cb31-522" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, day_type, Hour, Date) <span class="sc">%&gt;%</span></span>
<span id="cb31-523"><a href="#cb31-523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(total_ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-524"><a href="#cb31-524" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, day_type, total_ridership, Hour, Date)</span>
<span id="cb31-525"><a href="#cb31-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-526"><a href="#cb31-526" aria-hidden="true" tabindex="-1"></a><span class="co"># Get median at each hour across all dates</span></span>
<span id="cb31-527"><a href="#cb31-527" aria-hidden="true" tabindex="-1"></a>median_ridership <span class="ot">&lt;-</span> total_ridership <span class="sc">%&gt;%</span></span>
<span id="cb31-528"><a href="#cb31-528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, day_type, Hour) <span class="sc">%&gt;%</span></span>
<span id="cb31-529"><a href="#cb31-529" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_ridership =</span> <span class="fu">median</span>(total_ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-530"><a href="#cb31-530" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, day_type, median_ridership, Hour)</span>
<span id="cb31-531"><a href="#cb31-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-532"><a href="#cb31-532" aria-hidden="true" tabindex="-1"></a><span class="co"># Get total ridership throughout each day by summing over all median ridership</span></span>
<span id="cb31-533"><a href="#cb31-533" aria-hidden="true" tabindex="-1"></a>daily_ridership <span class="ot">&lt;-</span> median_ridership <span class="sc">%&gt;%</span></span>
<span id="cb31-534"><a href="#cb31-534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, day_type) <span class="sc">%&gt;%</span></span>
<span id="cb31-535"><a href="#cb31-535" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(median_ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-536"><a href="#cb31-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, day_type, total_ridership)</span>
<span id="cb31-537"><a href="#cb31-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-538"><a href="#cb31-538" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the ratio of median ridership at each hour to the total ridership throughout each day</span></span>
<span id="cb31-539"><a href="#cb31-539" aria-hidden="true" tabindex="-1"></a>hourly_heatmap_data <span class="ot">&lt;-</span> median_ridership <span class="sc">%&gt;%</span></span>
<span id="cb31-540"><a href="#cb31-540" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(daily_ridership, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Station"</span>, <span class="st">"day_type"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-541"><a href="#cb31-541" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hourly_ratio =</span> median_ridership <span class="sc">/</span> total_ridership) <span class="sc">%&gt;%</span></span>
<span id="cb31-542"><a href="#cb31-542" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, day_type, hourly_ratio, Hour, median_ridership)</span>
<span id="cb31-543"><a href="#cb31-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-544"><a href="#cb31-544" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill missing hours with 0</span></span>
<span id="cb31-545"><a href="#cb31-545" aria-hidden="true" tabindex="-1"></a>hourly_heatmap_data <span class="ot">&lt;-</span> hourly_heatmap_data <span class="sc">%&gt;%</span></span>
<span id="cb31-546"><a href="#cb31-546" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(<span class="at">Hour =</span> <span class="fu">full_seq</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">23</span>), <span class="dv">1</span>), Station, day_type) <span class="sc">%&gt;%</span></span>
<span id="cb31-547"><a href="#cb31-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace_na</span>(<span class="fu">list</span>(<span class="at">hourly_ratio =</span> <span class="dv">0</span>, <span class="at">median_ridership =</span> <span class="dv">0</span>))</span>
<span id="cb31-548"><a href="#cb31-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-549"><a href="#cb31-549" aria-hidden="true" tabindex="-1"></a>hourly_heatmap_data <span class="ot">&lt;-</span> <span class="fu">convert_to_short_names</span>(hourly_heatmap_data)</span>
<span id="cb31-550"><a href="#cb31-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-551"><a href="#cb31-551" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the peak hours</span></span>
<span id="cb31-552"><a href="#cb31-552" aria-hidden="true" tabindex="-1"></a>peak_hours <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">17</span><span class="sc">:</span><span class="dv">19</span>)</span>
<span id="cb31-553"><a href="#cb31-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-554"><a href="#cb31-554" aria-hidden="true" tabindex="-1"></a>heatmap_data <span class="ot">&lt;-</span> hourly_heatmap_data <span class="sc">%&gt;%</span></span>
<span id="cb31-555"><a href="#cb31-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, Hour, day_type, hourly_ratio)</span>
<span id="cb31-556"><a href="#cb31-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-557"><a href="#cb31-557" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb31-558"><a href="#cb31-558" aria-hidden="true" tabindex="-1"></a>heatmap_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-559"><a href="#cb31-559" aria-hidden="true" tabindex="-1"></a>  heatmap_data</span>
<span id="cb31-560"><a href="#cb31-560" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-561"><a href="#cb31-561" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(heatmap_export, <span class="st">"../src/lib/data/charts/07-station-heatmaps.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-562"><a href="#cb31-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-563"><a href="#cb31-563" aria-hidden="true" tabindex="-1"></a><span class="co"># Station order for graph</span></span>
<span id="cb31-564"><a href="#cb31-564" aria-hidden="true" tabindex="-1"></a>station_order <span class="ot">&lt;-</span> hourly_heatmap_data <span class="sc">%&gt;%</span></span>
<span id="cb31-565"><a href="#cb31-565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">17</span><span class="sc">:</span><span class="dv">19</span>)) <span class="sc">%&gt;%</span> <span class="co"># Peak hours</span></span>
<span id="cb31-566"><a href="#cb31-566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station) <span class="sc">%&gt;%</span></span>
<span id="cb31-567"><a href="#cb31-567" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">peak_ridership =</span> <span class="fu">mean</span>(median_ridership), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-568"><a href="#cb31-568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(peak_ridership)) <span class="sc">%&gt;%</span></span>
<span id="cb31-569"><a href="#cb31-569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(Station)</span>
<span id="cb31-570"><a href="#cb31-570" aria-hidden="true" tabindex="-1"></a>station_order_display <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_chr</span>(station_order, get_short_name)</span>
<span id="cb31-571"><a href="#cb31-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-572"><a href="#cb31-572" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot heatmap</span></span>
<span id="cb31-573"><a href="#cb31-573" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hourly_heatmap_data, <span class="fu">aes</span>(<span class="at">x =</span> Hour, <span class="at">y =</span> <span class="fu">factor</span>(Station, <span class="at">levels =</span> <span class="fu">rev</span>(station_order_display)), <span class="at">fill =</span> hourly_ratio)) <span class="sc">+</span></span>
<span id="cb31-574"><a href="#cb31-574" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb31-575"><a href="#cb31-575" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"Avg</span><span class="sc">\n</span><span class="st">Ridership"</span>, <span class="at">trans =</span> <span class="st">"sqrt"</span>, <span class="at">labels =</span> comma, <span class="at">option =</span> <span class="st">"plasma"</span>) <span class="sc">+</span></span>
<span id="cb31-576"><a href="#cb31-576" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>day_type, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb31-577"><a href="#cb31-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>, <span class="dv">15</span>, <span class="dv">18</span>, <span class="dv">21</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"6AM"</span>, <span class="st">"9AM"</span>, <span class="st">"12PM"</span>, <span class="st">"3PM"</span>, <span class="st">"6PM"</span>, <span class="st">"9PM"</span>)) <span class="sc">+</span></span>
<span id="cb31-578"><a href="#cb31-578" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-579"><a href="#cb31-579" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Metro Station Activity Throughout the Day"</span>,</span>
<span id="cb31-580"><a href="#cb31-580" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Stations ordered by peak hour ridership. Color scale is square-root transformed."</span>,</span>
<span id="cb31-581"><a href="#cb31-581" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Hour of Day"</span>, <span class="at">y =</span> <span class="st">"Station"</span></span>
<span id="cb31-582"><a href="#cb31-582" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-583"><a href="#cb31-583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_metro</span>() <span class="sc">+</span></span>
<span id="cb31-584"><a href="#cb31-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb31-585"><a href="#cb31-585" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>),</span>
<span id="cb31-586"><a href="#cb31-586" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb31-587"><a href="#cb31-587" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb31-588"><a href="#cb31-588" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">20</span>, <span class="dv">25</span>, <span class="dv">20</span>, <span class="dv">25</span>)</span>
<span id="cb31-589"><a href="#cb31-589" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-590"><a href="#cb31-590" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-591"><a href="#cb31-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-592"><a href="#cb31-592" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb31-593"><a href="#cb31-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-594"><a href="#cb31-594" aria-hidden="true" tabindex="-1"></a><span class="fu"># Interchange Station Footfall</span></span>
<span id="cb31-595"><a href="#cb31-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-596"><a href="#cb31-596" aria-hidden="true" tabindex="-1"></a>Analyzing how footfall at interchange stations has changed with the opening of the Yellow Line.</span>
<span id="cb31-597"><a href="#cb31-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-598"><a href="#cb31-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-599"><a href="#cb31-599" aria-hidden="true" tabindex="-1"></a><span class="in">```{r interchange-station-footfall}</span></span>
<span id="cb31-600"><a href="#cb31-600" aria-hidden="true" tabindex="-1"></a><span class="co"># Define key dates</span></span>
<span id="cb31-601"><a href="#cb31-601" aria-hidden="true" tabindex="-1"></a>yellow_line_opening <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2025-08-11"</span>)</span>
<span id="cb31-602"><a href="#cb31-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-603"><a href="#cb31-603" aria-hidden="true" tabindex="-1"></a><span class="co"># Populate line attribute in station_pair_hourly</span></span>
<span id="cb31-604"><a href="#cb31-604" aria-hidden="true" tabindex="-1"></a>station_pair_hourly <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-605"><a href="#cb31-605" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"From_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-606"><a href="#cb31-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"To_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_from"</span>, <span class="st">"_to"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-607"><a href="#cb31-607" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">From_line =</span> <span class="fu">if_else</span>(Line_from <span class="sc">==</span> <span class="st">"Black"</span>, <span class="st">"Purple"</span>, Line_from)) <span class="sc">%&gt;%</span></span>
<span id="cb31-608"><a href="#cb31-608" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">To_line =</span> <span class="fu">if_else</span>(Line_to <span class="sc">==</span> <span class="st">"Black"</span>, <span class="st">"Green"</span>, Line_to)) <span class="sc">%&gt;%</span></span>
<span id="cb31-609"><a href="#cb31-609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Line_from, <span class="sc">-</span>Line_to)</span>
<span id="cb31-610"><a href="#cb31-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-611"><a href="#cb31-611" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average daily number of passengers transferring at Rashtreeya Vidyalaya Road before Yellow Line</span></span>
<span id="cb31-612"><a href="#cb31-612" aria-hidden="true" tabindex="-1"></a>rashtreeya_vidyalaya_road_footfall <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-613"><a href="#cb31-613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>((From_line <span class="sc">==</span> <span class="st">"Yellow"</span> <span class="sc">&amp;</span> To_line <span class="sc">!=</span> <span class="st">"Yellow"</span>) <span class="sc">|</span> (From_line <span class="sc">!=</span> <span class="st">"Yellow"</span> <span class="sc">&amp;</span> To_line <span class="sc">==</span> <span class="st">"Yellow"</span>) <span class="sc">|</span> (From_Station <span class="sc">==</span> <span class="st">"Rashtreeya Vidyalaya Road"</span>) <span class="sc">|</span> (To_Station <span class="sc">==</span> <span class="st">"Rashtreeya Vidyalaya Road"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-614"><a href="#cb31-614" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb31-615"><a href="#cb31-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_footfall =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-616"><a href="#cb31-616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&lt;</span> yellow_line_opening) <span class="sc">%&gt;%</span></span>
<span id="cb31-617"><a href="#cb31-617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_footfall =</span> <span class="fu">round</span>(<span class="fu">mean</span>(daily_footfall), <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-618"><a href="#cb31-618" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Station =</span> <span class="st">"Rashtreeya Vidyalaya Road"</span>, <span class="at">Before =</span> average_footfall) <span class="sc">%&gt;%</span></span>
<span id="cb31-619"><a href="#cb31-619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>average_footfall)</span>
<span id="cb31-620"><a href="#cb31-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-621"><a href="#cb31-621" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average daily number of passengers transferring at Majestic before Yellow Line</span></span>
<span id="cb31-622"><a href="#cb31-622" aria-hidden="true" tabindex="-1"></a>majestic_footfall <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-623"><a href="#cb31-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>((From_line <span class="sc">==</span> <span class="st">"Purple"</span> <span class="sc">&amp;</span> To_line <span class="sc">!=</span> <span class="st">"Purple"</span>) <span class="sc">|</span> (From_line <span class="sc">!=</span> <span class="st">"Purple"</span> <span class="sc">&amp;</span> To_line <span class="sc">==</span> <span class="st">"Purple"</span>) <span class="sc">|</span> (From_Station <span class="sc">==</span> <span class="st">"Majestic"</span>) <span class="sc">|</span> (To_Station <span class="sc">==</span> <span class="st">"Majestic"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-624"><a href="#cb31-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb31-625"><a href="#cb31-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_footfall =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-626"><a href="#cb31-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&lt;</span> yellow_line_opening) <span class="sc">%&gt;%</span></span>
<span id="cb31-627"><a href="#cb31-627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_footfall =</span> <span class="fu">round</span>(<span class="fu">mean</span>(daily_footfall), <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-628"><a href="#cb31-628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Station =</span> <span class="st">"Majestic"</span>, <span class="at">Before =</span> average_footfall) <span class="sc">%&gt;%</span></span>
<span id="cb31-629"><a href="#cb31-629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>average_footfall)</span>
<span id="cb31-630"><a href="#cb31-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-631"><a href="#cb31-631" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average daily number of passengers transferring at Rashtreeya Vidyalaya Road after Yellow Line</span></span>
<span id="cb31-632"><a href="#cb31-632" aria-hidden="true" tabindex="-1"></a>rashtreeya_vidyalaya_road_footfall_after <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-633"><a href="#cb31-633" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>((From_line <span class="sc">==</span> <span class="st">"Yellow"</span> <span class="sc">&amp;</span> To_line <span class="sc">!=</span> <span class="st">"Yellow"</span>) <span class="sc">|</span> (From_line <span class="sc">!=</span> <span class="st">"Yellow"</span> <span class="sc">&amp;</span> To_line <span class="sc">==</span> <span class="st">"Yellow"</span>) <span class="sc">|</span> (From_Station <span class="sc">==</span> <span class="st">"Rashtreeya Vidyalaya Road"</span>) <span class="sc">|</span> (To_Station <span class="sc">==</span> <span class="st">"Rashtreeya Vidyalaya Road"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-634"><a href="#cb31-634" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb31-635"><a href="#cb31-635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_footfall =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-636"><a href="#cb31-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> yellow_line_opening) <span class="sc">%&gt;%</span></span>
<span id="cb31-637"><a href="#cb31-637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_footfall =</span> <span class="fu">round</span>(<span class="fu">mean</span>(daily_footfall), <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-638"><a href="#cb31-638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Station =</span> <span class="st">"Rashtreeya Vidyalaya Road"</span>, <span class="at">After =</span> average_footfall) <span class="sc">%&gt;%</span></span>
<span id="cb31-639"><a href="#cb31-639" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>average_footfall)</span>
<span id="cb31-640"><a href="#cb31-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-641"><a href="#cb31-641" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average daily number of passengers transferring at Majestic after Yellow Line</span></span>
<span id="cb31-642"><a href="#cb31-642" aria-hidden="true" tabindex="-1"></a>majestic_footfall_after <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-643"><a href="#cb31-643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>((From_line <span class="sc">==</span> <span class="st">"Purple"</span> <span class="sc">&amp;</span> To_line <span class="sc">!=</span> <span class="st">"Purple"</span>) <span class="sc">|</span> (From_line <span class="sc">!=</span> <span class="st">"Purple"</span> <span class="sc">&amp;</span> To_line <span class="sc">==</span> <span class="st">"Purple"</span>) <span class="sc">|</span> (From_Station <span class="sc">==</span> <span class="st">"Majestic"</span>) <span class="sc">|</span> (To_Station <span class="sc">==</span> <span class="st">"Majestic"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-644"><a href="#cb31-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb31-645"><a href="#cb31-645" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_footfall =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-646"><a href="#cb31-646" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> yellow_line_opening) <span class="sc">%&gt;%</span></span>
<span id="cb31-647"><a href="#cb31-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_footfall =</span> <span class="fu">round</span>(<span class="fu">mean</span>(daily_footfall), <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-648"><a href="#cb31-648" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Station =</span> <span class="st">"Majestic"</span>, <span class="at">After =</span> average_footfall) <span class="sc">%&gt;%</span></span>
<span id="cb31-649"><a href="#cb31-649" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>average_footfall)</span>
<span id="cb31-650"><a href="#cb31-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-651"><a href="#cb31-651" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results</span></span>
<span id="cb31-652"><a href="#cb31-652" aria-hidden="true" tabindex="-1"></a>interchange_footfall <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(rashtreeya_vidyalaya_road_footfall, majestic_footfall, rashtreeya_vidyalaya_road_footfall_after, majestic_footfall_after)</span>
<span id="cb31-653"><a href="#cb31-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-654"><a href="#cb31-654" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb31-655"><a href="#cb31-655" aria-hidden="true" tabindex="-1"></a>interchange_footfall_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-656"><a href="#cb31-656" aria-hidden="true" tabindex="-1"></a>  <span class="at">interchange_footfall =</span> interchange_footfall</span>
<span id="cb31-657"><a href="#cb31-657" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-658"><a href="#cb31-658" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(interchange_footfall_export, <span class="st">"../src/lib/data/charts/13-interchange-station-footfall.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-659"><a href="#cb31-659" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-660"><a href="#cb31-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-661"><a href="#cb31-661" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-662"><a href="#cb31-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-663"><a href="#cb31-663" aria-hidden="true" tabindex="-1"></a><span class="fu"># The Yellow Line Effect</span></span>
<span id="cb31-664"><a href="#cb31-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-665"><a href="#cb31-665" aria-hidden="true" tabindex="-1"></a>Analyzing how the opening of the Yellow Line on August 11th, 2025 affected daily boarding totals at existing Green and Purple Line stations. The impact of the Yellow Line was more noticeable at Green Line stations than at Purple Line stations.</span>
<span id="cb31-666"><a href="#cb31-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-667"><a href="#cb31-667" aria-hidden="true" tabindex="-1"></a><span class="in">```{r yellow-line-impact-analysis}</span></span>
<span id="cb31-668"><a href="#cb31-668" aria-hidden="true" tabindex="-1"></a><span class="co"># Define key dates</span></span>
<span id="cb31-669"><a href="#cb31-669" aria-hidden="true" tabindex="-1"></a>yellow_line_opening <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2025-08-11"</span>)</span>
<span id="cb31-670"><a href="#cb31-670" aria-hidden="true" tabindex="-1"></a>holidays <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">"2025-08-15"</span>, <span class="st">"2025-08-16"</span>)) <span class="co"># Independence Day, Krishna Janmashtami</span></span>
<span id="cb31-671"><a href="#cb31-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-672"><a href="#cb31-672" aria-hidden="true" tabindex="-1"></a><span class="co"># Use a linear model to find stations with statistically significant changes</span></span>
<span id="cb31-673"><a href="#cb31-673" aria-hidden="true" tabindex="-1"></a>significant_stations <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-674"><a href="#cb31-674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, Station, Line, wday, day_type) <span class="sc">%&gt;%</span></span>
<span id="cb31-675"><a href="#cb31-675" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-676"><a href="#cb31-676" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-677"><a href="#cb31-677" aria-hidden="true" tabindex="-1"></a>    <span class="at">after_yellow_line =</span> <span class="fu">if_else</span>(Date <span class="sc">&gt;=</span> yellow_line_opening, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb31-678"><a href="#cb31-678" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_event_day =</span> <span class="fu">if_else</span>(Date <span class="sc">%in%</span> holidays, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb31-679"><a href="#cb31-679" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-680"><a href="#cb31-680" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(day_type <span class="sc">==</span> <span class="st">"Weekday"</span> <span class="sc">&amp;</span> is_event_day <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Line <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Green"</span>, <span class="st">"Purple"</span>, <span class="st">"Black"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-681"><a href="#cb31-681" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station) <span class="sc">%&gt;%</span></span>
<span id="cb31-682"><a href="#cb31-682" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n_distinct</span>(after_yellow_line) <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="co"># Ensure data for both periods</span></span>
<span id="cb31-683"><a href="#cb31-683" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-684"><a href="#cb31-684" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(Station, Line) <span class="sc">%&gt;%</span></span>
<span id="cb31-685"><a href="#cb31-685" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">list</span>(<span class="fu">lm</span>(daily_ridership <span class="sc">~</span> after_yellow_line <span class="sc">+</span> wday, <span class="at">data =</span> data))) <span class="sc">%&gt;%</span></span>
<span id="cb31-686"><a href="#cb31-686" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">tidy</span>(model)) <span class="sc">%&gt;%</span></span>
<span id="cb31-687"><a href="#cb31-687" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-688"><a href="#cb31-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"after_yellow_line"</span> <span class="sc">&amp;</span> p.value <span class="sc">&lt;</span> <span class="fl">0.09</span>)</span>
<span id="cb31-689"><a href="#cb31-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-690"><a href="#cb31-690" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate median percentage change for context</span></span>
<span id="cb31-691"><a href="#cb31-691" aria-hidden="true" tabindex="-1"></a>impact_by_percent_change <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-692"><a href="#cb31-692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, Station, Line, day_type) <span class="sc">%&gt;%</span></span>
<span id="cb31-693"><a href="#cb31-693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">daily_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-694"><a href="#cb31-694" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-695"><a href="#cb31-695" aria-hidden="true" tabindex="-1"></a>    <span class="at">period =</span> <span class="fu">if_else</span>(Date <span class="sc">&gt;=</span> yellow_line_opening, <span class="st">"after"</span>, <span class="st">"before"</span>),</span>
<span id="cb31-696"><a href="#cb31-696" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_event_day =</span> <span class="fu">if_else</span>(Date <span class="sc">%in%</span> holidays, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb31-697"><a href="#cb31-697" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-698"><a href="#cb31-698" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(day_type <span class="sc">==</span> <span class="st">"Weekday"</span> <span class="sc">&amp;</span> is_event_day <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Line <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Green"</span>, <span class="st">"Purple"</span>, <span class="st">"Black"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-699"><a href="#cb31-699" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, Line, period) <span class="sc">%&gt;%</span></span>
<span id="cb31-700"><a href="#cb31-700" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">median_weekday_ridership =</span> <span class="fu">median</span>(daily_ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-701"><a href="#cb31-701" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> period, <span class="at">values_from =</span> median_weekday_ridership) <span class="sc">%&gt;%</span></span>
<span id="cb31-702"><a href="#cb31-702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(before) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(after)) <span class="sc">%&gt;%</span></span>
<span id="cb31-703"><a href="#cb31-703" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent_change =</span> ((after <span class="sc">-</span> before) <span class="sc">/</span> before) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb31-704"><a href="#cb31-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-705"><a href="#cb31-705" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results into a final summary</span></span>
<span id="cb31-706"><a href="#cb31-706" aria-hidden="true" tabindex="-1"></a>final_impact_summary <span class="ot">&lt;-</span> significant_stations <span class="sc">%&gt;%</span></span>
<span id="cb31-707"><a href="#cb31-707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(impact_by_percent_change, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Station"</span>, <span class="st">"Line"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-708"><a href="#cb31-708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb31-709"><a href="#cb31-709" aria-hidden="true" tabindex="-1"></a>    Station, Line,</span>
<span id="cb31-710"><a href="#cb31-710" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Median Change (%)</span><span class="st">`</span> <span class="ot">=</span> percent_change,</span>
<span id="cb31-711"><a href="#cb31-711" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Abs. Change (est.)</span><span class="st">`</span> <span class="ot">=</span> estimate,</span>
<span id="cb31-712"><a href="#cb31-712" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">p-value</span><span class="st">`</span> <span class="ot">=</span> p.value,</span>
<span id="cb31-713"><a href="#cb31-713" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Before Median</span><span class="st">`</span> <span class="ot">=</span> before,</span>
<span id="cb31-714"><a href="#cb31-714" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">After Median</span><span class="st">`</span> <span class="ot">=</span> after</span>
<span id="cb31-715"><a href="#cb31-715" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-716"><a href="#cb31-716" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="st">`</span><span class="at">Median Change (%)</span><span class="st">`</span>))</span>
<span id="cb31-717"><a href="#cb31-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-718"><a href="#cb31-718" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_impact_summary)</span>
<span id="cb31-719"><a href="#cb31-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-720"><a href="#cb31-720" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb31-721"><a href="#cb31-721" aria-hidden="true" tabindex="-1"></a>yellow_line_impact_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-722"><a href="#cb31-722" aria-hidden="true" tabindex="-1"></a>  <span class="at">station_impacts =</span> final_impact_summary <span class="sc">%&gt;%</span></span>
<span id="cb31-723"><a href="#cb31-723" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Station, Line, <span class="at">percent_change =</span> <span class="st">`</span><span class="at">Median Change (%)</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-724"><a href="#cb31-724" aria-hidden="true" tabindex="-1"></a>    <span class="fu">convert_to_short_names</span>()</span>
<span id="cb31-725"><a href="#cb31-725" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-726"><a href="#cb31-726" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(yellow_line_impact_export, <span class="st">"../src/lib/data/charts/10-yellow-line-impact.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-727"><a href="#cb31-727" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-728"><a href="#cb31-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-729"><a href="#cb31-729" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-730"><a href="#cb31-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-731"><a href="#cb31-731" aria-hidden="true" tabindex="-1"></a><span class="fu"># Station Pair Ridership Spikes</span></span>
<span id="cb31-732"><a href="#cb31-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-733"><a href="#cb31-733" aria-hidden="true" tabindex="-1"></a>During the days for which data is available, there have been unusual spikes in ridership between pairs of stations, compared to their typical ridership.</span>
<span id="cb31-734"><a href="#cb31-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-735"><a href="#cb31-735" aria-hidden="true" tabindex="-1"></a><span class="in">```{r station-pair-spikes}</span></span>
<span id="cb31-736"><a href="#cb31-736" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate typical ridership (hourly mean) for each station pair</span></span>
<span id="cb31-737"><a href="#cb31-737" aria-hidden="true" tabindex="-1"></a>station_pair_hourly_means <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-738"><a href="#cb31-738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(From_Station <span class="sc">!=</span> To_Station) <span class="sc">%&gt;%</span></span>
<span id="cb31-739"><a href="#cb31-739" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(From_Station, To_Station, Hour) <span class="sc">%&gt;%</span></span>
<span id="cb31-740"><a href="#cb31-740" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb31-741"><a href="#cb31-741" aria-hidden="true" tabindex="-1"></a>    <span class="at">typical_ridership =</span> <span class="fu">mean</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb31-742"><a href="#cb31-742" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_observations =</span> <span class="fu">n</span>(),</span>
<span id="cb31-743"><a href="#cb31-743" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb31-744"><a href="#cb31-744" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-745"><a href="#cb31-745" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(total_observations <span class="sc">&gt;=</span> <span class="dv">5</span>) <span class="co"># Ensure stable mean</span></span>
<span id="cb31-746"><a href="#cb31-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-747"><a href="#cb31-747" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify spikes by comparing actual ridership to the hourly mean</span></span>
<span id="cb31-748"><a href="#cb31-748" aria-hidden="true" tabindex="-1"></a>station_pair_spikes <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-749"><a href="#cb31-749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(From_Station <span class="sc">!=</span> To_Station) <span class="sc">%&gt;%</span></span>
<span id="cb31-750"><a href="#cb31-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(station_pair_hourly_means, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"From_Station"</span>, <span class="st">"To_Station"</span>, <span class="st">"Hour"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-751"><a href="#cb31-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(typical_ridership)) <span class="sc">%&gt;%</span></span>
<span id="cb31-752"><a href="#cb31-752" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-753"><a href="#cb31-753" aria-hidden="true" tabindex="-1"></a>    <span class="at">deviation_multiple =</span> <span class="fu">if_else</span>(typical_ridership <span class="sc">&gt;</span> <span class="dv">0</span>, Ridership <span class="sc">/</span> typical_ridership, <span class="dv">0</span>),</span>
<span id="cb31-754"><a href="#cb31-754" aria-hidden="true" tabindex="-1"></a>    <span class="at">spike_category =</span> <span class="fu">case_when</span>(</span>
<span id="cb31-755"><a href="#cb31-755" aria-hidden="true" tabindex="-1"></a>      deviation_multiple <span class="sc">&gt;=</span> <span class="dv">5</span> <span class="sc">~</span> <span class="st">"Extreme Spike (5x+)"</span>,</span>
<span id="cb31-756"><a href="#cb31-756" aria-hidden="true" tabindex="-1"></a>      deviation_multiple <span class="sc">&gt;=</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"High Spike (3-5x)"</span>,</span>
<span id="cb31-757"><a href="#cb31-757" aria-hidden="true" tabindex="-1"></a>      deviation_multiple <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Moderate Spike (2-3x)"</span>,</span>
<span id="cb31-758"><a href="#cb31-758" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Normal"</span></span>
<span id="cb31-759"><a href="#cb31-759" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-760"><a href="#cb31-760" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-761"><a href="#cb31-761" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(deviation_multiple))</span>
<span id="cb31-762"><a href="#cb31-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-763"><a href="#cb31-763" aria-hidden="true" tabindex="-1"></a>top_spikes <span class="ot">&lt;-</span> station_pair_spikes <span class="sc">%&gt;%</span></span>
<span id="cb31-764"><a href="#cb31-764" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(spike_category <span class="sc">!=</span> <span class="st">"Normal"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-765"><a href="#cb31-765" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">50</span>)</span>
<span id="cb31-766"><a href="#cb31-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-767"><a href="#cb31-767" aria-hidden="true" tabindex="-1"></a><span class="co"># Export data for visualization</span></span>
<span id="cb31-768"><a href="#cb31-768" aria-hidden="true" tabindex="-1"></a>spikes_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-769"><a href="#cb31-769" aria-hidden="true" tabindex="-1"></a>  <span class="at">top_spikes =</span> <span class="fu">convert_to_short_names</span>(top_spikes) <span class="sc">%&gt;%</span></span>
<span id="cb31-770"><a href="#cb31-770" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Date, Hour, From_Station, To_Station, Ridership, typical_ridership, deviation_multiple, spike_category, peak_category) <span class="sc">%&gt;%</span></span>
<span id="cb31-771"><a href="#cb31-771" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.character</span>(Date)),</span>
<span id="cb31-772"><a href="#cb31-772" aria-hidden="true" tabindex="-1"></a>  <span class="at">spike_summary =</span> station_pair_spikes <span class="sc">%&gt;%</span> <span class="fu">count</span>(spike_category, <span class="at">name =</span> <span class="st">"count"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-773"><a href="#cb31-773" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">percentage =</span> <span class="fu">round</span>(count <span class="sc">/</span> <span class="fu">sum</span>(count) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-774"><a href="#cb31-774" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(count))</span>
<span id="cb31-775"><a href="#cb31-775" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-776"><a href="#cb31-776" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(spikes_export, <span class="st">"../src/lib/data/charts/09-station-pair-spikes.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-777"><a href="#cb31-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-778"><a href="#cb31-778" aria-hidden="true" tabindex="-1"></a><span class="co"># Display top spikes table</span></span>
<span id="cb31-779"><a href="#cb31-779" aria-hidden="true" tabindex="-1"></a><span class="fu">convert_to_short_names</span>(top_spikes) <span class="sc">%&gt;%</span></span>
<span id="cb31-780"><a href="#cb31-780" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">20</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-781"><a href="#cb31-781" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-782"><a href="#cb31-782" aria-hidden="true" tabindex="-1"></a>    <span class="at">Route =</span> <span class="fu">paste</span>(From_Station, <span class="st">" &amp; "</span>, To_Station),</span>
<span id="cb31-783"><a href="#cb31-783" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Date &amp; Time</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste</span>(Date, <span class="fu">paste0</span>(Hour, <span class="st">":00"</span>)),</span>
<span id="cb31-784"><a href="#cb31-784" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Actual Ridership</span><span class="st">`</span> <span class="ot">=</span> Ridership,</span>
<span id="cb31-785"><a href="#cb31-785" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Typical Ridership</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">round</span>(typical_ridership, <span class="dv">1</span>)</span>
<span id="cb31-786"><a href="#cb31-786" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-787"><a href="#cb31-787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Route, <span class="st">`</span><span class="at">Date &amp; Time</span><span class="st">`</span>, <span class="st">`</span><span class="at">Actual Ridership</span><span class="st">`</span>, <span class="st">`</span><span class="at">Typical Ridership</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-788"><a href="#cb31-788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-789"><a href="#cb31-789" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(</span>
<span id="cb31-790"><a href="#cb31-790" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Top Ridership Spikes Between Station Pairs"</span>,</span>
<span id="cb31-791"><a href="#cb31-791" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Instances where ridership was significantly higher than the hourly average"</span></span>
<span id="cb31-792"><a href="#cb31-792" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-793"><a href="#cb31-793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Actual Ridership</span><span class="st">`</span>, <span class="st">`</span><span class="at">Typical Ridership</span><span class="st">`</span>), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-794"><a href="#cb31-794" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(</span>
<span id="cb31-795"><a href="#cb31-795" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="at">color =</span> primary_color, <span class="at">alpha =</span> <span class="fl">0.3</span>), <span class="fu">cell_text</span>(<span class="at">weight =</span> <span class="st">"bold"</span>)),</span>
<span id="cb31-796"><a href="#cb31-796" aria-hidden="true" tabindex="-1"></a>    <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()</span>
<span id="cb31-797"><a href="#cb31-797" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-798"><a href="#cb31-798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_options</span>(</span>
<span id="cb31-799"><a href="#cb31-799" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.font.names =</span> <span class="st">"Atkinson Hyperlegible"</span>,</span>
<span id="cb31-800"><a href="#cb31-800" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.title.font.size =</span> <span class="dv">16</span>,</span>
<span id="cb31-801"><a href="#cb31-801" aria-hidden="true" tabindex="-1"></a>    <span class="at">heading.subtitle.font.size =</span> <span class="dv">12</span>,</span>
<span id="cb31-802"><a href="#cb31-802" aria-hidden="true" tabindex="-1"></a>    <span class="at">table.font.size =</span> <span class="dv">10</span></span>
<span id="cb31-803"><a href="#cb31-803" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-804"><a href="#cb31-804" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-805"><a href="#cb31-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-806"><a href="#cb31-806" aria-hidden="true" tabindex="-1"></a><span class="in">```{r station-spike-daily-export}</span></span>
<span id="cb31-807"><a href="#cb31-807" aria-hidden="true" tabindex="-1"></a><span class="co"># Export daily totals for specific stations for a targeted spike visualization</span></span>
<span id="cb31-808"><a href="#cb31-808" aria-hidden="true" tabindex="-1"></a>selected_stations <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Mahalakshmi"</span>, <span class="st">"Lalbagh"</span>, <span class="st">"Vidhana Soudha"</span>)</span>
<span id="cb31-809"><a href="#cb31-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-810"><a href="#cb31-810" aria-hidden="true" tabindex="-1"></a>station_daily_selected <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-811"><a href="#cb31-811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Station <span class="sc">%in%</span> selected_stations) <span class="sc">%&gt;%</span></span>
<span id="cb31-812"><a href="#cb31-812" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, Line, Date) <span class="sc">%&gt;%</span></span>
<span id="cb31-813"><a href="#cb31-813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Total =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-814"><a href="#cb31-814" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Station, Date) <span class="sc">%&gt;%</span></span>
<span id="cb31-815"><a href="#cb31-815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.character</span>(Date)) <span class="sc">%&gt;%</span></span>
<span id="cb31-816"><a href="#cb31-816" aria-hidden="true" tabindex="-1"></a>  <span class="fu">convert_to_short_names</span>() <span class="co"># Use short names for consistency</span></span>
<span id="cb31-817"><a href="#cb31-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-818"><a href="#cb31-818" aria-hidden="true" tabindex="-1"></a>export_daily_payload <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-819"><a href="#cb31-819" aria-hidden="true" tabindex="-1"></a>  <span class="at">window =</span> <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-08-15"</span>, <span class="at">end =</span> <span class="st">"2025-08-18"</span>),</span>
<span id="cb31-820"><a href="#cb31-820" aria-hidden="true" tabindex="-1"></a>  <span class="at">stations =</span> <span class="fu">convert_to_short_names</span>(<span class="fu">tibble</span>(<span class="at">Station =</span> selected_stations))<span class="sc">$</span>Station,</span>
<span id="cb31-821"><a href="#cb31-821" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> station_daily_selected</span>
<span id="cb31-822"><a href="#cb31-822" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-823"><a href="#cb31-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-824"><a href="#cb31-824" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(export_daily_payload, <span class="st">"../src/lib/data/charts/09-station-spike-daily.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-825"><a href="#cb31-825" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-826"><a href="#cb31-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-827"><a href="#cb31-827" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-828"><a href="#cb31-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-829"><a href="#cb31-829" aria-hidden="true" tabindex="-1"></a><span class="fu"># Weekdays vs Weekends - Network</span></span>
<span id="cb31-830"><a href="#cb31-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-831"><a href="#cb31-831" aria-hidden="true" tabindex="-1"></a>Does Bangalore's metro serve different functions throughout the week? Weekdays for work commute and a visible difference in the weekends?</span>
<span id="cb31-832"><a href="#cb31-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-833"><a href="#cb31-833" aria-hidden="true" tabindex="-1"></a><span class="in">```{r weekday-weekend-patterns}</span></span>
<span id="cb31-834"><a href="#cb31-834" aria-hidden="true" tabindex="-1"></a>hourly_avg_wide <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-835"><a href="#cb31-835" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(day_type, Hour) <span class="sc">%&gt;%</span></span>
<span id="cb31-836"><a href="#cb31-836" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Average_Ridership =</span> <span class="fu">mean</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-837"><a href="#cb31-837" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> day_type, <span class="at">values_from =</span> Average_Ridership, <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb31-838"><a href="#cb31-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-839"><a href="#cb31-839" aria-hidden="true" tabindex="-1"></a>ribbon_data <span class="ot">&lt;-</span> hourly_avg_wide <span class="sc">%&gt;%</span></span>
<span id="cb31-840"><a href="#cb31-840" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-841"><a href="#cb31-841" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekday_ribbon_ymax =</span> <span class="fu">if_else</span>(Weekday <span class="sc">&gt;</span> Weekend, Weekday, Weekend),</span>
<span id="cb31-842"><a href="#cb31-842" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekend_ribbon_ymax =</span> <span class="fu">if_else</span>(Weekend <span class="sc">&gt;</span> Weekday, Weekend, Weekday)</span>
<span id="cb31-843"><a href="#cb31-843" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-844"><a href="#cb31-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-845"><a href="#cb31-845" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb31-846"><a href="#cb31-846" aria-hidden="true" tabindex="-1"></a>weekday_weekend_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-847"><a href="#cb31-847" aria-hidden="true" tabindex="-1"></a>  <span class="at">hourly_averages =</span> <span class="fu">pivot_longer</span>(hourly_avg_wide, <span class="sc">-</span>Hour, <span class="at">names_to =</span> <span class="st">"day_type"</span>, <span class="at">values_to =</span> <span class="st">"Average_Ridership"</span>)</span>
<span id="cb31-848"><a href="#cb31-848" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-849"><a href="#cb31-849" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(weekday_weekend_export, <span class="st">"../src/lib/data/charts/06-weekday-weekend-patterns.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-850"><a href="#cb31-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-851"><a href="#cb31-851" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot comparison</span></span>
<span id="cb31-852"><a href="#cb31-852" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ribbon_data, <span class="fu">aes</span>(<span class="at">x =</span> Hour)) <span class="sc">+</span></span>
<span id="cb31-853"><a href="#cb31-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Weekend, <span class="at">ymax =</span> weekday_ribbon_ymax), <span class="at">fill =</span> primary_color, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb31-854"><a href="#cb31-854" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Weekday, <span class="at">ymax =</span> weekend_ribbon_ymax), <span class="at">fill =</span> secondary_color, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb31-855"><a href="#cb31-855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Weekday), <span class="at">color =</span> primary_color, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb31-856"><a href="#cb31-856" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Weekend), <span class="at">color =</span> secondary_color, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb31-857"><a href="#cb31-857" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">8</span>, <span class="at">y =</span> <span class="fu">max</span>(ribbon_data<span class="sc">$</span>Weekday) <span class="sc">*</span> <span class="fl">0.9</span>, <span class="at">label =</span> <span class="st">"Weekday"</span>, <span class="at">color =</span> primary_color, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb31-858"><a href="#cb31-858" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">14</span>, <span class="at">y =</span> <span class="fu">max</span>(ribbon_data<span class="sc">$</span>Weekend) <span class="sc">*</span> <span class="fl">0.8</span>, <span class="at">label =</span> <span class="st">"Weekend"</span>, <span class="at">color =</span> secondary_color, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb31-859"><a href="#cb31-859" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">23</span>, <span class="dv">3</span>), <span class="at">labels =</span> <span class="fu">paste0</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">23</span>, <span class="dv">3</span>), <span class="st">":00"</span>)) <span class="sc">+</span></span>
<span id="cb31-860"><a href="#cb31-860" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">comma_format</span>()) <span class="sc">+</span></span>
<span id="cb31-861"><a href="#cb31-861" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-862"><a href="#cb31-862" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Ridership Patterns: Weekday vs Weekend"</span>,</span>
<span id="cb31-863"><a href="#cb31-863" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Average ridership per station across all hours of the day"</span>,</span>
<span id="cb31-864"><a href="#cb31-864" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Hour of Day"</span>, <span class="at">y =</span> <span class="st">"Average Ridership per Station"</span></span>
<span id="cb31-865"><a href="#cb31-865" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-866"><a href="#cb31-866" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_metro</span>() <span class="sc">+</span></span>
<span id="cb31-867"><a href="#cb31-867" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>))</span>
<span id="cb31-868"><a href="#cb31-868" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-869"><a href="#cb31-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-870"><a href="#cb31-870" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-871"><a href="#cb31-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-872"><a href="#cb31-872" aria-hidden="true" tabindex="-1"></a><span class="fu"># Weekdays vs Weekends - Stations at Peak Hour</span></span>
<span id="cb31-873"><a href="#cb31-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-874"><a href="#cb31-874" aria-hidden="true" tabindex="-1"></a>Some stations serve very different functions on weekdays versus weekends.</span>
<span id="cb31-875"><a href="#cb31-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-876"><a href="#cb31-876" aria-hidden="true" tabindex="-1"></a><span class="in">```{r weekday-weekend-differential}</span></span>
<span id="cb31-877"><a href="#cb31-877" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate weekday vs weekend peak traffic differences</span></span>
<span id="cb31-878"><a href="#cb31-878" aria-hidden="true" tabindex="-1"></a>peak_diff_data <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-879"><a href="#cb31-879" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line)) <span class="sc">%&gt;%</span></span>
<span id="cb31-880"><a href="#cb31-880" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, Hour, day_type, Line) <span class="sc">%&gt;%</span></span>
<span id="cb31-881"><a href="#cb31-881" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">avg_ridership =</span> <span class="fu">mean</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-882"><a href="#cb31-882" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Hour <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">17</span><span class="sc">:</span><span class="dv">19</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-883"><a href="#cb31-883" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, day_type, Line) <span class="sc">%&gt;%</span></span>
<span id="cb31-884"><a href="#cb31-884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">peak_ridership =</span> <span class="fu">mean</span>(avg_ridership), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-885"><a href="#cb31-885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> day_type, <span class="at">values_from =</span> peak_ridership, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-886"><a href="#cb31-886" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-887"><a href="#cb31-887" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekday_weekend_diff =</span> Weekday <span class="sc">-</span> Weekend,</span>
<span id="cb31-888"><a href="#cb31-888" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_category =</span> <span class="fu">case_when</span>(</span>
<span id="cb31-889"><a href="#cb31-889" aria-hidden="true" tabindex="-1"></a>      weekday_weekend_diff <span class="sc">&gt;</span> <span class="dv">500</span> <span class="sc">~</span> <span class="st">"Strongly Weekday-Oriented"</span>,</span>
<span id="cb31-890"><a href="#cb31-890" aria-hidden="true" tabindex="-1"></a>      weekday_weekend_diff <span class="sc">&gt;</span> <span class="dv">200</span> <span class="sc">~</span> <span class="st">"Moderately Weekday-Oriented"</span>,</span>
<span id="cb31-891"><a href="#cb31-891" aria-hidden="true" tabindex="-1"></a>      weekday_weekend_diff <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">50</span> <span class="sc">~</span> <span class="st">"Weekend-Oriented"</span>,</span>
<span id="cb31-892"><a href="#cb31-892" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Balanced"</span></span>
<span id="cb31-893"><a href="#cb31-893" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-894"><a href="#cb31-894" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-895"><a href="#cb31-895" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(weekday_weekend_diff))</span>
<span id="cb31-896"><a href="#cb31-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-897"><a href="#cb31-897" aria-hidden="true" tabindex="-1"></a><span class="co"># Export for web component</span></span>
<span id="cb31-898"><a href="#cb31-898" aria-hidden="true" tabindex="-1"></a>differential_export <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-899"><a href="#cb31-899" aria-hidden="true" tabindex="-1"></a>  <span class="at">station_differences =</span> <span class="fu">convert_to_short_names</span>(peak_diff_data),</span>
<span id="cb31-900"><a href="#cb31-900" aria-hidden="true" tabindex="-1"></a>  <span class="at">category_summary =</span> peak_diff_data <span class="sc">%&gt;%</span></span>
<span id="cb31-901"><a href="#cb31-901" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(diff_category, <span class="at">name =</span> <span class="st">"station_count"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-902"><a href="#cb31-902" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">percentage =</span> <span class="fu">round</span>(station_count <span class="sc">/</span> <span class="fu">sum</span>(station_count) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>))</span>
<span id="cb31-903"><a href="#cb31-903" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-904"><a href="#cb31-904" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(differential_export, <span class="st">"../src/lib/data/charts/08-weekday-weekend-differential.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-905"><a href="#cb31-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-906"><a href="#cb31-906" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for diverging bar chart</span></span>
<span id="cb31-907"><a href="#cb31-907" aria-hidden="true" tabindex="-1"></a>top_diff_data <span class="ot">&lt;-</span> <span class="fu">convert_to_short_names</span>(peak_diff_data) <span class="sc">%&gt;%</span></span>
<span id="cb31-908"><a href="#cb31-908" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">25</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-909"><a href="#cb31-909" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Station =</span> <span class="fu">fct_reorder</span>(Station, weekday_weekend_diff)) <span class="sc">%&gt;%</span></span>
<span id="cb31-910"><a href="#cb31-910" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, Weekday, Weekend) <span class="sc">%&gt;%</span></span>
<span id="cb31-911"><a href="#cb31-911" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(Weekday, Weekend), <span class="at">names_to =</span> <span class="st">"day_type"</span>, <span class="at">values_to =</span> <span class="st">"ridership"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-912"><a href="#cb31-912" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-913"><a href="#cb31-913" aria-hidden="true" tabindex="-1"></a>    <span class="at">ridership_direction =</span> <span class="fu">if_else</span>(day_type <span class="sc">==</span> <span class="st">"Weekend"</span>, <span class="sc">-</span>ridership, ridership),</span>
<span id="cb31-914"><a href="#cb31-914" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_type =</span> <span class="fu">factor</span>(day_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Weekend"</span>, <span class="st">"Weekday"</span>))</span>
<span id="cb31-915"><a href="#cb31-915" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-916"><a href="#cb31-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-917"><a href="#cb31-917" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot diverging bar chart</span></span>
<span id="cb31-918"><a href="#cb31-918" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(top_diff_data, <span class="fu">aes</span>(<span class="at">x =</span> ridership_direction, <span class="at">y =</span> Station, <span class="at">fill =</span> day_type)) <span class="sc">+</span></span>
<span id="cb31-919"><a href="#cb31-919" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb31-920"><a href="#cb31-920" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb31-921"><a href="#cb31-921" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Weekday"</span> <span class="ot">=</span> primary_color, <span class="st">"Weekend"</span> <span class="ot">=</span> secondary_color), <span class="at">name =</span> <span class="st">"Day Type"</span>) <span class="sc">+</span></span>
<span id="cb31-922"><a href="#cb31-922" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> <span class="sc">~</span> <span class="fu">comma</span>(<span class="fu">abs</span>(.x)), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1000</span>, <span class="dv">2000</span>, <span class="dv">500</span>), <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb31-923"><a href="#cb31-923" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-924"><a href="#cb31-924" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Weekday vs Weekend Peak Hour Ridership"</span>,</span>
<span id="cb31-925"><a href="#cb31-925" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Top 25 stations with the largest difference between weekday and weekend usage"</span>,</span>
<span id="cb31-926"><a href="#cb31-926" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Average Peak Hour Ridership"</span>, <span class="at">y =</span> <span class="st">"Station"</span></span>
<span id="cb31-927"><a href="#cb31-927" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-928"><a href="#cb31-928" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_metro</span>() <span class="sc">+</span></span>
<span id="cb31-929"><a href="#cb31-929" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb31-930"><a href="#cb31-930" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb31-931"><a href="#cb31-931" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>),</span>
<span id="cb31-932"><a href="#cb31-932" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb31-933"><a href="#cb31-933" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-934"><a href="#cb31-934" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">1500</span>, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="st">"Higher Weekday Usage →"</span>, <span class="at">color =</span> primary_color, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb31-935"><a href="#cb31-935" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="sc">-</span><span class="dv">600</span>, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="st">"← Higher Weekend Usage"</span>, <span class="at">color =</span> secondary_color, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="fl">3.5</span>)</span>
<span id="cb31-936"><a href="#cb31-936" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-937"><a href="#cb31-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-938"><a href="#cb31-938" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-939"><a href="#cb31-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-940"><a href="#cb31-940" aria-hidden="true" tabindex="-1"></a><span class="fu"># Weekdays vs Weekends - Stations Overall</span></span>
<span id="cb31-941"><a href="#cb31-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-942"><a href="#cb31-942" aria-hidden="true" tabindex="-1"></a>Which stations and routes show the most consistent ridership patterns between weekdays and weekends? This analysis identifies stations and station pairs that vary the least and most between weekday and weekend usage.</span>
<span id="cb31-943"><a href="#cb31-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-944"><a href="#cb31-944" aria-hidden="true" tabindex="-1"></a><span class="in">```{r station-variation-analysis}</span></span>
<span id="cb31-945"><a href="#cb31-945" aria-hidden="true" tabindex="-1"></a><span class="co"># Get number of weekdays and weekends in the dataset</span></span>
<span id="cb31-946"><a href="#cb31-946" aria-hidden="true" tabindex="-1"></a>num_weekdays <span class="ot">&lt;-</span> <span class="fu">n_distinct</span>(hourly<span class="sc">$</span>Date[hourly<span class="sc">$</span>day_type <span class="sc">==</span> <span class="st">"Weekday"</span>])</span>
<span id="cb31-947"><a href="#cb31-947" aria-hidden="true" tabindex="-1"></a>num_weekends <span class="ot">&lt;-</span> <span class="fu">n_distinct</span>(hourly<span class="sc">$</span>Date[hourly<span class="sc">$</span>day_type <span class="sc">==</span> <span class="st">"Weekend"</span>])</span>
<span id="cb31-948"><a href="#cb31-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-949"><a href="#cb31-949" aria-hidden="true" tabindex="-1"></a><span class="co"># Station-level weekday vs weekend variation analysis</span></span>
<span id="cb31-950"><a href="#cb31-950" aria-hidden="true" tabindex="-1"></a>station_variation <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-951"><a href="#cb31-951" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Station, Line, day_type) <span class="sc">%&gt;%</span></span>
<span id="cb31-952"><a href="#cb31-952" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-953"><a href="#cb31-953" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-954"><a href="#cb31-954" aria-hidden="true" tabindex="-1"></a>    <span class="at">days =</span> <span class="fu">if_else</span>(day_type <span class="sc">==</span> <span class="st">"Weekday"</span>, num_weekdays, num_weekends),</span>
<span id="cb31-955"><a href="#cb31-955" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_per_day =</span> total_ridership <span class="sc">/</span> days</span>
<span id="cb31-956"><a href="#cb31-956" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-957"><a href="#cb31-957" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, Line, day_type, avg_per_day) <span class="sc">%&gt;%</span></span>
<span id="cb31-958"><a href="#cb31-958" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> day_type, <span class="at">values_from =</span> avg_per_day, <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb31-959"><a href="#cb31-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-960"><a href="#cb31-960" aria-hidden="true" tabindex="-1"></a><span class="co"># Station pair-level (bidirectional) weekday vs weekend variation</span></span>
<span id="cb31-961"><a href="#cb31-961" aria-hidden="true" tabindex="-1"></a>station_pair_variation <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-962"><a href="#cb31-962" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(From_Station <span class="sc">!=</span> To_Station) <span class="sc">%&gt;%</span></span>
<span id="cb31-963"><a href="#cb31-963" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-964"><a href="#cb31-964" aria-hidden="true" tabindex="-1"></a>    <span class="at">station_pair =</span> <span class="fu">ifelse</span>(From_Station <span class="sc">&lt;</span> To_Station,</span>
<span id="cb31-965"><a href="#cb31-965" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">paste</span>(From_Station, <span class="st">"↔"</span>, To_Station),</span>
<span id="cb31-966"><a href="#cb31-966" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">paste</span>(To_Station, <span class="st">"↔"</span>, From_Station)),</span>
<span id="cb31-967"><a href="#cb31-967" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure consistent ordering for bidirectional pairs</span></span>
<span id="cb31-968"><a href="#cb31-968" aria-hidden="true" tabindex="-1"></a>    <span class="at">station_1 =</span> <span class="fu">ifelse</span>(From_Station <span class="sc">&lt;</span> To_Station, From_Station, To_Station),</span>
<span id="cb31-969"><a href="#cb31-969" aria-hidden="true" tabindex="-1"></a>    <span class="at">station_2 =</span> <span class="fu">ifelse</span>(From_Station <span class="sc">&lt;</span> To_Station, To_Station, From_Station)</span>
<span id="cb31-970"><a href="#cb31-970" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-971"><a href="#cb31-971" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(station_1, station_2, station_pair, day_type) <span class="sc">%&gt;%</span></span>
<span id="cb31-972"><a href="#cb31-972" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_ridership =</span> <span class="fu">sum</span>(Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-973"><a href="#cb31-973" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-974"><a href="#cb31-974" aria-hidden="true" tabindex="-1"></a>    <span class="at">days =</span> <span class="fu">if_else</span>(day_type <span class="sc">==</span> <span class="st">"Weekday"</span>, num_weekdays, num_weekends),</span>
<span id="cb31-975"><a href="#cb31-975" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_per_day =</span> total_ridership <span class="sc">/</span> days</span>
<span id="cb31-976"><a href="#cb31-976" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-977"><a href="#cb31-977" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(station_1, station_2, station_pair, day_type, avg_per_day) <span class="sc">%&gt;%</span></span>
<span id="cb31-978"><a href="#cb31-978" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> day_type, <span class="at">values_from =</span> avg_per_day, <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb31-979"><a href="#cb31-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-980"><a href="#cb31-980" aria-hidden="true" tabindex="-1"></a><span class="co"># Export station-level analysis</span></span>
<span id="cb31-981"><a href="#cb31-981" aria-hidden="true" tabindex="-1"></a>variation_export <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">stations =</span> <span class="fu">convert_to_short_names</span>(station_variation))</span>
<span id="cb31-982"><a href="#cb31-982" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(variation_export, <span class="st">"../src/lib/data/charts/09-station-variation-analysis.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-983"><a href="#cb31-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-984"><a href="#cb31-984" aria-hidden="true" tabindex="-1"></a><span class="co"># Display tables for top variations</span></span>
<span id="cb31-985"><a href="#cb31-985" aria-hidden="true" tabindex="-1"></a>station_variation <span class="sc">%&gt;%</span></span>
<span id="cb31-986"><a href="#cb31-986" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Difference</span><span class="st">`</span> <span class="ot">=</span> Weekday <span class="sc">-</span> Weekend) <span class="sc">%&gt;%</span></span>
<span id="cb31-987"><a href="#cb31-987" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, Weekday, Weekend, <span class="st">`</span><span class="at">Difference</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-988"><a href="#cb31-988" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(<span class="st">`</span><span class="at">Difference</span><span class="st">`</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb31-989"><a href="#cb31-989" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-990"><a href="#cb31-990" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Top 15 Stations by Weekday-Weekend Ridership Difference"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-991"><a href="#cb31-991" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb31-992"><a href="#cb31-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-993"><a href="#cb31-993" aria-hidden="true" tabindex="-1"></a>station_pair_variation <span class="sc">%&gt;%</span></span>
<span id="cb31-994"><a href="#cb31-994" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Weekday <span class="sc">+</span> Weekend <span class="sc">&gt;</span> <span class="dv">50</span>) <span class="sc">%&gt;%</span> <span class="co"># Exclude low-ridership pairs</span></span>
<span id="cb31-995"><a href="#cb31-995" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Difference</span><span class="st">`</span> <span class="ot">=</span> Weekday <span class="sc">-</span> Weekend) <span class="sc">%&gt;%</span></span>
<span id="cb31-996"><a href="#cb31-996" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">`</span><span class="at">Station Pair</span><span class="st">`</span> <span class="ot">=</span> station_pair, Weekday, Weekend, <span class="st">`</span><span class="at">Difference</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-997"><a href="#cb31-997" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(<span class="st">`</span><span class="at">Difference</span><span class="st">`</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb31-998"><a href="#cb31-998" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-999"><a href="#cb31-999" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Top 15 Station Pairs by Weekday-Weekend Ridership Difference"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1000"><a href="#cb31-1000" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb31-1001"><a href="#cb31-1001" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1002"><a href="#cb31-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1003"><a href="#cb31-1003" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-1004"><a href="#cb31-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1005"><a href="#cb31-1005" aria-hidden="true" tabindex="-1"></a><span class="fu"># Average Travel Distance</span></span>
<span id="cb31-1006"><a href="#cb31-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1007"><a href="#cb31-1007" aria-hidden="true" tabindex="-1"></a>Analyzing the average number of stations travelled by commuters at each station. Commuters from city periphery stations travel longer distances on average (and spend more on metro), compared to city center stations.</span>
<span id="cb31-1008"><a href="#cb31-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1009"><a href="#cb31-1009" aria-hidden="true" tabindex="-1"></a><span class="in">```{r average-travel-distance}</span></span>
<span id="cb31-1010"><a href="#cb31-1010" aria-hidden="true" tabindex="-1"></a><span class="co"># Define station orders for distance calculation</span></span>
<span id="cb31-1011"><a href="#cb31-1011" aria-hidden="true" tabindex="-1"></a>purple_line_stations <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Whitefield (Kadugodi)"</span>, <span class="st">"Hopefarm Channasandra"</span>, <span class="st">"Kadugodi Tree Park"</span>, <span class="st">"Pattandur Agrahara"</span>, <span class="st">"Sri Sathya Sai Hospital"</span>, <span class="st">"Nallurahalli"</span>, <span class="st">"Kundalahalli"</span>, <span class="st">"Seetharampalya"</span>, <span class="st">"Hoodi"</span>, <span class="st">"Garudacharpalya"</span>, <span class="st">"Singayyanapalya"</span>, <span class="st">"Krishnarajapura"</span>, <span class="st">"Benniganahalli"</span>, <span class="st">"Baiyappanahalli"</span>, <span class="st">"Swami Vivekananda Road"</span>, <span class="st">"Indiranagar"</span>, <span class="st">"Halasuru"</span>, <span class="st">"Trinity"</span>, <span class="st">"Mahatma Gandhi Road"</span>, <span class="st">"Cubbon Park"</span>, <span class="st">"Dr. B. R. Ambedkar Station, Vidhana Soudha"</span>, <span class="st">"Sir M. Visvesvaraya Stn., Central College"</span>, <span class="st">"Nadaprabhu Kempegowda Station, Majestic"</span>, <span class="st">"Krantivira Sangolli Rayanna Railway Station"</span>, <span class="st">"Magadi Road"</span>, <span class="st">"Sri Balagangadharanatha Swamiji Station, Hosahalli"</span>, <span class="st">"Vijayanagar"</span>, <span class="st">"Attiguppe"</span>, <span class="st">"Deepanjali Nagar"</span>, <span class="st">"Mysore Road"</span>, <span class="st">"Pantharapalya - Nayandahalli"</span>, <span class="st">"Rajarajeshwari Nagar"</span>, <span class="st">"Jnanabharathi"</span>, <span class="st">"Pattanagere"</span>, <span class="st">"Kengeri Bus Terminal"</span>, <span class="st">"Kengeri"</span>, <span class="st">"Challaghatta"</span>)</span>
<span id="cb31-1012"><a href="#cb31-1012" aria-hidden="true" tabindex="-1"></a>green_line_stations <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Silk Institute"</span>, <span class="st">"Thalaghattapura"</span>, <span class="st">"Vajarahalli"</span>, <span class="st">"Doddakallasandra"</span>, <span class="st">"Konanakunte Cross"</span>, <span class="st">"Yelachenahalli"</span>, <span class="st">"Jaya Prakash Nagar"</span>, <span class="st">"Banashankari"</span>, <span class="st">"Rashtreeya Vidyalaya Road"</span>, <span class="st">"Jayanagar"</span>, <span class="st">"South End Circle"</span>, <span class="st">"Lalbagh"</span>, <span class="st">"National College"</span>, <span class="st">"Krishna Rajendra Market"</span>, <span class="st">"Chickpete"</span>, <span class="st">"Nadaprabhu Kempegowda Station, Majestic"</span>, <span class="st">"Mantri Square Sampige Road"</span>, <span class="st">"Srirampura"</span>, <span class="st">"Mahakavi Kuvempu Road"</span>, <span class="st">"Rajajinagar"</span>, <span class="st">"Mahalakshmi"</span>, <span class="st">"Sandal Soap Factory"</span>, <span class="st">"Yeshwantpur"</span>, <span class="st">"Goraguntepalya"</span>, <span class="st">"Peenya"</span>, <span class="st">"Peenya Industry"</span>, <span class="st">"Jalahalli"</span>, <span class="st">"Dasarahalli"</span>, <span class="st">"Nagasandra"</span>, <span class="st">"Manjunathanagara"</span>, <span class="st">"Chikkabidarakallu"</span>, <span class="st">"Madavara"</span>)</span>
<span id="cb31-1013"><a href="#cb31-1013" aria-hidden="true" tabindex="-1"></a>yellow_line_stations <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Rashtreeya Vidyalaya Road"</span>, <span class="st">"Ragigudda"</span>, <span class="st">"Jayadeva Hospital"</span>, <span class="st">"BTM Layout"</span>, <span class="st">"Central Silk Board"</span>, <span class="st">"Bommanahalli"</span>, <span class="st">"Hongasandra"</span>, <span class="st">"Kudlu Gate"</span>, <span class="st">"Singasandra"</span>, <span class="st">"Hosa Road"</span>, <span class="st">"Beratena Agrahara"</span>, <span class="st">"Electronic City"</span>, <span class="st">"Infosys Foundation Konappana Agrahara"</span>, <span class="st">"Huskur Road"</span>, <span class="st">"Biocon Hebbagodi"</span>, <span class="st">"Delta Electronics Bommasandra"</span>)</span>
<span id="cb31-1014"><a href="#cb31-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1015"><a href="#cb31-1015" aria-hidden="true" tabindex="-1"></a>station_positions <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-1016"><a href="#cb31-1016" aria-hidden="true" tabindex="-1"></a>  <span class="at">Purple =</span> <span class="fu">setNames</span>(<span class="fu">seq_along</span>(purple_line_stations), purple_line_stations),</span>
<span id="cb31-1017"><a href="#cb31-1017" aria-hidden="true" tabindex="-1"></a>  <span class="at">Green =</span> <span class="fu">setNames</span>(<span class="fu">seq_along</span>(green_line_stations), green_line_stations),</span>
<span id="cb31-1018"><a href="#cb31-1018" aria-hidden="true" tabindex="-1"></a>  <span class="at">Yellow =</span> <span class="fu">setNames</span>(<span class="fu">seq_along</span>(yellow_line_stations), yellow_line_stations)</span>
<span id="cb31-1019"><a href="#cb31-1019" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1020"><a href="#cb31-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1021"><a href="#cb31-1021" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate stations travelled (shortest path on the network)</span></span>
<span id="cb31-1022"><a href="#cb31-1022" aria-hidden="true" tabindex="-1"></a>calculate_stations_travelled <span class="ot">&lt;-</span> <span class="cf">function</span>(origin, destination, origin_line, dest_line) {</span>
<span id="cb31-1023"><a href="#cb31-1023" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle same station case</span></span>
<span id="cb31-1024"><a href="#cb31-1024" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (origin <span class="sc">==</span> destination) {</span>
<span id="cb31-1025"><a href="#cb31-1025" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb31-1026"><a href="#cb31-1026" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-1027"><a href="#cb31-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1028"><a href="#cb31-1028" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define interchange stations</span></span>
<span id="cb31-1029"><a href="#cb31-1029" aria-hidden="true" tabindex="-1"></a>  majestic <span class="ot">&lt;-</span> <span class="st">"Nadaprabhu Kempegowda Station, Majestic"</span></span>
<span id="cb31-1030"><a href="#cb31-1030" aria-hidden="true" tabindex="-1"></a>  rvr <span class="ot">&lt;-</span> <span class="st">"Rashtreeya Vidyalaya Road"</span></span>
<span id="cb31-1031"><a href="#cb31-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1032"><a href="#cb31-1032" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Map Black line stations to their physical lines for distance calculation</span></span>
<span id="cb31-1033"><a href="#cb31-1033" aria-hidden="true" tabindex="-1"></a>  map_physical_line <span class="ot">&lt;-</span> <span class="cf">function</span>(station, line) {</span>
<span id="cb31-1034"><a href="#cb31-1034" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (line <span class="sc">==</span> <span class="st">"Black"</span>) {</span>
<span id="cb31-1035"><a href="#cb31-1035" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (station <span class="sc">==</span> majestic) <span class="fu">return</span>(<span class="st">"Purple"</span>)</span>
<span id="cb31-1036"><a href="#cb31-1036" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (station <span class="sc">==</span> rvr) <span class="fu">return</span>(<span class="st">"Green"</span>)</span>
<span id="cb31-1037"><a href="#cb31-1037" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-1038"><a href="#cb31-1038" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(line)</span>
<span id="cb31-1039"><a href="#cb31-1039" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-1040"><a href="#cb31-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1041"><a href="#cb31-1041" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Map lines to physical lines</span></span>
<span id="cb31-1042"><a href="#cb31-1042" aria-hidden="true" tabindex="-1"></a>  origin_physical_line <span class="ot">&lt;-</span> <span class="fu">map_physical_line</span>(origin, origin_line)</span>
<span id="cb31-1043"><a href="#cb31-1043" aria-hidden="true" tabindex="-1"></a>  dest_physical_line <span class="ot">&lt;-</span> <span class="fu">map_physical_line</span>(destination, dest_line)</span>
<span id="cb31-1044"><a href="#cb31-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1045"><a href="#cb31-1045" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Same line travel (using physical lines)</span></span>
<span id="cb31-1046"><a href="#cb31-1046" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> dest_physical_line) {</span>
<span id="cb31-1047"><a href="#cb31-1047" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Purple"</span>) {</span>
<span id="cb31-1048"><a href="#cb31-1048" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">abs</span>(station_positions<span class="sc">$</span>Purple[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Purple[origin]))</span>
<span id="cb31-1049"><a href="#cb31-1049" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Green"</span>) {</span>
<span id="cb31-1050"><a href="#cb31-1050" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[origin]))</span>
<span id="cb31-1051"><a href="#cb31-1051" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Yellow"</span>) {</span>
<span id="cb31-1052"><a href="#cb31-1052" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">abs</span>(station_positions<span class="sc">$</span>Yellow[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Yellow[origin]))</span>
<span id="cb31-1053"><a href="#cb31-1053" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-1054"><a href="#cb31-1054" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-1055"><a href="#cb31-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1056"><a href="#cb31-1056" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cross-line travel - need to find optimal interchange</span></span>
<span id="cb31-1057"><a href="#cb31-1057" aria-hidden="true" tabindex="-1"></a>  min_distance <span class="ot">&lt;-</span> <span class="cn">Inf</span></span>
<span id="cb31-1058"><a href="#cb31-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1059"><a href="#cb31-1059" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try Majestic interchange (Purple-Green)</span></span>
<span id="cb31-1060"><a href="#cb31-1060" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((origin_physical_line <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Purple"</span>, <span class="st">"Green"</span>)) <span class="sc">&amp;&amp;</span> (dest_physical_line <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Purple"</span>, <span class="st">"Green"</span>))) {</span>
<span id="cb31-1061"><a href="#cb31-1061" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Purple"</span>) {</span>
<span id="cb31-1062"><a href="#cb31-1062" aria-hidden="true" tabindex="-1"></a>      dist_to_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Purple[majestic] <span class="sc">-</span> station_positions<span class="sc">$</span>Purple[origin])</span>
<span id="cb31-1063"><a href="#cb31-1063" aria-hidden="true" tabindex="-1"></a>      dist_from_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[majestic])</span>
<span id="cb31-1064"><a href="#cb31-1064" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb31-1065"><a href="#cb31-1065" aria-hidden="true" tabindex="-1"></a>      dist_to_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[majestic] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[origin])</span>
<span id="cb31-1066"><a href="#cb31-1066" aria-hidden="true" tabindex="-1"></a>      dist_from_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Purple[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Purple[majestic])</span>
<span id="cb31-1067"><a href="#cb31-1067" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-1068"><a href="#cb31-1068" aria-hidden="true" tabindex="-1"></a>    min_distance <span class="ot">&lt;-</span> <span class="fu">min</span>(min_distance, dist_to_majestic <span class="sc">+</span> dist_from_majestic)</span>
<span id="cb31-1069"><a href="#cb31-1069" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-1070"><a href="#cb31-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1071"><a href="#cb31-1071" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Try RVR interchange (Green-Yellow)</span></span>
<span id="cb31-1072"><a href="#cb31-1072" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((origin_physical_line <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Green"</span>, <span class="st">"Yellow"</span>)) <span class="sc">&amp;&amp;</span> (dest_physical_line <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Green"</span>, <span class="st">"Yellow"</span>))) {</span>
<span id="cb31-1073"><a href="#cb31-1073" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Green"</span>) {</span>
<span id="cb31-1074"><a href="#cb31-1074" aria-hidden="true" tabindex="-1"></a>      dist_to_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[rvr] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[origin])</span>
<span id="cb31-1075"><a href="#cb31-1075" aria-hidden="true" tabindex="-1"></a>      dist_from_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Yellow[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Yellow[rvr])</span>
<span id="cb31-1076"><a href="#cb31-1076" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb31-1077"><a href="#cb31-1077" aria-hidden="true" tabindex="-1"></a>      dist_to_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Yellow[rvr] <span class="sc">-</span> station_positions<span class="sc">$</span>Yellow[origin])</span>
<span id="cb31-1078"><a href="#cb31-1078" aria-hidden="true" tabindex="-1"></a>      dist_from_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[rvr])</span>
<span id="cb31-1079"><a href="#cb31-1079" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-1080"><a href="#cb31-1080" aria-hidden="true" tabindex="-1"></a>    min_distance <span class="ot">&lt;-</span> <span class="fu">min</span>(min_distance, dist_to_rvr <span class="sc">+</span> dist_from_rvr)</span>
<span id="cb31-1081"><a href="#cb31-1081" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-1082"><a href="#cb31-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1083"><a href="#cb31-1083" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Purple to Yellow via Majestic + RVR</span></span>
<span id="cb31-1084"><a href="#cb31-1084" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ((origin_physical_line <span class="sc">==</span> <span class="st">"Purple"</span> <span class="sc">&amp;&amp;</span> dest_physical_line <span class="sc">==</span> <span class="st">"Yellow"</span>) <span class="sc">||</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Yellow"</span> <span class="sc">&amp;&amp;</span> dest_physical_line <span class="sc">==</span> <span class="st">"Purple"</span>)) {</span>
<span id="cb31-1085"><a href="#cb31-1085" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (origin_physical_line <span class="sc">==</span> <span class="st">"Purple"</span>) {</span>
<span id="cb31-1086"><a href="#cb31-1086" aria-hidden="true" tabindex="-1"></a>      dist_to_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Purple[majestic] <span class="sc">-</span> station_positions<span class="sc">$</span>Purple[origin])</span>
<span id="cb31-1087"><a href="#cb31-1087" aria-hidden="true" tabindex="-1"></a>      dist_majestic_to_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[rvr] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[majestic])</span>
<span id="cb31-1088"><a href="#cb31-1088" aria-hidden="true" tabindex="-1"></a>      dist_from_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Yellow[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Yellow[rvr])</span>
<span id="cb31-1089"><a href="#cb31-1089" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb31-1090"><a href="#cb31-1090" aria-hidden="true" tabindex="-1"></a>      dist_to_rvr <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Yellow[rvr] <span class="sc">-</span> station_positions<span class="sc">$</span>Yellow[origin])</span>
<span id="cb31-1091"><a href="#cb31-1091" aria-hidden="true" tabindex="-1"></a>      dist_rvr_to_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Green[majestic] <span class="sc">-</span> station_positions<span class="sc">$</span>Green[rvr])</span>
<span id="cb31-1092"><a href="#cb31-1092" aria-hidden="true" tabindex="-1"></a>      dist_from_majestic <span class="ot">&lt;-</span> <span class="fu">abs</span>(station_positions<span class="sc">$</span>Purple[destination] <span class="sc">-</span> station_positions<span class="sc">$</span>Purple[majestic])</span>
<span id="cb31-1093"><a href="#cb31-1093" aria-hidden="true" tabindex="-1"></a>      dist_to_majestic <span class="ot">&lt;-</span> dist_to_rvr <span class="sc">+</span> dist_rvr_to_majestic</span>
<span id="cb31-1094"><a href="#cb31-1094" aria-hidden="true" tabindex="-1"></a>      dist_majestic_to_rvr <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb31-1095"><a href="#cb31-1095" aria-hidden="true" tabindex="-1"></a>      dist_from_rvr <span class="ot">&lt;-</span> dist_from_majestic</span>
<span id="cb31-1096"><a href="#cb31-1096" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-1097"><a href="#cb31-1097" aria-hidden="true" tabindex="-1"></a>    min_distance <span class="ot">&lt;-</span> <span class="fu">min</span>(min_distance, dist_to_majestic <span class="sc">+</span> dist_majestic_to_rvr <span class="sc">+</span> dist_from_rvr)</span>
<span id="cb31-1098"><a href="#cb31-1098" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-1099"><a href="#cb31-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1100"><a href="#cb31-1100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(min_distance)</span>
<span id="cb31-1101"><a href="#cb31-1101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-1102"><a href="#cb31-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1103"><a href="#cb31-1103" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate weighted average travel distance for each station</span></span>
<span id="cb31-1104"><a href="#cb31-1104" aria-hidden="true" tabindex="-1"></a>station_travel_analysis <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-1105"><a href="#cb31-1105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">distinct</span>(hourly, Station, Line), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"From_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1106"><a href="#cb31-1106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Origin_Line =</span> Line) <span class="sc">%&gt;%</span></span>
<span id="cb31-1107"><a href="#cb31-1107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">distinct</span>(hourly, Station, Line), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"To_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1108"><a href="#cb31-1108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Dest_Line =</span> Line) <span class="sc">%&gt;%</span></span>
<span id="cb31-1109"><a href="#cb31-1109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Origin_Line), <span class="sc">!</span><span class="fu">is.na</span>(Dest_Line)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1110"><a href="#cb31-1110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-1111"><a href="#cb31-1111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stations_travelled =</span> <span class="fu">calculate_stations_travelled</span>(From_Station, To_Station, Origin_Line, Dest_Line)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1112"><a href="#cb31-1112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-1113"><a href="#cb31-1113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb31-1114"><a href="#cb31-1114" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_stations_travelled =</span> <span class="fu">weighted.mean</span>(stations_travelled, Ridership, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb31-1115"><a href="#cb31-1115" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(From_Station, Origin_Line)</span>
<span id="cb31-1116"><a href="#cb31-1116" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-1117"><a href="#cb31-1117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(avg_stations_travelled <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1118"><a href="#cb31-1118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(avg_stations_travelled))</span>
<span id="cb31-1119"><a href="#cb31-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1120"><a href="#cb31-1120" aria-hidden="true" tabindex="-1"></a><span class="co"># Export data for web interface</span></span>
<span id="cb31-1121"><a href="#cb31-1121" aria-hidden="true" tabindex="-1"></a>travel_distance_export <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">station_averages =</span> <span class="fu">convert_to_short_names</span>(station_travel_analysis))</span>
<span id="cb31-1122"><a href="#cb31-1122" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(travel_distance_export, <span class="st">"../src/lib/data/charts/11-average-travel-distance.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-1123"><a href="#cb31-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1124"><a href="#cb31-1124" aria-hidden="true" tabindex="-1"></a>travel_time_selected <span class="ot">&lt;-</span> travel_distance_export<span class="sc">$</span>station_averages <span class="sc">%&gt;%</span></span>
<span id="cb31-1125"><a href="#cb31-1125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(From_Station <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Madavara"</span>, <span class="st">"Halasuru"</span>))</span>
<span id="cb31-1126"><a href="#cb31-1126" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(<span class="fu">list</span>(<span class="at">station_averages =</span> travel_time_selected), <span class="st">"../src/lib/data/charts/11-travel-time-selected.json"</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>, <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-1127"><a href="#cb31-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1128"><a href="#cb31-1128" aria-hidden="true" tabindex="-1"></a>travel_distance_export<span class="sc">$</span>station_averages <span class="sc">%&gt;%</span></span>
<span id="cb31-1129"><a href="#cb31-1129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">Station =</span> From_Station, <span class="at">Line =</span> Origin_Line, <span class="st">`</span><span class="at">Trip Length (stations)</span><span class="st">`</span> <span class="ot">=</span> avg_stations_travelled) <span class="sc">%&gt;%</span></span>
<span id="cb31-1130"><a href="#cb31-1130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Average Trip Length by Origin Station"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1131"><a href="#cb31-1131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span>
<span id="cb31-1132"><a href="#cb31-1132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1133"><a href="#cb31-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1134"><a href="#cb31-1134" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-1135"><a href="#cb31-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1136"><a href="#cb31-1136" aria-hidden="true" tabindex="-1"></a><span class="fu"># Land use</span></span>
<span id="cb31-1137"><a href="#cb31-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1138"><a href="#cb31-1138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r landuse}</span></span>
<span id="cb31-1139"><a href="#cb31-1139" aria-hidden="true" tabindex="-1"></a>input_raster_path <span class="ot">&lt;-</span> <span class="st">"built-up-volume/built-up-volume.tif"</span></span>
<span id="cb31-1140"><a href="#cb31-1140" aria-hidden="true" tabindex="-1"></a>output_geojson_path <span class="ot">&lt;-</span> <span class="st">"../src/lib/data/charts/12-built_up_volume_hex.json"</span></span>
<span id="cb31-1141"><a href="#cb31-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1142"><a href="#cb31-1142" aria-hidden="true" tabindex="-1"></a><span class="co"># Load raster, set 0 to NA, and create a hex grid</span></span>
<span id="cb31-1143"><a href="#cb31-1143" aria-hidden="true" tabindex="-1"></a>commercial_built_volume <span class="ot">&lt;-</span> <span class="fu">rast</span>(input_raster_path)</span>
<span id="cb31-1144"><a href="#cb31-1144" aria-hidden="true" tabindex="-1"></a>commercial_built_volume[commercial_built_volume <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb31-1145"><a href="#cb31-1145" aria-hidden="true" tabindex="-1"></a>hex_grid <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(commercial_built_volume, <span class="at">cellsize =</span> <span class="fl">0.009</span>, <span class="at">square =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>()</span>
<span id="cb31-1146"><a href="#cb31-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1147"><a href="#cb31-1147" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract mean raster values for each hex cell</span></span>
<span id="cb31-1148"><a href="#cb31-1148" aria-hidden="true" tabindex="-1"></a>hex_grid<span class="sc">$</span>mean_volume <span class="ot">&lt;-</span> <span class="fu">exact_extract</span>(commercial_built_volume, hex_grid, <span class="at">fun =</span> <span class="st">"mean"</span>)</span>
<span id="cb31-1149"><a href="#cb31-1149" aria-hidden="true" tabindex="-1"></a>hex_summary_filtered <span class="ot">&lt;-</span> hex_grid[<span class="sc">!</span><span class="fu">is.na</span>(hex_grid<span class="sc">$</span>mean_volume), ]</span>
<span id="cb31-1150"><a href="#cb31-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1151"><a href="#cb31-1151" aria-hidden="true" tabindex="-1"></a><span class="co"># Write to GeoJSON</span></span>
<span id="cb31-1152"><a href="#cb31-1152" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(hex_summary_filtered, output_geojson_path, <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>, <span class="at">driver =</span> <span class="st">"GeoJSON"</span>)</span>
<span id="cb31-1153"><a href="#cb31-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1154"><a href="#cb31-1154" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a quick visualization</span></span>
<span id="cb31-1155"><a href="#cb31-1155" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">pretty</span>(hex_summary_filtered<span class="sc">$</span>mean_volume, <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb31-1156"><a href="#cb31-1156" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">hcl.colors</span>(<span class="fu">length</span>(breaks) <span class="sc">-</span> <span class="dv">1</span>, <span class="st">"viridis"</span>, <span class="at">rev =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-1157"><a href="#cb31-1157" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hex_summary_filtered[<span class="st">"mean_volume"</span>], <span class="at">main =</span> <span class="st">"Built-up Volume Aggregated into Hexagons"</span>,</span>
<span id="cb31-1158"><a href="#cb31-1158" aria-hidden="true" tabindex="-1"></a>     <span class="at">breaks =</span> breaks, <span class="at">pal =</span> pal, <span class="at">key.pos =</span> <span class="dv">4</span>, <span class="at">lwd =</span> <span class="fl">0.1</span>, <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="cb31-1159"><a href="#cb31-1159" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1160"><a href="#cb31-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1161"><a href="#cb31-1161" aria-hidden="true" tabindex="-1"></a>-----</span>
<span id="cb31-1162"><a href="#cb31-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1163"><a href="#cb31-1163" aria-hidden="true" tabindex="-1"></a><span class="fu"># Network Analysis</span></span>
<span id="cb31-1164"><a href="#cb31-1164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1165"><a href="#cb31-1165" aria-hidden="true" tabindex="-1"></a><span class="in">```{r network-analysis}</span></span>
<span id="cb31-1166"><a href="#cb31-1166" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Network Analysis (Corrected Final Version) ---</span></span>
<span id="cb31-1167"><a href="#cb31-1167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1168"><a href="#cb31-1168" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Calculate Station Importance (using short names)</span></span>
<span id="cb31-1169"><a href="#cb31-1169" aria-hidden="true" tabindex="-1"></a>station_importance <span class="ot">&lt;-</span> hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-1170"><a href="#cb31-1170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">convert_to_short_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-1171"><a href="#cb31-1171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(Station, <span class="at">wt =</span> Ridership, <span class="at">name =</span> <span class="st">"total_ridership"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1172"><a href="#cb31-1172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">id =</span> Station)</span>
<span id="cb31-1173"><a href="#cb31-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1174"><a href="#cb31-1174" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Calculate Hybrid Top Links using consistent short names</span></span>
<span id="cb31-1175"><a href="#cb31-1175" aria-hidden="true" tabindex="-1"></a><span class="co"># The `metro_stations` table from your data prep chunk already has short names and line info</span></span>
<span id="cb31-1176"><a href="#cb31-1176" aria-hidden="true" tabindex="-1"></a>line_info <span class="ot">&lt;-</span> metro_stations <span class="sc">%&gt;%</span></span>
<span id="cb31-1177"><a href="#cb31-1177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Station, line)</span>
<span id="cb31-1178"><a href="#cb31-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1179"><a href="#cb31-1179" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a base table of all links, converting to short names immediately</span></span>
<span id="cb31-1180"><a href="#cb31-1180" aria-hidden="true" tabindex="-1"></a>all_links_with_lines <span class="ot">&lt;-</span> station_pair_hourly <span class="sc">%&gt;%</span></span>
<span id="cb31-1181"><a href="#cb31-1181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(From_Station, To_Station, <span class="at">wt =</span> Ridership, <span class="at">name =</span> <span class="st">"Ridership"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1182"><a href="#cb31-1182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">convert_to_short_names</span>() <span class="sc">%&gt;%</span> <span class="co"># This ensures all names are short and consistent</span></span>
<span id="cb31-1183"><a href="#cb31-1183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_log_odds</span>(<span class="at">set =</span> From_Station, <span class="at">feature =</span> To_Station, <span class="at">n =</span> Ridership) <span class="sc">%&gt;%</span></span>
<span id="cb31-1184"><a href="#cb31-1184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(line_info, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"From_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1185"><a href="#cb31-1185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">from_line =</span> line) <span class="sc">%&gt;%</span></span>
<span id="cb31-1186"><a href="#cb31-1186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(line_info, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"To_Station"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1187"><a href="#cb31-1187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">to_line =</span> line) <span class="sc">%&gt;%</span></span>
<span id="cb31-1188"><a href="#cb31-1188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(from_line), <span class="sc">!</span><span class="fu">is.na</span>(to_line)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1189"><a href="#cb31-1189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_interline =</span> (from_line <span class="sc">!=</span> to_line))</span>
<span id="cb31-1190"><a href="#cb31-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1191"><a href="#cb31-1191" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the hybrid set of top links</span></span>
<span id="cb31-1192"><a href="#cb31-1192" aria-hidden="true" tabindex="-1"></a>top_links <span class="ot">&lt;-</span></span>
<span id="cb31-1193"><a href="#cb31-1193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb31-1194"><a href="#cb31-1194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Top 8 intra-line (same-line) links</span></span>
<span id="cb31-1195"><a href="#cb31-1195" aria-hidden="true" tabindex="-1"></a>    all_links_with_lines <span class="sc">%&gt;%</span></span>
<span id="cb31-1196"><a href="#cb31-1196" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span>is_interline, Ridership <span class="sc">&gt;</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1197"><a href="#cb31-1197" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(From_Station) <span class="sc">%&gt;%</span></span>
<span id="cb31-1198"><a href="#cb31-1198" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_max</span>(<span class="at">order_by =</span> log_odds_weighted, <span class="at">n =</span> <span class="dv">8</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>),</span>
<span id="cb31-1199"><a href="#cb31-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1200"><a href="#cb31-1200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Top 3 inter-line (cross-line) links</span></span>
<span id="cb31-1201"><a href="#cb31-1201" aria-hidden="true" tabindex="-1"></a>    all_links_with_lines <span class="sc">%&gt;%</span></span>
<span id="cb31-1202"><a href="#cb31-1202" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(is_interline, Ridership <span class="sc">&gt;</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1203"><a href="#cb31-1203" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(From_Station) <span class="sc">%&gt;%</span></span>
<span id="cb31-1204"><a href="#cb31-1204" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_max</span>(<span class="at">order_by =</span> log_odds_weighted, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>)</span>
<span id="cb31-1205"><a href="#cb31-1205" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-1206"><a href="#cb31-1206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-1207"><a href="#cb31-1207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(From_Station, To_Station, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-1208"><a href="#cb31-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1209"><a href="#cb31-1209" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Prepare Nodes and Links for D3 Export</span></span>
<span id="cb31-1210"><a href="#cb31-1210" aria-hidden="true" tabindex="-1"></a>links_for_graph <span class="ot">&lt;-</span> top_links <span class="sc">%&gt;%</span></span>
<span id="cb31-1211"><a href="#cb31-1211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(From_Station, To_Station, <span class="at">value =</span> log_odds_weighted)</span>
<span id="cb31-1212"><a href="#cb31-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1213"><a href="#cb31-1213" aria-hidden="true" tabindex="-1"></a>nodes_final <span class="ot">&lt;-</span> {</span>
<span id="cb31-1214"><a href="#cb31-1214" aria-hidden="true" tabindex="-1"></a>  base_nodes <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="fu">unique</span>(<span class="fu">c</span>(links_for_graph<span class="sc">$</span>From_Station, links_for_graph<span class="sc">$</span>To_Station))) <span class="sc">%&gt;%</span></span>
<span id="cb31-1215"><a href="#cb31-1215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(line_info, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span> <span class="ot">=</span> <span class="st">"Station"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1216"><a href="#cb31-1216" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, <span class="at">group =</span> line) <span class="sc">%&gt;%</span></span>
<span id="cb31-1217"><a href="#cb31-1217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">str_to_title</span>(<span class="fu">coalesce</span>(group, <span class="st">"Unknown"</span>)))</span>
<span id="cb31-1218"><a href="#cb31-1218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1219"><a href="#cb31-1219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_graph</span>(<span class="at">nodes =</span> base_nodes, <span class="at">edges =</span> links_for_graph, <span class="at">directed =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1220"><a href="#cb31-1220" aria-hidden="true" tabindex="-1"></a>    <span class="fu">activate</span>(nodes) <span class="sc">%&gt;%</span></span>
<span id="cb31-1221"><a href="#cb31-1221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">betweenness =</span> <span class="fu">centrality_betweenness</span>(<span class="at">weights =</span> value <span class="sc">-</span> <span class="fu">min</span>(value) <span class="sc">+</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1222"><a href="#cb31-1222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-1223"><a href="#cb31-1223" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(station_importance, <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1224"><a href="#cb31-1224" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">total_ridership =</span> <span class="fu">coalesce</span>(total_ridership, <span class="dv">0</span>L))</span>
<span id="cb31-1225"><a href="#cb31-1225" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-1226"><a href="#cb31-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1227"><a href="#cb31-1227" aria-hidden="true" tabindex="-1"></a>links_final_indexed <span class="ot">&lt;-</span> {</span>
<span id="cb31-1228"><a href="#cb31-1228" aria-hidden="true" tabindex="-1"></a>  station_indices <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(nodes_final)) <span class="sc">-</span> <span class="dv">1</span>, nodes_final<span class="sc">$</span>id)</span>
<span id="cb31-1229"><a href="#cb31-1229" aria-hidden="true" tabindex="-1"></a>  links_for_graph <span class="sc">%&gt;%</span></span>
<span id="cb31-1230"><a href="#cb31-1230" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb31-1231"><a href="#cb31-1231" aria-hidden="true" tabindex="-1"></a>      <span class="at">source =</span> station_indices[From_Station],</span>
<span id="cb31-1232"><a href="#cb31-1232" aria-hidden="true" tabindex="-1"></a>      <span class="at">target =</span> station_indices[To_Station]</span>
<span id="cb31-1233"><a href="#cb31-1233" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-1234"><a href="#cb31-1234" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(source), <span class="sc">!</span><span class="fu">is.na</span>(target)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1235"><a href="#cb31-1235" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(source, target, value) <span class="sc">%&gt;%</span></span>
<span id="cb31-1236"><a href="#cb31-1236" aria-hidden="true" tabindex="-1"></a>    purrr<span class="sc">::</span><span class="fu">pmap</span>(<span class="sc">~</span><span class="fu">c</span>(...)) <span class="sc">%&gt;%</span></span>
<span id="cb31-1237"><a href="#cb31-1237" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unname</span>()</span>
<span id="cb31-1238"><a href="#cb31-1238" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-1239"><a href="#cb31-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1240"><a href="#cb31-1240" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Export to JSON</span></span>
<span id="cb31-1241"><a href="#cb31-1241" aria-hidden="true" tabindex="-1"></a>d3_network_output <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-1242"><a href="#cb31-1242" aria-hidden="true" tabindex="-1"></a>  <span class="at">nodes =</span> nodes_final,</span>
<span id="cb31-1243"><a href="#cb31-1243" aria-hidden="true" tabindex="-1"></a>  <span class="at">links =</span> links_final_indexed</span>
<span id="cb31-1244"><a href="#cb31-1244" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1245"><a href="#cb31-1245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1246"><a href="#cb31-1246" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(</span>
<span id="cb31-1247"><a href="#cb31-1247" aria-hidden="true" tabindex="-1"></a>  d3_network_output,</span>
<span id="cb31-1248"><a href="#cb31-1248" aria-hidden="true" tabindex="-1"></a>  <span class="st">"../src/lib/data/charts/metro-network-final.json"</span>,</span>
<span id="cb31-1249"><a href="#cb31-1249" aria-hidden="true" tabindex="-1"></a>  <span class="at">pretty =</span> <span class="cn">FALSE</span>,</span>
<span id="cb31-1250"><a href="#cb31-1250" aria-hidden="true" tabindex="-1"></a>  <span class="at">auto_unbox =</span> <span class="cn">TRUE</span></span>
<span id="cb31-1251"><a href="#cb31-1251" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1252"><a href="#cb31-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1253"><a href="#cb31-1253" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(</span>
<span id="cb31-1254"><a href="#cb31-1254" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Successfully exported refined D3 network data.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb31-1255"><a href="#cb31-1255" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Exported"</span>, <span class="fu">nrow</span>(nodes_final), <span class="st">"stations and"</span>, <span class="fu">length</span>(links_final_indexed), <span class="st">"connections.</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb31-1256"><a href="#cb31-1256" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-1257"><a href="#cb31-1257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1258"><a href="#cb31-1258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>